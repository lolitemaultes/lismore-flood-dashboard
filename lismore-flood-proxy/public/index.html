<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lismore Flood Emergency Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        :root {
            --primary-color: #1e88e5;
            --primary-dark: #1565c0;
            --secondary-color: #f8f9fa;
            --danger-color: #e53935;
            --warning-color: #ffa000;
            --success-color: #43a047;
            --info-color: #039be5;
            --dark-color: #212121;
            --light-color: #f8f9fa;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --border-radius: 8px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .header-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }

        .clock-container {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius);
            display: inline-flex;
            align-items: center;
            font-weight: 500;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 1rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 992px) {
            .dashboard-container {
                grid-template-columns: 3fr 1fr;
            }
        }

        .webcam-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .webcam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .webcam-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        /* Improved Webcam Image Container Styling */
        .webcam-image-container {
            position: relative;
            width: 100%;
            padding: 1rem;
            text-align: center;
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
            margin: 0.5rem 0;
        }
        
        .webcam-image {
            max-width: 100%;
            height: auto;
            border-radius: calc(var(--border-radius) - 2px);
            border: 1px solid var(--gray-300);
            box-shadow: var(--shadow-sm);
            background-color: white;
            display: inline-block;
        }

        .webcam-error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
        }

        .webcam-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .panel-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .panel-content {
            padding: 1rem;
        }

        .panel-alert {
            background-color: #fef2f2;
            border: 1px solid #fee2e2;
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #991b1b;
        }

        .panel-alert svg {
            flex-shrink: 0;
        }

        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            white-space: nowrap;
        }

        .button:hover {
            background-color: var(--primary-dark);
        }

        .button:active {
            transform: translateY(1px);
        }

        .button.secondary {
            background-color: var(--gray-500);
        }

        .button.secondary:hover {
            background-color: var(--gray-600);
        }

        select.button {
            appearance: none;
            padding-right: 2rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background-color: var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .table-footer {
            padding: 0.75rem 1rem;
            color: var(--gray-600);
            font-size: 0.875rem;
            background-color: var(--gray-100);
            border-top: 1px solid var(--gray-200);
        }

        /* Tabs styling */
        .tabs-container {
            border-bottom: 1px solid var(--gray-200);
        }
        
        .tabs {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none; /* For Firefox */
            -ms-overflow-style: none; /* For Internet Explorer and Edge */
        }
        
        .tabs::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Opera */
        }
        
        .tab-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            color: var(--primary-color);
            background-color: var(--gray-100);
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content-container {
            padding: 0;
        }
        
        .tab-content {
            display: none !important;
            visibility: hidden;
            position: absolute;
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }
                
        .tab-content.active {
            display: block !important;
            visibility: visible;
            position: relative;
            opacity: 1;
            pointer-events: auto;
            z-index: 1;
        }
        
        .tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1rem 0.5rem;
        }
        
        .tab-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .tab-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem 1rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .tab-link {
            color: var(--primary-color);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .tab-link:hover {
            text-decoration: underline;
        }
        
        /* Cyclone Map Container Styling */
        .cyclone-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 55%; /* 4:3 aspect ratio */
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: var(--gray-200);
        }
        
        .cyclone-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: var(--border-radius);
            background-color: var(--gray-100);
        }
        
        .cyclone-error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            text-align: center;
        }

        /* Outage info styling */
        .outage-info-container {
            padding: 1rem;
        }
        
        .outage-card {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        
        .outage-card-icon {
            flex-shrink: 0;
            color: var(--primary-color);
        }
        
        .outage-card-content h3 {
            margin: 0 0 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .outage-card-content p {
            margin: 0 0 0.5rem;
            color: var(--gray-700);
        }
        
        .outage-alternatives h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0 0 1rem;
        }
        
        .outage-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .outage-list li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }
        
        .outage-list li svg {
            color: var(--primary-color);
            flex-shrink: 0;
        }
        
        /* Map containers styling */
        .maps-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        @media (min-width: 992px) {
            .maps-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Radar container and display styling */
        .radar-container {
            position: relative;
            width: 100%;
            max-width: 512px;
            height: 400px;
            margin: 0 auto;
            text-align: center;
            background-color: #99ccff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .radar-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            width: 100%;
        }
        
        /* Updated legend styling - bigger and centered */
        .legend-container {
            width: 100%;
            text-align: center;
            margin: 15px auto;
        }
        
        .legend-image {
            width: 350px; /* Increased from 250px to 350px */
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            display: inline-block;
        }
        
        @media screen and (max-width: 768px) {
            .legend-image {
                width: 300px; /* Still bigger on mobile but slightly smaller */
            }
        }
        
        /* Image and layer styling */
        .radar-image, .map-layer {
            position: absolute;
            top: -50px;
            left: 0;
            width: 100%;
            height: calc(100% + 50px);
            object-fit: cover;
        }
        
        /* Improved control buttons styling */
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        /* Media player style buttons */
        .control-buttons button {
            width: 48px;
            height: 48px;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-buttons button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .control-buttons button:active {
            transform: translateY(0);
        }
        
        .control-buttons button:disabled {
            background-color: #f0f0f0;
            color: #aaa;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        /* Make both play and pause buttons larger */
        #btn-play, #btn-pause {
            width: 56px;
            height: 56px;
            font-size: 20px;
        }
        
        /* First and last buttons styling */
        #btn-first, #btn-last {
            font-size: 14px;
        }
        
        /* Speed controls */
        .speed-controls {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .speed-slider {
            flex-grow: 1;
            max-width: 180px;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            outline: none;
            border-radius: 4px;
        }
        
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .speed-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }
        
        /* Media player style buttons */
        .control-buttons button {
            width: 40px;
            height: 40px;
            padding: 0;
            background-color: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-buttons button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .control-buttons button:active {
            transform: translateY(0);
        }
        
        .control-buttons button:disabled {
            background-color: #f0f0f0;
            color: #aaa;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        /* Speed controls */
        .speed-controls {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .speed-slider {
            flex-grow: 1;
            max-width: 180px;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            outline: none;
            border-radius: 4px;
        }
        
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .speed-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }
        
        /* Information displays */
        #timestamp {
            font-weight: 600;
            text-align: center;
            margin: 15px 0 5px 0;
            font-size: 1.1em;
        }
        
        .frame-counter {
            font-size: 0.85em;
            color: var(--text-light);
            text-align: center;
            margin-bottom: 10px;
        }
        
        /* Progress bar */
        .progress-container {
            width: 100%;
            max-width: 400px;
            background-color: #e0e0e0;
            height: 5px;
            margin: 10px auto;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.2s;
        }
        
        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
            z-index: 20;
            border-radius: 8px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Layer controls */
        .layer-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
            padding: 0 20px;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .layer-toggle input[type="checkbox"] {
            margin-right: 5px;
            cursor: pointer;
        }
        
        /* Error display */
        .error {
            color: #cc0000;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            margin: 10px 20px;
            background-color: #ffeeee;
            border-radius: 5px;
            border-left: 4px solid #cc0000;
        }
        
        /* Last update info */
        .last-update {
            text-align: center;
            font-size: 0.85em;
            color: var(--text-light);
            margin-bottom: 10px;
        }
        
        /* Responsive adjustments */
        @media screen and (max-width: 768px) {
            .radar-display {
                flex-direction: column;
                align-items: center;
            }
            
            .legend-container {
                margin: 10px auto;
            }
            
            .control-buttons {
                flex-wrap: wrap;
            }
        }
        
        /* River system header styling */
        .river-system-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .river-system-header td {
            padding: 0.5rem 1rem;
            font-size: 0.95rem;
        }

        /* Status styles */
        .rising {
            color: var(--danger-color);
            font-weight: 600;
        }

        .falling {
            color: var(--success-color);
            font-weight: 600;
        }

        .steady {
            color: var(--info-color);
            font-weight: 600;
        }

        /* Flood category styling */
        .minor-flood {
            background-color: rgba(255, 193, 7, 0.1);
        }

        .moderate-flood {
            background-color: rgba(255, 140, 0, 0.1);
        }

        .major-flood {
            background-color: rgba(220, 53, 69, 0.1);
        }

        /* Emergency section styling */
        .emergency-contacts {
            background-color: #fef2f2;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .emergency-header {
            background-color: var(--danger-color);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .emergency-content {
            padding: 1rem;
        }

        .emergency-number {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0.25rem 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .emergency-number svg {
            flex-shrink: 0;
        }

        .evacuation-centers {
            margin-top: 1rem;
        }

        .center-list {
            list-style-type: none;
            margin-top: 0.5rem;
        }

        .center-list li {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            background-color: var(--gray-100);
            margin-bottom: 0.5rem;
        }

        .center-list strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--gray-800);
        }

        /* Resources Section Styling */
        .resources-panel {
            background-color: #f0f7ff;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-top: 1.5rem;
        }
        
        .resources-header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .resources-content {
            padding: 1rem;
        }
        
        .resources-list {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        
        .resources-list li {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
        }
        
        .resources-list li:last-child {
            margin-bottom: 0;
        }
        
        .resources-list li svg {
            color: var(--primary-color);
            flex-shrink: 0;
            margin-top: 0.25rem;
        }
        
        .resource-item-content {
            flex: 1;
        }
        
        .resource-item-content strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--gray-800);
        }
        
        .resource-item-content p {
            margin: 0 0 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.4;
        }
        
        .resource-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--primary-color);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .resource-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }
        
        .resource-link svg {
            flex-shrink: 0;
        }

        /* Stats panel styling */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-item {
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-item.critical .stat-value {
            color: var(--danger-color);
        }

        .stat-footer {
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        /* Status panel */
        .status-panel {
            padding: 1rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .status-value {
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-value.online {
            background-color: rgba(67, 160, 71, 0.1);
            color: var(--success-color);
        }

        .status-value.offline {
            background-color: rgba(229, 57, 53, 0.1);
            color: var(--danger-color);
        }

        .status-value.unknown {
            background-color: rgba(255, 160, 0, 0.1);
            color: var(--warning-color);
        }

        .status-actions {
            margin-top: 1rem;
            text-align: right;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            backdrop-filter: blur(4px);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            color: white;
            max-width: 350px;
            box-shadow: var(--shadow-lg);
            z-index: 999;
            transition: all 0.3s ease;
            transform: translateY(100px);
            opacity: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.info {
            background-color: var(--info-color);
        }

        .notification-icon {
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0.25rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Data source attribution */
        .data-attribution {
            text-align: center;
            padding: 1.5rem;
            color: var(--gray-600);
            font-size: 0.875rem;
            border-top: 1px solid var(--gray-200);
            background-color: white;
        }

        .data-attribution a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .data-attribution a:hover {
            text-decoration: underline;
        }

        /* River Height Chart Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 5% auto;
            width: 90%;
            max-width: 1000px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from {opacity: 0; transform: translateY(-30px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-600);
            transition: color 0.2s;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: var(--gray-900);
        }
        
        .modal-body {
            padding: 1rem 1.5rem;
            position: relative;
            min-height: 400px;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .river-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10;
        }
        
        .river-chart-container {
            width: 100%;
            height: 400px;
        }
        
        .river-data-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--danger-color);
            padding: 2rem;
        }
        
        .river-data-error svg {
            margin-bottom: 1rem;
            color: var(--danger-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-title h1 {
                font-size: 1.25rem;
            }

            .stats-container {
                grid-template-columns: 1fr 1fr;
            }

            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .refresh-controls {
                width: 100%;
                justify-content: space-between;
            }

            .filter-buttons {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 576px) {
            .header-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* Flood Map Tab Styles */
        #content-floodmap {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .flood-map-container {
            position: relative;
            flex: 1;
            min-height: 400px;
        }

        #flood-map {
            width: 100%;
            height: 100%;
            min-height: 400px;
            z-index: 1;
        }

        .flood-controls {
            padding: 1rem;
            background-color: white;
            border-top: 1px solid var(--gray-200);
        }

        .flood-controls-inner {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .flood-slider-container {
            flex: 1;
        }

        .flood-height-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .flood-height-value {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.85rem;
        }

        .flood-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            appearance: none;
            background: var(--gray-300);
            outline: none;
        }

        .flood-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        .flood-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        .flood-toggle-container {
            display: flex;
            gap: 0.5rem;
        }

        .flood-stats-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
        }

        .flood-stat-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .flood-stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
        }

        .flood-stat-item {
            background: white;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .flood-stat-label {
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
        }

        .flood-stat-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .category-critical {
            background: rgba(229, 57, 53, 0.1);
            color: var(--danger-color);
        }

        .category-warning {
            background: rgba(255, 160, 0, 0.1);
            color: var(--warning-color);
        }

        .category-alert {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
        }

        .category-safe {
            background: rgba(67, 160, 71, 0.1);
            color: var(--success-color);
        }

        /* Flood map legend */
        .flood-map-legend {
            position: absolute;
            right: 10px;
            bottom: 30px;
            background: white;
            border-radius: var(--border-radius);
            padding: 10px;
            box-shadow: var(--shadow-md);
            z-index: 1000;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .legend-label {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading flood data...</p>
    </div>

    <!-- Notification Component -->
    <div id="notification" class="notification">
        <span class="notification-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="10" cy="10" r="8"></circle>
                <line x1="10" y1="6" x2="10" y2="10"></line>
                <line x1="10" y1="14" x2="10.01" y2="14"></line>
            </svg>
        </span>
        <div id="notification-message" class="notification-content"></div>
        <button class="notification-close" onclick="document.getElementById('notification').classList.remove('show')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="header-title">
                <h1>Lismore Flood Emergency Dashboard</h1>
            </div>
            <div class="header-info">
                <div id="clock" class="clock-container">Loading time...</div>
                <div>Last updated: <span id="last-update-time">Never</span></div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <main>
            <!-- Tabbed content section -->
            <div class="panel">
                <div class="tabs-container">
                    <div class="tabs">
                        <button id="tab-webcam" class="tab-button active">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M23 7l-7 5 7 5V7z"></path>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                            </svg>
                            Traffic Camera
                        </button>
                        <button id="tab-radar" class="tab-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <circle cx="12" cy="12" r="6"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                            </svg>
                            Rainfall Radar
                        </button>
                        <button id="tab-cyclone" class="tab-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 32 32" fill="currentColor" style="transform: scaleX(-1);">
                                <path d="M16,21a5,5,0,1,1,5-5A5.0057,5.0057,0,0,1,16,21Zm0-8a3,3,0,1,0,3,3A3.0033,3.0033,0,0,0,16,13Z"></path>
                                <path d="M22.6521,4.1821l-2.177,2.5142L19.0713,8.3174,20.7864,9.605A7.9361,7.9361,0,0,1,23.9963,16l.0008.0576.0017.0415c.018.4317.2412,10.1113-14.6538,11.7222l2.18-2.5176,1.4039-1.6211L11.2139,22.395A7.9361,7.9361,0,0,1,8.0037,16l-.0008-.0576-.0017-.0415C7.9832,15.47,7.7605,5.8071,22.6521,4.1821M24.9978,2c-.0164,0-.0327,0-.0493.001C5.2532,2.9146,6.0037,16,6.0037,16a9.975,9.975,0,0,0,4.0095,7.9946L6.2368,28.3555A1.0044,1.0044,0,0,0,7.0022,30c.0164,0,.0327,0,.0493-.001C26.7468,29.0854,25.9963,16,25.9963,16a9.9756,9.9756,0,0,0-4.0092-7.9946l3.7761-4.3609A1.0044,1.0044,0,0,0,24.9978,2Z"></path>
                            </svg>
                            Cyclone Map
                        </button>
                        <button id="tab-floodmap" class="tab-button">
                            <svg width="16px" height="16px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                            <title>flood</title>
                            <path d="M26.885 13.116c-0.226-0.226-0.539-0.366-0.884-0.366-0.445 0-0.836 0.233-1.058 0.583l-0.003 0.005c-1.395 2.232-2.758 3.413-3.939 3.413s-2.545-1.181-3.94-3.413c-0.238-0.334-0.624-0.549-1.060-0.549s-0.822 0.215-1.057 0.545l-0.003 0.004c-1.395 2.232-2.757 3.413-3.939 3.413s-2.545-1.181-3.939-3.413c-0.224-0.355-0.615-0.588-1.060-0.588-0.345 0-0.658 0.14-0.884 0.366l-4 4c-0.226 0.226-0.366 0.539-0.366 0.884 0 0.69 0.56 1.25 1.25 1.25 0.345 0 0.658-0.14 0.884-0.366l2.933-2.934c3.248 4.354 6.93 4.428 10.184 0.24 1.073 1.714 2.884 2.881 4.976 3.057l0.024 0.002c2.218-0.205 4.103-1.465 5.167-3.268l0.017-0.031 2.932 2.934c0.227 0.228 0.541 0.37 0.888 0.37 0.691 0 1.251-0.56 1.251-1.251 0-0.347-0.141-0.661-0.369-0.887l-0-0zM2.884 8.884l2.933-2.933c3.246 4.352 6.929 4.429 10.184 0.24 3.256 4.187 6.936 4.111 10.184-0.24l2.932 2.933c0.226 0.227 0.539 0.367 0.885 0.367 0.691 0 1.251-0.56 1.251-1.251 0-0.345-0.14-0.658-0.366-0.884v0l-4-4c-0.226-0.226-0.539-0.366-0.885-0.366-0.445 0-0.836 0.232-1.058 0.582l-0.003 0.005c-1.395 2.232-2.758 3.413-3.939 3.413s-2.545-1.181-3.94-3.413c-0.238-0.333-0.624-0.548-1.059-0.548s-0.822 0.215-1.057 0.545l-0.003 0.004c-1.396 2.231-2.758 3.412-3.94 3.412s-2.545-1.181-3.94-3.412c-0.199-0.316-0.529-0.534-0.912-0.579l-0.006-0.001c-0.040-0.005-0.087-0.007-0.135-0.007-0.347 0-0.662 0.14-0.891 0.366l-4 4c-0.225 0.226-0.363 0.537-0.363 0.881 0 0.69 0.56 1.25 1.25 1.25 0.344 0 0.655-0.139 0.881-0.363l-0 0zM26.885 23.115c-0.226-0.226-0.539-0.365-0.884-0.365-0.445 0-0.836 0.233-1.058 0.583l-0.003 0.005c-1.395 2.232-2.758 3.412-3.939 3.412s-2.545-1.18-3.94-3.412c-0.238-0.333-0.624-0.548-1.060-0.548s-0.822 0.215-1.057 0.544l-0.003 0.004c-1.395 2.232-2.757 3.412-3.939 3.412s-2.545-1.18-3.939-3.412c-0.225-0.355-0.616-0.588-1.061-0.588-0.345 0-0.657 0.14-0.884 0.366l-4 4c-0.227 0.226-0.367 0.539-0.367 0.885 0 0.691 0.56 1.251 1.251 1.251 0.345 0 0.658-0.14 0.884-0.366v0l2.933-2.934c3.248 4.352 6.93 4.426 10.184 0.24 1.073 1.714 2.884 2.881 4.976 3.057l0.024 0.002c2.218-0.205 4.103-1.465 5.167-3.268l0.017-0.031 2.932 2.934c0.226 0.226 0.539 0.366 0.884 0.366 0.691 0 1.251-0.56 1.251-1.251 0-0.345-0.14-0.658-0.366-0.884l0 0z"></path>
                            </svg>
                            Flood Map
                        </button>
                        <button id="tab-outage" class="tab-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 20V10"></path>
                                <path d="M12 20V4"></path>
                                <path d="M6 20v-6"></path>
                            </svg>
                            Power Outages
                        </button>
                    </div>
                </div>
                
                <!-- Tab content -->
                <div class="tab-content-container">
                    <!-- Webcam Tab -->
                    <div id="content-webcam" class="tab-content active">
                        <div class="tab-header">
                            <h2>Bruxner Highway Lismore - Live Traffic Camera</h2>
                            <div>
                                <button id="refresh-webcam" class="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="webcam-image-container">
                            <img id="webcam" src="https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/bruxner_highway_lismore.jpeg" alt="Bruxner Highway Lismore Traffic Camera" class="webcam-image">
                            <div id="webcam-error" class="webcam-error">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                Unable to load webcam image
                            </div>
                        </div>
                        <div class="tab-footer">
                            <span>Image auto-updates every few seconds</span>
                            <span id="webcam-timestamp">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Radar Tab with SVG Icons -->
                    <div id="content-radar" class="tab-content">
                        <div class="tab-header">
                            <h2>Grafton 256km Radar</h2>
                            <div>
                                <button id="refresh-btn" class="button">
                                    <!-- Refresh icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div id="error" class="error" style="display: none;"></div>
                        
                        <div class="radar-wrapper">
                            <div class="radar-display">
                                <div class="radar-container">
                                    <!-- Map layers - ORDER IS IMPORTANT -->
                                    <img id="background-layer" class="map-layer" src="" alt="Background Map" style="z-index: 1;">
                                    <img id="topography-layer" class="map-layer" src="" alt="Topography" style="z-index: 2;">
                                    <img id="range-layer" class="map-layer" src="" alt="Range Rings" style="z-index: 3;">
                                    <img id="radar-image" class="radar-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Radar Image" style="z-index: 4;">
                                    <img id="locations-layer" class="map-layer" src="" alt="Locations" style="z-index: 5;">
                                    
                                    <div id="loading" class="loading">
                                        <div class="spinner"></div>
                                        Loading radar images...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Using local legend image with increased size -->
                            <div class="legend-container">
                                <img src="/resources/Rain Radar/legend.png" alt="Radar Legend" class="legend-image">
                            </div>
                            
                            <div id="timestamp">No data loaded</div>
                            <div id="frame-counter" class="frame-counter"></div>
                            
                            <div class="progress-container">
                                <div id="progress-bar" class="progress-bar"></div>
                            </div>
                            
                            <!-- Improved animation controls with SVG icons -->
                            <div class="controls">
                                <div class="control-buttons">
                                    <button id="btn-first" disabled title="First frame">
                                        <!-- First frame icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-prev" disabled title="Previous frame">
                                        <!-- Previous icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-play" disabled title="Play">
                                        <!-- Play icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M8 5v14l11-7z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-pause" disabled title="Pause">
                                        <!-- Pause icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-next" disabled title="Next frame">
                                        <!-- Next icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-last" disabled title="Last frame">
                                        <!-- Last frame icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="speed-controls">
                                    <label for="speed">Speed:</label>
                                    <input type="range" id="speed" class="speed-slider" min="1" max="10" value="5">
                                    <span id="speed-value">500ms</span>
                                </div>
                            </div>
                            
                            <div class="layer-controls">
                                <label class="layer-toggle">
                                    <input type="checkbox" id="topography-toggle" checked>
                                    Topography
                                </label>
                                <label class="layer-toggle">
                                    <input type="checkbox" id="locations-toggle" checked>
                                    Locations
                                </label>
                                <label class="layer-toggle">
                                    <input type="checkbox" id="range-toggle" checked>
                                    Range Rings
                                </label>
                            </div>
                            
                            <div id="last-update" class="last-update"></div>
                        </div>
                        
                        <div class="tab-footer">
                            <span>Data source: Bureau of Meteorology, Australia</span>
                            <a href="http://www.bom.gov.au/products/IDR282.loop.shtml" target="_blank" rel="noopener noreferrer" class="tab-link">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                View BOM original
                            </a>
                        </div>
                    </div>
                    
                    <!-- Cyclone Container-->
                    <div id="content-cyclone" class="tab-content">
                        <div class="tab-header">
                            <h2>Tropical Cyclone Forecast Track Map</h2>
                            <div>
                                <button id="refresh-cyclone" class="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="cyclone-container">
                            <img id="cyclone-image" src="http://www.bom.gov.au/fwo/IDQ65001.png" alt="Tropical Cyclone Forecast Track Map" class="cyclone-image">
                            <div id="cyclone-error" class="cyclone-error">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                Unable to load cyclone map
                            </div>
                        </div>
                        <div class="tab-footer">
                            <a href="http://www.bom.gov.au/cyclone/" target="_blank" rel="noopener noreferrer" class="tab-link">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                View detailed cyclone information
                            </a>
                            <span id="cyclone-timestamp">Loading...</span>
                        </div>
                    </div>

                    <!-- Flood Map Tab -->
                    <div id="content-floodmap" class="tab-content">
                        <div class="tab-header">
                            <h2>Lismore Flood Impact Map</h2>
                            <div>
                                <button id="refresh-floodmap" class="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="flood-map-container">
                            <div id="flood-map"></div>
                            
                            <div class="flood-map-legend">
                                <div class="legend-title">Impact Legend</div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                                    <div class="legend-label">Floor Level Affected (Critical)</div>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #f39c12;"></div>
                                    <div class="legend-label">Gate Level Affected (Warning)</div>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #f1c40f;"></div>
                                    <div class="legend-label">Road Centre Affected (Alert)</div>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #2ecc71;"></div>
                                    <div class="legend-label">Not Affected (Safe)</div>
                                </div>
                            </div>
                            
                            <div id="flood-loading-overlay" class="loading-overlay">
                                <div class="spinner"></div>
                                <p id="flood-loading-status">Processing flood data...</p>
                                <div class="progress-container">
                                    <div class="progress-bar" id="flood-processing-progress"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flood-controls">
                            <div class="flood-controls-inner">
                                <div class="flood-slider-container">
                                    <div class="flood-height-label">
                                        <span>Flood Water Height:</span>
                                        <span class="flood-height-value" id="flood-height-display">12.0m</span>
                                    </div>
                                    <input type="range" id="flood-height-slider" class="flood-slider" min="1.55" max="40.44" step="0.1" value="12.0">
                                </div>
                                
                                <div class="flood-toggle-container">
                                    <button id="use-current-level" class="button">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 2v6"></path>
                                            <path d="M12 22v-6"></path>
                                            <path d="M4.93 4.93L9 9"></path>
                                            <path d="M14.36 14.36L18.07 18.07"></path>
                                            <path d="M2 12h6"></path>
                                            <path d="M22 12h-6"></path>
                                            <path d="M4.93 19.07L9 15"></path>
                                            <path d="M14.36 9.64L18.07 5.93"></path>
                                        </svg>
                                        Use Current Level
                                    </button>
                                    
                                    <div class="toggle-group">
                                        <div class="toggle-option">
                                            <input type="radio" id="flood-show-markers" name="floodViewMode" checked>
                                            <label for="flood-show-markers" class="toggle-label">Markers</label>
                                        </div>
                                        <div class="toggle-option">
                                            <input type="radio" id="flood-show-heatmap" name="floodViewMode">
                                            <label for="flood-show-heatmap" class="toggle-label">Heatmap</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="flood-stats-container" class="flood-stats-container">
                                <div class="flood-stat-title">Impact Summary at <span id="flood-stats-height">12.0m</span></div>
                                <div class="flood-stat-grid">
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Properties Analyzed</div>
                                        <div class="flood-stat-value" id="flood-stat-total">0</div>
                                    </div>
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Floor Level Affected</div>
                                        <div class="flood-stat-value" id="flood-stat-critical">0 <span class="category-badge category-critical">Critical</span></div>
                                    </div>
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Gate Level Affected</div>
                                        <div class="flood-stat-value" id="flood-stat-warning">0 <span class="category-badge category-warning">Warning</span></div>
                                    </div>
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Road Level Affected</div>
                                        <div class="flood-stat-value" id="flood-stat-alert">0 <span class="category-badge category-alert">Alert</span></div>
                                    </div>
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Not Affected</div>
                                        <div class="flood-stat-value" id="flood-stat-safe">0 <span class="category-badge category-safe">Safe</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Outage Map Tab -->
                    <div id="content-outage" class="tab-content">
                        <div class="tab-header">
                            <h2>Essential Energy Power Outages</h2>
                            <div>
                                <a href="https://www.essentialenergy.com.au/outages-and-faults/power-outages" target="_blank" rel="noopener noreferrer" class="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                    Open Map
                                </a>
                            </div>
                        </div>
                        <div class="outage-info-container">
                            <div class="outage-card">
                                <div class="outage-card-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                                    </svg>
                                </div>
                                <div class="outage-card-content">
                                    <h3>Unable to Display Power Outage Map</h3>
                                    <p>The Essential Energy website prevents embedding their outage map in other websites.</p>
                                    <p>Please click the "Open Map" button above to view the current power outages in a new tab.</p>
                                </div>
                            </div>
                            <div class="outage-alternatives">
                                <h3>Power Outage Information</h3>
                                <ul class="outage-list">
                                    <li>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12 6 12 12 16 14"></polyline>
                                        </svg>
                                        <span>Call <strong>13 20 80</strong> for power outage updates</span>
                                    </li>
                                    <li>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                        </svg>
                                        <span>Report outages: <strong>13 20 80</strong></span>
                                    </li>
                                    <li>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                        <span>Life-threatening emergencies: <strong>000</strong></span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="tab-footer">
                            <a href="https://www.essentialenergy.com.au/outages-and-faults/power-outages" target="_blank" rel="noopener noreferrer" class="tab-link">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                View power outage map
                            </a>
                            <span>Essential Energy: 13 20 80</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flood Data Section -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Wilsons River Flood Data</h2>
                    <div class="refresh-controls">
                        <select id="refresh-interval" class="button secondary">
                            <option value="300000">Refresh: 5 min</option>
                            <option value="60000">Refresh: 1 min</option>
                            <option value="600000">Refresh: 10 min</option>
                            <option value="1800000">Refresh: 30 min</option>
                        </select>
                        <button id="refresh-now" class="button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 2v6h-6"></path>
                                <path d="M3 12a9 9 0 0 1 15-6.7l3-3"></path>
                                <path d="M3 22v-6h6"></path>
                                <path d="M21 12a9 9 0 0 1-15 6.7l-3 3"></path>
                            </svg>
                            Refresh Now
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="panel-alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <span>EMERGENCY USE: This dashboard fetches LIVE data from the Bureau of Meteorology. Always follow directions from emergency services during flood events.</span>
                    </div>
                    
                    <div class="filter-buttons">
                        <button id="show-all" class="button secondary">All Locations</button>
                        <button id="show-critical" class="button">Key Monitoring Stations</button>
                    </div>
                    
                    <div class="table-container">
                        <table id="flood-data">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Time</th>
                                    <th>Water Level (m)</th>
                                    <th>Status</th>
                                    <th>Flood Category</th>
                                </tr>
                            </thead>
                            <tbody id="flood-data-body">
                                <tr>
                                    <td colspan="5" style="text-align: center;">Loading data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        Data auto-refreshes based on selected interval
                    </div>
                </div>
            </div>

            <!-- Data Sources & Status -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Data Sources & Status</h2>
                </div>
                <div class="status-panel">
                    <div id="proxy-status" class="status-item">
                        <span class="status-label">Proxy Server:</span>
                        <span class="status-value" id="proxy-status-value">Checking...</span>
                    </div>
                    <div id="bom-status" class="status-item">
                        <span class="status-label">BOM Data:</span>
                        <span class="status-value" id="bom-status-value">Checking...</span>
                    </div>
                    <div id="webcam-status" class="status-item">
                        <span class="status-label">Traffic Camera:</span>
                        <span class="status-value" id="webcam-status-value">Checking...</span>
                    </div>
                    <div class="status-actions">
                        <button id="check-status" class="button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 2v6h-6"></path>
                                <path d="M3 12a9 9 0 0 1 15-6.7l3-3"></path>
                                <path d="M3 22v-6h6"></path>
                                <path d="M21 12a9 9 0 0 1-15 6.7l-3 3"></path>
                            </svg>
                            Check Status
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <aside>
            <!-- Flood Statistics -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Flood Statistics</h2>
                </div>
                <div class="panel-content">
                    <div class="stats-container" id="stats-container">
                        <div class="stat-item">
                            <div class="stat-label">Wilsons R at Lismore (mAHD)</div>
                            <div id="lismore-level" class="stat-value">-</div>
                            <div id="lismore-status" class="stat-footer">Loading...</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Highest Reading</div>
                            <div id="highest-reading" class="stat-value">-</div>
                            <div id="highest-location" class="stat-footer">Loading...</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Rising Locations</div>
                            <div id="rising-count" class="stat-value">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Falling Locations</div>
                            <div id="falling-count" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Contacts -->
            <div class="emergency-contacts">
                <div class="emergency-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                    Emergency Contacts
                </div>
                <div class="emergency-content">
                    <h3>SES Emergency</h3>
                    <div class="emergency-number">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        132 500
                    </div>
                    
                    <h3>Life Threatening Emergencies</h3>
                    <div class="emergency-number">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        000
                    </div>
                    
                    <div class="evacuation-centers">
                        <h3>Evacuation Centers</h3>
                        <ul class="center-list">
                            <li>
                                <strong>Southern Cross University</strong>
                                Military Rd, East Lismore
                            </li>
                            <li>
                                <strong>Lismore City Hall</strong>
                                1 Bounty St, Lismore
                            </li>
                            <li>
                                <strong>Goonellabah Sports & Aquatic Centre</strong>
                                50 Oliver Ave, Goonellabah
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Useful Resources -->
            <div class="resources-panel">
                <div class="resources-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    Useful Resources
                </div>
                <div class="resources-content">
                    <ul class="resources-list">
                        <li>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            <div class="resource-item-content">
                                <strong>Lismore Flood History</strong>
                                <p>Comprehensive historical flood data for Lismore</p>
                                <a href="https://australiasevereweather.com/floods/index.html" target="_blank" rel="noopener noreferrer" class="resource-link">
                                    Visit Website
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                        </li>
                        <li>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                                <line x1="8" y1="2" x2="8" y2="18"></line>
                                <line x1="16" y1="6" x2="16" y2="22"></line>
                            </svg>
                            <div class="resource-item-content">
                                <strong>Flood Map Tool</strong>
                                <p>Interactive flood mapping tool showing affected areas by height</p>
                                <a href="https://www.floodmap.net/" target="_blank" rel="noopener noreferrer" class="resource-link">
                                    Open Map Tool
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                        </li>
                        <li>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                            </svg>
                            <div class="resource-item-content">
                                <strong>BOM Lismore</strong>
                                <p>Bureau of Meteorology's new beta site for Lismore</p>
                                <a href="https://beta.bom.gov.au/poi-location/australia/new-south-wales/northern-rivers/nsw_pt079-lismore" target="_blank" rel="noopener noreferrer" class="resource-link">
                                    View BOM Site
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                        </li>
                        <li>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <div class="resource-item-content">
                                <strong>NSW SES - Flood Safety</strong>
                                <p>Official resources and safety information</p>
                                <a href="https://www.ses.nsw.gov.au/disaster-tabs-header/flood/" target="_blank" rel="noopener noreferrer" class="resource-link">
                                    Safety Information
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>
    </div>

    <footer class="data-attribution">
        <p>Data sourced from <a href="http://www.bom.gov.au" target="_blank" rel="noopener noreferrer">Bureau of Meteorology</a> and <a href="https://www.transport.nsw.gov.au" target="_blank" rel="noopener noreferrer">Transport for NSW</a>.</p>
        <p>This dashboard is for emergency use during flood events in the Lismore area.</p>
    </footer>

    <!-- External scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
        // Define the levee wall coordinates
        const leveeCoordinates = [
            [153.2779234789894, -28.80564897533751], [153.2776284287106, -28.80583653192451],
            [153.2775473935466, -28.80578584679196], [153.2774086343345, -28.80589734283666],
            [153.2773869897634, -28.80594964071906], [153.2774102741197, -28.80596169296753],
            [153.2773249113709, -28.80610037084291], [153.2771329846015, -28.80599601019963],
            [153.2770561642849, -28.80609599092546], [153.2769759706041, -28.80607065351402],
            [153.2769225873773, -28.80615138249765], [153.2771238902704, -28.80627143942861],
            [153.2771042437316, -28.80631013165758], [153.2770393628764, -28.80627702301991],
            [153.2770241261831, -28.80629441993291], [153.2769220530088, -28.80624117453304],
            [153.2768766932163, -28.80632282295921], [153.2769696013465, -28.80638388213526],
            [153.2768686212507, -28.80654609791701], [153.2766122114514, -28.80641321031905],
            [153.2762852689198, -28.80687177730074], [153.27623452077, -28.80688817209607],
            [153.2759469768278, -28.80671352421123], [153.2757810011812, -28.8066576253247],
            [153.2755564149109, -28.80697526665091], [153.2757588315603, -28.80711770645244],
            [153.2757357547251, -28.80717838893401], [153.2758506705051, -28.80723784361079],
            [153.275819962155, -28.80728629171487], [153.2757402582966, -28.80729438003862],
            [153.2756002918833, -28.80749807647723], [153.2757079015264, -28.80754879741433],
            [153.2755268407124, -28.80784997889503], [153.275534526505, -28.807891520335],
            [153.2755636339584, -28.80792475454313], [153.2753084206615, -28.80829011404793],
            [153.2753498432981, -28.808315156535], [153.2753462077596, -28.80837176440883],
            [153.2755912039843, -28.80851963768052], [153.275495379482, -28.80865023484822],
            [153.2754382615978, -28.80864280421942], [153.275343368243, -28.8087559250459],
            [153.2752998891227, -28.80892014140416], [153.2749823509539, -28.80899625576804],
            [153.2745141767591, -28.80923041219856], [153.2742101627201, -28.80946447124336],
            [153.2739078774804, -28.80966753062161], [153.2734055703105, -28.81013081939378],
            [153.2730680212187, -28.81031728641019], [153.2729078113743, -28.81048653329279],
            [153.2724986320497, -28.81049177556017], [153.2724255633508, -28.81059853360265],
            [153.2723476330192, -28.81062356600956], [153.2722830179564, -28.81072680961973],
            [153.272087876255, -28.81087734874062], [153.2718494740316, -28.81118854434206],
            [153.2717288404832, -28.81137281375635], [153.2714104828596, -28.81143925272617],
            [153.2712177644198, -28.81154772674801], [153.2712141581074, -28.81186060127457],
            [153.2711843689477, -28.81202484689156], [153.2709624213483, -28.81234344931174],
            [153.2707696671584, -28.81254049551611], [153.2707214619768, -28.81267071518178],
            [153.2707080191103, -28.81282324626406], [153.2706690168997, -28.81297114289579],
            [153.2708940313762, -28.81336688046893], [153.2709231093674, -28.81356763137908],
            [153.2711906807951, -28.81358726843914]
        ];
        
        // Define the area enclosed by the levee (used to check if properties are protected)
        const leveeAreaCoordinates = [
            [153.2779234789894, -28.80564897533751], [153.2776284287106, -28.80583653192451],
            [153.2775473935466, -28.80578584679196], [153.2774086343345, -28.80589734283666],
            [153.2773869897634, -28.80594964071906], [153.2774102741197, -28.80596169296753],
            [153.2773249113709, -28.80610037084291], [153.2771329846015, -28.80599601019963],
            [153.2770561642849, -28.80609599092546], [153.2769759706041, -28.80607065351402],
            [153.2769225873773, -28.80615138249765], [153.2771238902704, -28.80627143942861],
            [153.2771042437316, -28.80631013165758], [153.2770393628764, -28.80627702301991],
            [153.2770241261831, -28.80629441993291], [153.2769220530088, -28.80624117453304],
            [153.2768766932163, -28.80632282295921], [153.2769696013465, -28.80638388213526],
            [153.2768686212507, -28.80654609791701], [153.2766122114514, -28.80641321031905],
            [153.2762852689198, -28.80687177730074], [153.27623452077, -28.80688817209607],
            [153.2759469768278, -28.80671352421123], [153.2757810011812, -28.8066576253247],
            [153.2755564149109, -28.80697526665091], [153.2757588315603, -28.80711770645244],
            [153.2757357547251, -28.80717838893401], [153.2758506705051, -28.80723784361079],
            [153.275819962155, -28.80728629171487], [153.2757402582966, -28.80729438003862],
            [153.2756002918833, -28.80749807647723], [153.2757079015264, -28.80754879741433],
            [153.2755268407124, -28.80784997889503], [153.275534526505, -28.807891520335],
            [153.2755636339584, -28.80792475454313], [153.2753084206615, -28.80829011404793],
            [153.2753498432981, -28.808315156535], [153.2753462077596, -28.80837176440883],
            [153.2755912039843, -28.80851963768052], [153.275495379482, -28.80865023484822],
            [153.2754382615978, -28.80864280421942], [153.275343368243, -28.8087559250459],
            [153.2752998891227, -28.80892014140416], [153.2749823509539, -28.80899625576804],
            [153.2745141767591, -28.80923041219856], [153.2742101627201, -28.80946447124336],
            [153.2739078774804, -28.80966753062161], [153.2734055703105, -28.81013081939378],
            [153.2730680212187, -28.81031728641019], [153.2729078113743, -28.81048653329279],
            [153.2724986320497, -28.81049177556017], [153.2724255633508, -28.81059853360265],
            [153.2723476330192, -28.81062356600956], [153.2722830179564, -28.81072680961973],
            [153.272087876255, -28.81087734874062], [153.2718494740316, -28.81118854434206],
            [153.2717288404832, -28.81137281375635], [153.2714104828596, -28.81143925272617],
            [153.2712177644198, -28.81154772674801], [153.2712141581074, -28.81186060127457],
            [153.2711843689477, -28.81202484689156], [153.2709624213483, -28.81234344931174],
            [153.2707696671584, -28.81254049551611], [153.2707214619768, -28.81267071518178],
            [153.2707080191103, -28.81282324626406], [153.2706690168997, -28.81297114289579],
            [153.2708940313762, -28.81336688046893], [153.2709231093674, -28.81356763137908],
            [153.2711906807951, -28.81358726843914], [153.2721123183181, -28.81340143781495],
            [153.2728642861514, -28.81318988160984], [153.2738334696126, -28.81335757506337],
            [153.2754301255504, -28.81362863148366], [153.2781586962226, -28.81137704412088],
            [153.2801633775867, -28.80821818373613], [153.280001902673, -28.80759419775452],
            [153.2799494446037, -28.80677742276964], [153.2788428575995, -28.80616875198943],
            [153.2779234789894, -28.80564897533751]
        ];
        
        // Define the levee height and warning threshold
        const LEVEE_HEIGHT = 10.6; // meters
        const LEVEE_WARNING_THRESHOLD = 9.0; // meters - when to show warning color (orange)
        
        // Variable to store levee line layer reference
        let leveeLine = null;

        // API endpoints
        const BASE_URL = 'http://localhost:3000';
        const PROXY_URL = BASE_URL + '/flood-data';

        // Load CSV data from server API
        let embeddedCSVData = [];
        
        // Load the flood data on page load
        async function loadFloodData() {
            try {
                const response = await fetch('/api/flood-properties');
                if (!response.ok) {
                    throw new Error('Failed to load flood data');
                }
                embeddedCSVData = await response.json();
                console.log(`Loaded ${embeddedCSVData.length} flood data records from server`);
                
                // Initialize flood map after data is loaded
                if (typeof initFloodMapWithLevee === 'function') {
                    initFloodMapWithLevee();
                }
            } catch (error) {
                console.error('Error loading flood data:', error);
                embeddedCSVData = []; // Fallback to empty array
            }
        }
        
        // Call this when page loads
        loadFloodData();

        // DOM elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const webcamImage = document.getElementById('webcam');
        const webcamError = document.getElementById('webcam-error');
        const webcamTimestamp = document.getElementById('webcam-timestamp');
        const floodDataBody = document.getElementById('flood-data-body');
        const lastUpdateTime = document.getElementById('last-update-time');
        const refreshIntervalSelect = document.getElementById('refresh-interval');
        const refreshNowButton = document.getElementById('refresh-now');
        const showAllButton = document.getElementById('show-all');
        const showCriticalButton = document.getElementById('show-critical');
        const clockElement = document.getElementById('clock');
        const checkStatusButton = document.getElementById('check-status');
        
        // Stats elements
        const lismoreLevel = document.getElementById('lismore-level');
        const lismoreStatus = document.getElementById('lismore-status');
        const highestReading = document.getElementById('highest-reading');
        const highestLocation = document.getElementById('highest-location');
        const risingCount = document.getElementById('rising-count');
        const fallingCount = document.getElementById('falling-count');
        
        // Status elements
        const proxyStatusValue = document.getElementById('proxy-status-value');
        const bomStatusValue = document.getElementById('bom-status-value');
        const webcamStatusValue = document.getElementById('webcam-status-value');

        // Constants
        const MINOR_FLOOD_LEVEL = 4.20;
        const MODERATE_FLOOD_LEVEL = 7.20;
        const MAJOR_FLOOD_LEVEL = 9.70;
        const WEBCAM_REFRESH_INTERVAL = 1000; // 1 second
        const DEFAULT_REFRESH_INTERVAL = 300000; // 5 minutes
        const CRITICAL_THRESHOLD = 3.00; // Threshold for "critical" locations
        
        // BOM direct URL (for reference only - we'll use the proxy)
        const BOM_URL = 'http://www.bom.gov.au/nsw/flood/northern.shtml';

        // Variables
        let floodData = [];
        let refreshTimer = null;
        let webcamRefreshTimer = null;
        let showingCriticalOnly = false;
        let lastFetchTime = null;
        let currentLismoreLevel = null;
        let floodMap = null;
        let floodProperties = [];
        let floodMarkers = null;
        let floodHeatmapLayer = null;
        let floodMapInitialized = false;

        // Initialize
        initializeDashboard();

        // Main initialization function
        function initializeDashboard() {
            // Start the clock
            updateClock();
            setInterval(updateClock, 1000);
            
            // Add to your initializeDashboard function (anywhere before setupTabs)
            document.getElementById('refresh-cyclone').addEventListener('click', refreshCycloneMap);

            // Set up tab navigation
            setupTabs();
            
            // Set up webcam refresh
            refreshWebcam();
            webcamRefreshTimer = setInterval(refreshWebcam, WEBCAM_REFRESH_INTERVAL);
            document.getElementById('refresh-webcam').addEventListener('click', refreshWebcam);
            
            // Add a safety check
            const refreshRadarBtn = document.getElementById('refresh-radar') || document.getElementById('refresh-btn');
            if (refreshRadarBtn) {
                refreshRadarBtn.addEventListener('click', refreshRadar);
            }
            
            // Add this to your DOMContentLoaded or initialization function
            refreshCycloneMap(); // Initial load
            setInterval(refreshCycloneMap, 1000); // Refresh cyclone map every second

            // Set up flood data refresh
            refreshIntervalSelect.value = DEFAULT_REFRESH_INTERVAL;
            refreshIntervalSelect.addEventListener('change', updateRefreshInterval);
            
            // Set up buttons
            refreshNowButton.addEventListener('click', fetchFloodData);
            showAllButton.addEventListener('click', () => {
                showingCriticalOnly = false;
                showAllButton.classList.remove('secondary');
                showCriticalButton.classList.add('secondary');
                renderFloodData();
            });
            
            showCriticalButton.addEventListener('click', () => {
                showingCriticalOnly = true;
                showCriticalButton.classList.remove('secondary');
                showAllButton.classList.add('secondary');
                renderFloodData();
            });
            
            // Set critical view by default
            showingCriticalOnly = true;
            
            // Check data sources status
            checkDataSources();
            checkStatusButton.addEventListener('click', checkDataSources);

            // Set up automatic status checks every minute
            setupStatusAutoRefresh();
            
            // Load cached data if available
            loadCachedData();
            
            // Fetch fresh data
            fetchFloodData();
            
            // Start the refresh timer
            updateRefreshInterval();
            
            // Initialize flood map
            initFloodMapWithLevee();
        }
        
        // Add this to your initializeDashboard function or after the checkDataSources function is defined
        function setupStatusAutoRefresh() {
            console.log('Setting up automatic status checks every minute');
            
            // Perform an initial check
            checkDataSources();
            
            // Set up an interval to check status every minute (60000 ms)
            const statusCheckInterval = setInterval(checkDataSources, 60000);
            
            // Store the interval ID in case we need to clear it later
            window.statusCheckIntervalId = statusCheckInterval;
            
            // Add a timestamp indicator to show when the last auto-check occurred
            const statusPanel = document.querySelector('.status-panel');
            
            // Create last checked indicator if it doesn't exist
            if (!document.getElementById('status-last-checked')) {
                const lastCheckedElement = document.createElement('div');
                lastCheckedElement.className = 'status-item';
                lastCheckedElement.innerHTML = `
                    <span class="status-label">Last Auto-Check:</span>
                    <span id="status-last-checked" class="status-value">Just now</span>
                `;
                
                // Insert before the action buttons
                const statusActions = document.querySelector('.status-actions');
                if (statusActions) {
                    statusPanel.insertBefore(lastCheckedElement, statusActions);
                } else {
                    statusPanel.appendChild(lastCheckedElement);
                }
            }
            
            // Update the timestamp on each check
            const updateLastCheckedTime = () => {
                const lastCheckedElement = document.getElementById('status-last-checked');
                if (lastCheckedElement) {
                    lastCheckedElement.textContent = new Date().toLocaleTimeString('en-AU');
                }
            };
            
            // Hook into the checkDataSources function to update the timestamp
            const originalCheckDataSources = checkDataSources;
            window.checkDataSources = function() {
                originalCheckDataSources();
                updateLastCheckedTime();
            };
            
            // Initialize the timestamp
            updateLastCheckedTime();
        }
        
        // Call this function to set up automatic status checks
        setupStatusAutoRefresh();

        // Modified setupTabs function to handle unavailable tabs
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Check if this tab is marked as unavailable
                    if (button.classList.contains('tab-unavailable')) {
                        // Show the unavailability message
                        const reason = button.getAttribute('data-unavailable-reason');
                        showUnavailableContentPopup(button.id, reason);
                        return false; // Stop processing
                    }
                    
                    // Normal tab switching behavior for available tabs
                    // Remove active class from all tabs and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button
                    button.classList.add('active');
                    
                    // Get the corresponding content ID and make it active
                    const contentId = button.id.replace('tab-', 'content-');
                    const contentElement = document.getElementById(contentId);
                    
                    if (contentElement) {
                        contentElement.classList.add('active');
                    } else {
                        console.error(`Tab content element with ID "${contentId}" not found`);
                    }
                    
                    // Special handling for the flood map tab
                    if (button.id === 'tab-floodmap') {
                        // Trigger a resize event to make sure the map renders correctly
                        setTimeout(() => {
                            window.dispatchEvent(new Event('resize'));
                            if (floodMap) {
                                floodMap.invalidateSize();
                            }
                        }, 100);
                    }
                });
            });
        }
        
        // Update the clock
        function updateClock() {
            const now = new Date();
            const options = { 
                weekday: 'short',
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            };
            clockElement.textContent = now.toLocaleTimeString('en-AU', options);
        }

        // Refresh the webcam image
        function refreshWebcam() {
            // Add timestamp parameter to prevent caching
            const timestamp = new Date().getTime();
            webcamImage.src = `https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/bruxner_highway_lismore.jpeg?t=${timestamp}`;
            webcamTimestamp.textContent = new Date().toLocaleTimeString('en-AU');
        }

        // Check data source statuses
        function checkDataSources() {
            // Reset status indicators
            proxyStatusValue.textContent = 'Checking...';
            proxyStatusValue.className = 'status-value';
            bomStatusValue.textContent = 'Checking...';
            bomStatusValue.className = 'status-value';
            webcamStatusValue.textContent = 'Checking...';
            webcamStatusValue.className = 'status-value';
            
            // Add new status indicator for radar
            const radarStatusValue = document.getElementById('radar-status-value') || 
                                    createStatusElement('radar-status', 'Radar Image');
            
            // Add status indicator for cyclone map
            const cycloneStatusValue = document.getElementById('cyclone-status-value') || 
                                      createStatusElement('cyclone-status', 'Cyclone Map');
            
            // Add status indicator for flood map
            const floodMapStatusValue = document.getElementById('floodmap-status-value') || 
                                      createStatusElement('floodmap-status', 'Flood Map');
            
            // Check proxy server
            fetch(PROXY_URL, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        proxyStatusValue.textContent = 'Online';
                        proxyStatusValue.className = 'status-value online';
                    } else {
                        proxyStatusValue.textContent = 'Error: ' + response.status;
                        proxyStatusValue.className = 'status-value offline';
                    }
                })
                .catch(error => {
                    proxyStatusValue.textContent = 'Offline';
                    proxyStatusValue.className = 'status-value offline';
                    console.error('Proxy server check failed:', error);
                });
            
            // Check BOM data
            fetch(PROXY_URL)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.length > 0) {
                        bomStatusValue.textContent = 'Updated: ' + new Date(data.timestamp).toLocaleTimeString('en-AU');
                        bomStatusValue.className = 'status-value online';
                    } else {
                        bomStatusValue.textContent = 'No Data Available';
                        bomStatusValue.className = 'status-value offline';
                    }
                })
                .catch(error => {
                    bomStatusValue.textContent = 'Connection Error';
                    bomStatusValue.className = 'status-value offline';
                    console.error('BOM data check failed:', error);
                });
            
            // Check webcam
            const img = new Image();
            img.onload = function() {
                webcamStatusValue.textContent = 'Online';
                webcamStatusValue.className = 'status-value online';
            };
            img.onerror = function() {
                webcamStatusValue.textContent = 'Offline';
                webcamStatusValue.className = 'status-value offline';
            };
            img.src = 'https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/bruxner_highway_lismore.jpeg?' + new Date().getTime();
            
            // Radar interactive functionality
            function initializeRadar() {
                // DOM elements
                const radarImage = document.getElementById('radar-image');
                const backgroundLayer = document.getElementById('background-layer');
                const topographyLayer = document.getElementById('topography-layer');
                const locationsLayer = document.getElementById('locations-layer');
                const rangeLayer = document.getElementById('range-layer');
                const loading = document.getElementById('loading');
                const timestamp = document.getElementById('timestamp');
                const frameCounter = document.getElementById('frame-counter');
                const progressBar = document.getElementById('progress-bar');
                const btnFirst = document.getElementById('btn-first');
                const btnLast = document.getElementById('btn-last');
                const btnPlay = document.getElementById('btn-play');
                const btnPause = document.getElementById('btn-pause');
                const btnPrev = document.getElementById('btn-prev');
                const btnNext = document.getElementById('btn-next');
                const refreshBtn = document.getElementById('refresh-btn');
                const speedSlider = document.getElementById('speed');
                const speedValue = document.getElementById('speed-value');
                const errorElement = document.getElementById('error');
                const lastUpdate = document.getElementById('last-update');
                
                // Layer toggle checkboxes - with null checks
                const topographyToggle = document.getElementById('topography-toggle');
                const locationsToggle = document.getElementById('locations-toggle');
                const rangeToggle = document.getElementById('range-toggle');
            
                // Variables
                const RADAR_ID = 'IDR282'; // Grafton 256km radar
                let radarImages = [];
                let currentFrame = 0;
                let isPlaying = false;
                let animationInterval;
                let animationDelay = 500; // milliseconds
                let animationRequestId = null; // Add this variable declaration
                let mapLayersLoaded = false;
                let preloadedImages = new Map(); // To store preloaded images
                
                // Function to format date in locale format
                function formatDate(dateString) {
                    try {
                        const date = new Date(dateString);
                        return date.toLocaleString(undefined, {
                            weekday: 'short',
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            timeZoneName: 'short'
                        });
                    } catch (e) {
                        console.error("Error formatting date:", e);
                        return dateString || "Unknown date";
                    }
                }
            
                // Function to preload an image and return a promise
                function preloadImage(url) {
                    // Check if already cached
                    if (preloadedImages.has(url)) {
                        return Promise.resolve(url);
                    }
                    
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = () => {
                            preloadedImages.set(url, img);
                            resolve(url);
                        };
                        img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
                        img.src = url;
                    });
                }
            
                // Function to load map layers
                async function loadMapLayers() {
                    if (!radarImage) {
                        console.error("Radar container elements not found. Aborting map layer loading.");
                        return;
                    }
                    
                    showLoading(true);
                    
                    try {
                        console.log('Loading map layers...');
                        
                        // Set default background color while waiting
                        const container = document.querySelector('.radar-container');
                        if (container) {
                            container.style.backgroundColor = '#99ccff';
                        }
                        
                        // Create the URLs
                        const bgUrl = `/map-proxy/${RADAR_ID}.background.png`;
                        const topoUrl = `/map-proxy/${RADAR_ID}.topography.png`;
                        const locUrl = `/map-proxy/${RADAR_ID}.locations.png`;
                        const rangeUrl = `/map-proxy/${RADAR_ID}.range.png`;
                        
                        console.log('Background URL:', bgUrl);
                        
                        // Safe image loading with null checks
                        const safeLoadImage = async (url, element, name) => {
                            if (!element) {
                                console.error(`${name} element not found.`);
                                return false;
                            }
                            
                            try {
                                await preloadImage(url);
                                element.src = url;
                                console.log(`${name} loaded successfully`);
                                return true;
                            } catch (err) {
                                console.error(`Failed to preload ${name}:`, err);
                                return false;
                            }
                        };
                        
                        // Preload the images with proper error handling
                        const results = await Promise.allSettled([
                            safeLoadImage(bgUrl, backgroundLayer, 'Background'),
                            safeLoadImage(topoUrl, topographyLayer, 'Topography'),
                            safeLoadImage(locUrl, locationsLayer, 'Locations'),
                            safeLoadImage(rangeUrl, rangeLayer, 'Range')
                        ]);
                        
                        // Check if at least the background loaded
                        const backgroundLoaded = results[0].status === 'fulfilled' && results[0].value;
                        
                        if (backgroundLoaded) {
                            mapLayersLoaded = true;
                            console.log('All map layers loaded successfully');
                        } else {
                            showError('Failed to load essential map layers. Using simplified display.');
                        }
                        
                    } catch (error) {
                        console.error('Error loading map layers:', error);
                        showError('Failed to load map layers. Using simplified display.');
                    } finally {
                        showLoading(false);
                    }
                }
            
                // Function to fetch radar data
                async function fetchRadarData() {
                    try {
                        showLoading(true);
                        hideError();
                        
                        const response = await fetch(`/api/radar/${RADAR_ID}`);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch radar data: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.images || data.images.length === 0) {
                            throw new Error('No radar images available');
                        }
                        
                        // Store the radar images and reset to first frame
                        radarImages = data.images;
                        currentFrame = 0;
                        
                        // Set last update time
                        if (lastUpdate) {
                            lastUpdate.textContent = `Last updated: ${formatDate(data.lastUpdated)}`;
                        }
                        
                        // Preload all radar images in the background
                        preloadAllImages();
                        
                        // Update the displayed image
                        updateRadarImage(0);
                        enableControls(true);
                        
                        console.log(`Loaded ${radarImages.length} radar images`);
                    } catch (error) {
                        console.error('Error loading radar data:', error);
                        showError(error.message);
                        enableControls(false);
                    } finally {
                        showLoading(false);
                    }
                }
                
                // Modify the preloadAllImages function to return a promise that resolves when all images are loaded
                async function preloadAllImages() {
                  if (!radarImages || radarImages.length === 0) return;
                  
                  console.log('Preloading all radar images for smooth playback...');
                  
                  // Create an array of promises to preload all images
                  const preloadPromises = radarImages.map(image => 
                    new Promise((resolve, reject) => {
                      const img = new Image();
                      img.onload = () => {
                        preloadedImages.set(image.url, img);
                        resolve(image.url);
                      };
                      img.onerror = () => {
                        console.warn(`Failed to preload: ${image.url}`);
                        resolve(null); // Resolve anyway so we don't block other images
                      };
                      img.src = image.url;
                    })
                  );
                  
                  // Wait for all images to be preloaded
                  try {
                    await Promise.all(preloadPromises);
                    console.log('All radar images preloaded successfully');
                    return true;
                  } catch (err) {
                    console.error('Error during image preloading:', err);
                    return false;
                  }
                }
            
                // Function to update the radar image
                function updateRadarImage(frameIndex) {
                    if (!radarImages || radarImages.length === 0 || !radarImage) return;
                    
                    if (frameIndex >= 0 && frameIndex < radarImages.length) {
                        currentFrame = frameIndex;
                        
                        if (radarImages[frameIndex] && radarImages[frameIndex].url) {
                            // Update the image
                            radarImage.src = radarImages[frameIndex].url;
                            
                            // Update the timestamp
                            if (timestamp) {
                                timestamp.textContent = formatDate(radarImages[frameIndex].timestamp);
                            }
                            
                            // Update the frame counter
                            if (frameCounter) {
                                frameCounter.textContent = `Frame ${currentFrame + 1} of ${radarImages.length}`;
                            }
                            
                            // Update progress bar
                            if (progressBar) {
                                const progress = ((currentFrame + 1) / radarImages.length) * 100;
                                progressBar.style.width = `${progress}%`;
                            }
                        } else {
                            console.error(`Invalid image data at index ${frameIndex}`);
                        }
                    }
                }
            
                function playAnimation() {
                  if (!radarImages || radarImages.length === 0) return;
                  
                  isPlaying = true;
                  if (btnPlay) btnPlay.disabled = true;
                  if (btnPause) btnPause.disabled = false;
                  
                  // Clear any existing interval and animation frame
                  clearTimeout(animationInterval);
                  if (animationRequestId) {
                    cancelAnimationFrame(animationRequestId);
                  }
                  
                  // Define the animation frame function with better timing control
                  const nextFrame = () => {
                    // Calculate next frame index
                    const nextIndex = (currentFrame + 1) % radarImages.length;
                    
                    // Update the displayed image
                    updateRadarImage(nextIndex);
                    
                    // Schedule the next frame using setTimeout
                    animationInterval = setTimeout(() => {
                      // Use requestAnimationFrame for smoother animation
                      animationRequestId = requestAnimationFrame(nextFrame);
                    }, animationDelay);
                  };
                  
                  // Start the animation loop
                  nextFrame();
                }
            
                function pauseAnimation() {
                  isPlaying = false;
                  if (btnPlay) btnPlay.disabled = false;
                  if (btnPause) btnPause.disabled = true;
                  
                  clearTimeout(animationInterval);
                  if (animationRequestId) {
                    cancelAnimationFrame(animationRequestId);
                    animationRequestId = null;
                  }
                }
            
                function prevFrame() {
                    if (!radarImages || radarImages.length === 0) return;
                    
                    pauseAnimation();
                    currentFrame = (currentFrame - 1 + radarImages.length) % radarImages.length;
                    updateRadarImage(currentFrame);
                }
            
                function nextFrame() {
                    if (!radarImages || radarImages.length === 0) return;
                    
                    pauseAnimation();
                    currentFrame = (currentFrame + 1) % radarImages.length;
                    updateRadarImage(currentFrame);
                }
                
                function firstFrame() {
                    if (!radarImages || radarImages.length === 0) return;
                    
                    pauseAnimation();
                    currentFrame = 0;
                    updateRadarImage(currentFrame);
                }
                
                function lastFrame() {
                    if (!radarImages || radarImages.length === 0) return;
                    
                    pauseAnimation();
                    currentFrame = radarImages.length - 1;
                    updateRadarImage(currentFrame);
                }
            
                // Utility functions
                function showLoading(show) {
                    if (loading) {
                        loading.style.display = show ? 'flex' : 'none';
                    }
                }
            
                function showError(message) {
                    if (errorElement) {
                        errorElement.textContent = message;
                        errorElement.style.display = 'block';
                    }
                }
            
                function hideError() {
                    if (errorElement) {
                        errorElement.style.display = 'none';
                    }
                }
            
                function enableControls(enable) {
                    // Safely enable/disable controls with null checks
                    const safeDisable = (button, isDisabled) => {
                        if (button) button.disabled = isDisabled;
                    };
                    
                    safeDisable(btnPlay, !enable || isPlaying);
                    safeDisable(btnPause, !enable || !isPlaying);
                    safeDisable(btnPrev, !enable);
                    safeDisable(btnNext, !enable);
                    safeDisable(btnFirst, !enable);
                    safeDisable(btnLast, !enable);
                    
                    if (speedSlider) speedSlider.disabled = !enable;
                }
            
                // Layer toggle functions
                function updateLayerVisibility() {
                    // Use safe checks before updating visibility
                    if (topographyLayer && topographyToggle) {
                        topographyLayer.style.display = topographyToggle.checked ? 'block' : 'none';
                    }
                    
                    if (locationsLayer && locationsToggle) {
                        locationsLayer.style.display = locationsToggle.checked ? 'block' : 'none';
                    }
                    
                    if (rangeLayer && rangeToggle) {
                        rangeLayer.style.display = rangeToggle.checked ? 'block' : 'none';
                    }
                }
                
                // Refresh function
                function refreshData() {
                    // Clear current data
                    radarImages = [];
                    currentFrame = 0;
                    pauseAnimation();
                    enableControls(false);
                    preloadedImages.clear();
                    
                    // Reset UI elements
                    if (timestamp) timestamp.textContent = 'Refreshing data...';
                    if (frameCounter) frameCounter.textContent = '';
                    if (progressBar) progressBar.style.width = '0%';
                    
                    // Fetch fresh data
                    fetchRadarData();
                }
            
                // Set up event listeners (with null checks)
                function setupEventListeners() {
                    if (btnPlay) btnPlay.addEventListener('click', playAnimation);
                    if (btnPause) btnPause.addEventListener('click', pauseAnimation);
                    if (btnPrev) btnPrev.addEventListener('click', prevFrame);
                    if (btnNext) btnNext.addEventListener('click', nextFrame);
                    if (btnFirst) btnFirst.addEventListener('click', firstFrame);
                    if (btnLast) btnLast.addEventListener('click', lastFrame);
                    if (refreshBtn) refreshBtn.addEventListener('click', refreshData);
                    
                    // Keyboard shortcuts - only when radar tab is active
                    document.addEventListener('keydown', function(e) {
                        const radarTab = document.getElementById('content-radar');
                        if (!radarTab || !radarTab.classList.contains('active')) return;
                        
                        if (!radarImages || radarImages.length === 0) return;
                        
                        switch(e.key) {
                            case ' ': // Space bar
                                if (isPlaying) {
                                    pauseAnimation();
                                } else {
                                    playAnimation();
                                }
                                break;
                            case 'ArrowLeft':
                                prevFrame();
                                break;
                            case 'ArrowRight':
                                nextFrame();
                                break;
                            case 'Home':
                                firstFrame();
                                break;
                            case 'End':
                                lastFrame();
                                break;
                        }
                    });
                    
                    // Speed slider handling
                    if (speedSlider) {
                        speedSlider.addEventListener('input', function() {
                            const speed = parseInt(this.value);
                            animationDelay = 1100 - (speed * 100); // 100ms to 1000ms range
                            
                            if (speedValue) {
                                speedValue.textContent = `${animationDelay}ms`;
                            }
                            
                            if (isPlaying) {
                                pauseAnimation();
                                playAnimation();
                            }
                        });
                    }
                    
                    // Layer toggle listeners
                    if (topographyToggle) {
                        topographyToggle.addEventListener('change', updateLayerVisibility);
                    }
                    
                    if (locationsToggle) {
                        locationsToggle.addEventListener('change', updateLayerVisibility);
                    }
                    
                    if (rangeToggle) {
                        rangeToggle.addEventListener('change', updateLayerVisibility);
                    }
                    
                    // Handle image load errors properly
                    if (radarImage) {
                        radarImage.addEventListener('error', function(e) {
                            // Only show error for real images, not the empty placeholder
                            if (this.src && this.src !== 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7') {
                                console.error(`Failed to load radar image: ${this.src}`);
                                showError('Failed to load radar image. Using cached version if available.');
                            }
                        });
                    }
                }
            
                // Initialize the radar
                function initialize() {
                    // Check if elements exist before initializing
                    if (!radarImage) {
                        console.error("Radar elements not found. Cannot initialize radar.");
                        return;
                    }
                    
                    // Set up event listeners
                    setupEventListeners();
                    
                    // Load the map layers first
                    loadMapLayers().then(() => {
                        // Then fetch the radar data
                        fetchRadarData();
                        
                        // Set initial layer visibility
                        updateLayerVisibility();
                    }).catch(err => {
                        console.error("Error initializing radar:", err);
                        showError("Failed to initialize radar. Try refreshing the page.");
                    });
                }
                
                // Handle tab changes to ensure proper initialization
                function handleTabChange() {
                    // Get all tab buttons
                    const tabButtons = document.querySelectorAll('.tab-button');
                    
                    if (!tabButtons || tabButtons.length === 0) {
                        // No tabs, just initialize directly
                        initialize();
                        return;
                    }
                    
                    // Add event listeners to all tab buttons
                    tabButtons.forEach(button => {
                        if (button) {
                            button.addEventListener('click', function() {
                                // Check if this is the radar tab and we haven't loaded the layers yet
                                if (this.id === 'tab-radar' && !mapLayersLoaded) {
                                    // Initialize when the radar tab is selected for the first time
                                    initialize();
                                }
                            });
                        }
                    });
                    
                    // Check if the radar tab is active by default
                    const radarTab = document.getElementById('tab-radar');
                    const radarContent = document.getElementById('content-radar');
                    
                    if (radarTab && radarContent && radarContent.classList.contains('active')) {
                        // If radar tab is active on page load, initialize immediately
                        initialize();
                    }
                }
                
                // Call the initialization setup
                handleTabChange();
                
                // Set up auto-refresh
                if (document.getElementById('content-radar')) {
                    // Auto-refresh every 5 minutes if the tab is active
                    setInterval(() => {
                        const radarContent = document.getElementById('content-radar');
                        if (radarContent && radarContent.classList.contains('active')) {
                            refreshData();
                        }
                    }, 5 * 60 * 1000);
                }
            }
            
            // Make sure to initialize the radar when the page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    // Check if we're on a page with the radar tab
                    if (document.getElementById('content-radar')) {
                        initializeRadar();
                    }
                });
            } else {
                // Document already loaded
                if (document.getElementById('content-radar')) {
                    initializeRadar();
                }
            }
            
            // Check cyclone map
            const cycloneImg = new Image();
            cycloneImg.onload = function() {
                cycloneStatusValue.textContent = 'Online';
                cycloneStatusValue.className = 'status-value online';
            };
            cycloneImg.onerror = function() {
                cycloneStatusValue.textContent = 'Offline';
                cycloneStatusValue.className = 'status-value offline';
            };
            cycloneImg.src = 'http://www.bom.gov.au/fwo/IDQ65001.png?' + new Date().getTime();
            
            // Check flood map data
            if (floodMapInitialized) {
                floodMapStatusValue.textContent = 'Online';
                floodMapStatusValue.className = 'status-value online';
            } else {
                floodMapStatusValue.textContent = 'Initializing...';
                floodMapStatusValue.className = 'status-value unknown';
            }
        }

        // Update the refresh interval for flood data
        function updateRefreshInterval() {
            const interval = parseInt(refreshIntervalSelect.value);
            
            // Clear existing timer
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            // Set up new timer
            refreshTimer = setInterval(fetchFloodData, interval);
            
            // Show notification
            const minutes = interval / 60000;
            showNotification(`Data will refresh every ${minutes} ${minutes === 1 ? 'minute' : 'minutes'}`, 'info');
        }

        // Fetch flood data using the proxy server
                // Fetch flood data using the proxy server
        async function fetchFloodData() {
            showLoading(true);
            
            // Store the previous Lismore level to check if it's changed
            const previousLismoreLevel = currentLismoreLevel;
            
            try {
                // Fetch data from our proxy server
                const response = await fetch(PROXY_URL);
                
                if (!response.ok) {
                    throw new Error(`Proxy server error: ${response.status}`);
                }
                
                const jsonData = await response.json();
                
                if (jsonData.success && jsonData.data && jsonData.data.length > 0) {
                    floodData = jsonData.data;
                    
                    // Update last fetch time
                    lastFetchTime = new Date();
                    lastUpdateTime.textContent = lastFetchTime.toLocaleTimeString('en-AU') + ' (live data)';
                    
                    // Show success notification
                    showNotification('Live flood data updated successfully', 'success');
                } else {
                    throw new Error('No flood data returned from proxy');
                }
                
                // Cache the data
                cacheFloodData();
                
                // Render the data
                renderFloodData();
                
                // Update statistics
                updateStatistics();
                
                // Check if the current Lismore level has changed significantly
                const levelChanged = (
                    previousLismoreLevel !== null && 
                    currentLismoreLevel !== null && 
                    Math.abs(previousLismoreLevel - currentLismoreLevel) > 0.1 // 10cm change threshold
                );
                
                // If level changed significantly and user hasn't made a selection, notify them
                if (levelChanged && userSelectedFloodHeight === null) {
                    showNotification(`Flood level has changed to ${currentLismoreLevel.toFixed(2)}m. Map updated.`, 'info');
                }
                
                // Get current Lismore level and update the flood map's default height, respecting user choices
                updateFloodMapWithCurrentLevelRespectingUserChoice();
                
            } catch (error) {
                console.error('Error fetching flood data:', error);
                
                // Show error notification
                showNotification('Error fetching live data. Using cached data if available.', 'error');
                
                // If we have cached data, use it
                if (floodData.length === 0) {
                    const loaded = loadCachedData();
                    if (!loaded) {
                        // If no cached data, show a critical error
                        showNotification('CRITICAL: No flood data available. Please contact emergency services.', 'error');
                    }
                }
            } finally {
                showLoading(false);
            }
        }

        // Render the flood data in the table
        function renderFloodData() {
            if (!floodData || floodData.length === 0) {
                floodDataBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No data available</td></tr>';
                return;
            }
            
            // Remove duplicate entries by location
            const uniqueLocations = {};
            floodData.forEach(item => {
                // Only keep the most recent data for each location
                if (!uniqueLocations[item.location] || 
                    new Date(item.time) > new Date(uniqueLocations[item.location].time)) {
                    uniqueLocations[item.location] = item;
                }
            });
            
            // Convert back to array
            const uniqueData = Object.values(uniqueLocations);
            
            // Filter data if showing critical only - use specific location list
            const criticalLocations = [
                'Wilsons R at Woodlawn (mAHD)',
                'Browns Ck Pump Station',
                'Lismore (Dawson Street)',
                'Wilsons R at Lismore (mAHD)',
                'Leycester Ck at Tuncester (mAHD)',
                'Leycester Ck at South Lismore'
            ];
            
            const dataToShow = showingCriticalOnly 
                ? uniqueData.filter(item => criticalLocations.includes(item.location))
                : uniqueData;
            
            // Group data by river system
            const groupedData = {};
            
            dataToShow.forEach(item => {
                let riverSystem = 'Other';
                
                if (item.location.includes('Wilsons')) {
                    riverSystem = 'Wilsons River';
                } else if (item.location.includes('Richmond')) {
                    riverSystem = 'Richmond River';
                } else if (item.location.includes('Tweed')) {
                    riverSystem = 'Tweed River';
                } else if (item.location.includes('Brunswick')) {
                    riverSystem = 'Brunswick River';
                } else if (item.location.includes('Clarence')) {
                    riverSystem = 'Clarence River';
                } else if (item.location.includes('Evans')) {
                    riverSystem = 'Evans River';
                } else if (item.location.includes('Leycester')) {
                    riverSystem = 'Wilsons River Tributaries';
                } else if (item.location.includes('Terania') || 
                          item.location.includes('Coopers') || 
                          item.location.includes('Goolmangar') ||
                          item.location.includes('Mulgum') ||
                          item.location.includes('Back Ck')) {
                    riverSystem = 'Wilsons River Tributaries';
                } else if (item.location.includes('Lismore') ||
                          item.location.includes('Browns Ck')) {
                    riverSystem = 'Wilsons River';
                }
                
                if (!groupedData[riverSystem]) {
                    groupedData[riverSystem] = [];
                }
                
                groupedData[riverSystem].push(item);
            });
            
            // Sort river systems alphabetically, but with Wilsons River and Wilsons River Tributaries first
            const sortedRiverSystems = Object.keys(groupedData).sort((a, b) => {
                if (a.includes('Wilsons') && !b.includes('Wilsons')) return -1;
                if (!a.includes('Wilsons') && b.includes('Wilsons')) return 1;
                return a.localeCompare(b);
            });
            
            let html = '';
            
            // Render table with section headers for each river system
            sortedRiverSystems.forEach(riverSystem => {
                // Add section header
                html += `
                    <tr class="river-system-header">
                        <td colspan="5">${riverSystem}</td>
                    </tr>
                `;
                
                // Add data rows for this river system
                groupedData[riverSystem].forEach(item => {
                    // Determine row class based on flood category
                    let rowClass = '';
                    if (item.floodCategory === 'Minor') {
                        rowClass = 'minor-flood';
                    } else if (item.floodCategory === 'Moderate') {
                        rowClass = 'moderate-flood';
                    } else if (item.floodCategory === 'Major') {
                        rowClass = 'major-flood';
                    }
                    
                    // Determine status class
                    let statusClass = '';
                    if (item.status === 'rising') {
                        statusClass = 'rising';
                    } else if (item.status === 'falling') {
                        statusClass = 'falling';
                    } else if (item.status === 'steady') {
                        statusClass = 'steady';
                    }
                    
                    // When creating each row
                    html += `
                      <tr class="${rowClass}" style="cursor: pointer;" title="Click to view height history">
                        <td>${item.location}</td>
                        <td>${item.time}</td>
                        <td>${item.waterLevel !== null ? item.waterLevel.toFixed(2) + 'm' : 'N/A'}</td>
                        <td class="${statusClass}">${item.status}</td>
                        <td>${item.floodCategory === 'N/A' ? '-' : item.floodCategory}</td>
                      </tr>
                    `;
                });
            });
            
            if (html === '') {
                html = '<tr><td colspan="5" style="text-align: center;">No locations found</td></tr>';
            }
            
            floodDataBody.innerHTML = html;
        }

            // Update statistics panel
            function updateStatistics() {
                if (!floodData || floodData.length === 0) return;
                
                // Find Lismore data - specifically "Wilsons R at Lismore (mAHD)" as first choice
                const lismoreData = floodData.find(item => 
                    item.location === 'Wilsons R at Lismore (mAHD)') ||
                    floodData.find(item => 
                    item.location.toLowerCase().includes('lismore'));
                
                // Update Lismore level and status
                if (lismoreData) {
                    // Store current Lismore level for use with flood map
                    currentLismoreLevel = lismoreData.waterLevel;
                    
                    lismoreLevel.textContent = lismoreData.waterLevel !== null 
                        ? lismoreData.waterLevel.toFixed(2) + 'm' 
                        : 'N/A';
                    
                    lismoreStatus.textContent = capitalizeFirstLetter(lismoreData.status);
                    
                    // Add status class
                    lismoreStatus.className = 'stat-footer';
                    if (lismoreData.status === 'rising') {
                        lismoreStatus.classList.add('rising');
                    } else if (lismoreData.status === 'falling') {
                        lismoreStatus.classList.add('falling');
                    } else if (lismoreData.status === 'steady') {
                        lismoreStatus.classList.add('steady');
                    }
                    
                    // Check if water level is approaching levee height (9.5m or higher)
                    const LEVEE_APPROACH_WARNING = 9.5;
                    const statsPanel = document.getElementById('stats-container').closest('.panel');
                    
                    // Remove existing warning if present
                    const existingWarning = document.getElementById('levee-warning-panel');
                    if (existingWarning) {
                        existingWarning.remove();
                    }
                    
                    // Add warning panel if water level is approaching levee height
                    if (lismoreData.waterLevel >= LEVEE_APPROACH_WARNING) {
                        const warningPanel = document.createElement('div');
                        warningPanel.id = 'levee-warning-panel';
                        warningPanel.className = 'panel-alert';
                        warningPanel.style.backgroundColor = '#fff3cd';
                        warningPanel.style.color = '#856404';
                        warningPanel.style.border = '1px solid #ffeeba';
                        warningPanel.style.marginBottom = '1rem';
                        warningPanel.style.display = 'flex';
                        warningPanel.style.alignItems = 'center';
                        warningPanel.style.gap = '0.5rem';
                        warningPanel.style.padding = '0.75rem 1rem';
                        warningPanel.style.borderRadius = 'var(--border-radius)';
                        warningPanel.style.fontWeight = '500';
                        
                        warningPanel.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <span>WARNING: Wilsons River at Lismore (${lismoreData.waterLevel.toFixed(2)}m) is approaching levee protection height (10.6m)</span>
                        `;
                        
                        // Insert warning above the stats panel
                        statsPanel.parentNode.insertBefore(warningPanel, statsPanel);
                    }
                }
                
                // Define critical locations for highest reading calculation
                const criticalLocations = [
                    'Wilsons R at Woodlawn (mAHD)',
                    'Browns Ck Pump Station',
                    'Lismore (Dawson Street)',
                    'Wilsons R at Lismore (mAHD)',
                    'Leycester Ck at Tuncester (mAHD)',
                    'Leycester Ck at South Lismore'
                ];
                
                // Find highest reading only from critical locations
                let highest = null;
                floodData
                    .filter(item => criticalLocations.includes(item.location))
                    .forEach(item => {
                        if (item.waterLevel !== null && (highest === null || item.waterLevel > highest.waterLevel)) {
                            highest = item;
                        }
                    });
                
                // Update highest reading
                if (highest) {
                    highestReading.textContent = highest.waterLevel.toFixed(2) + 'm';
                    highestLocation.textContent = highest.location;
                }
                
                // Count rising and falling locations
                const rising = floodData.filter(item => item.status === 'rising').length;
                const falling = floodData.filter(item => item.status === 'falling').length;
                
                risingCount.textContent = rising;
                fallingCount.textContent = falling;
                
                // Highlight rising count if there are many rising locations
                if (rising > 0 && rising > falling) {
                    risingCount.parentElement.classList.add('critical');
                } else {
                    risingCount.parentElement.classList.remove('critical');
                }
            } // Only one closing brace here

            // Direct test function to force the warning panel
            function forceWarningPanel() {
                // Get the stats panel
                const statsPanel = document.getElementById('stats-container').closest('.panel');
                
                // Remove any existing warning
                const existingWarning = document.getElementById('levee-warning-panel');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                // Create warning panel
                const warningPanel = document.createElement('div');
                warningPanel.id = 'levee-warning-panel';
                warningPanel.className = 'panel-alert';
                warningPanel.style.backgroundColor = '#fff3cd';
                warningPanel.style.color = '#856404';
                warningPanel.style.border = '1px solid #ffeeba';
                warningPanel.style.marginBottom = '1rem';
                warningPanel.style.display = 'flex';
                warningPanel.style.alignItems = 'center';
                warningPanel.style.gap = '0.5rem';
                warningPanel.style.padding = '0.75rem 1rem';
                warningPanel.style.borderRadius = '8px';
                warningPanel.style.fontWeight = '500';
                
                warningPanel.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span>WARNING: Wilsons River at Lismore (9.50m) is approaching levee protection height (10.6m)</span>
                `;
                
                // Insert warning above the stats panel
                if (statsPanel && statsPanel.parentNode) {
                    statsPanel.parentNode.insertBefore(warningPanel, statsPanel);
                    console.log('Warning panel added successfully');
                } else {
                    console.error('Could not find stats panel to add warning');
                }
            }

            // Enhanced console welcome message with dark mode support
            function displayConsoleWelcome() {
                // Define styles with improved dark mode compatibility
                const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                const styles = {
                    title: `
                        font-size: 24px; 
                        font-weight: bold; 
                        color: ${isDarkMode ? '#4fc3f7' : '#1e88e5'}; 
                        text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
                        background: ${isDarkMode ? 'linear-gradient(45deg, #2c3e50, #34495e)' : 'linear-gradient(45deg, #e3f2fd, #bbdefb)'};
                        padding: 10px;
                        border-radius: 5px;
                    `,
                    subtitle: `
                        font-size: 16px; 
                        font-weight: bold; 
                        color: ${isDarkMode ? '#81d4fa' : '#333'};
                    `,
                    category: `
                        font-size: 14px; 
                        font-weight: bold; 
                        color: ${isDarkMode ? '#29b6f6' : '#1976d2'}; 
                        margin-top: 10px;
                        border-bottom: 1px solid ${isDarkMode ? '#37474f' : '#e0e0e0'};
                        padding-bottom: 5px;
                    `,
                    command: `
                        background-color: ${isDarkMode ? '#37474f' : '#f5f5f5'}; 
                        padding: 2px 5px; 
                        border-radius: 3px; 
                        font-family: monospace; 
                        color: ${isDarkMode ? '#80deea' : '#e91e63'};
                        border: 1px solid ${isDarkMode ? '#455a64' : '#e0e0e0'};
                    `,
                    description: `
                        color: ${isDarkMode ? '#b0bec5' : '#555'};
                    `,
                    warning: `
                        color: ${isDarkMode ? '#ef5350' : '#e53935'}; 
                        font-weight: bold;
                        background-color: ${isDarkMode ? 'rgba(239, 83, 80, 0.1)' : 'transparent'};
                        padding: 5px;
                        border-radius: 3px;
                    `,
                    success: `
                        color: ${isDarkMode ? '#81c784' : '#43a047'};
                        font-style: italic;
                    `,
                    footer: `
                        font-size: 13px; 
                        font-style: italic; 
                        color: ${isDarkMode ? '#90a4ae' : '#777'};
                    `
                };
            
                // Clear console for clean output
                console.clear();
            
                // Title and subtitle with emojis and playful tone
                console.log('%cLismore Flood Emergency Dashboard - Console Commands', styles.title);
                console.log('%c Developer Console: Flood Management Simulation ', styles.subtitle);
                
                // Structured console output with categories
                const categories = [
                    {
                        name: 'EMERGENCY SIMULATION',
                        commands: [
                            { cmd: 'forceWarningPanel()', desc: 'Show levee warning panel' },
                            { cmd: "document.getElementById('levee-warning-panel')?.remove()", desc: 'Remove warning panel' },
                            { cmd: "showNotification('EMERGENCY ALERT: Evacuate immediately!', 'error')", desc: 'Show emergency alert' }
                        ]
                    },
                    {
                        name: 'RIVER LEVEL CONTROLS',
                        commands: [
                            { cmd: "document.getElementById('lismore-level').textContent = '9.80m'", desc: 'Set Lismore level display' },
                            { cmd: "document.getElementById('lismore-status').textContent = 'Rising'; document.getElementById('lismore-status').className = 'stat-footer rising'", desc: 'Show rising status' }
                        ]
                    },
                    {
                        name: 'VISUAL EFFECTS',
                        commands: [
                            { cmd: "document.body.style.filter = 'invert(0.9) hue-rotate(180deg)'", desc: 'Toggle night mode' },
                            { cmd: 'location.reload()', desc: 'Reset all customizations' }
                        ]
                    },
                    {
                        name: 'DATA REFRESH',
                        commands: [
                            { cmd: 'fetchFloodData()', desc: 'Refresh all flood data' },
                            { cmd: 'refreshWebcam(); refreshRadar(); refreshCycloneMap()', desc: 'Refresh all imagery' }
                        ]
                    },
                    {
                        name: 'NETWORK SIMULATION',
                        commands: [
                            { cmd: "document.querySelectorAll('.status-value').forEach(el => { el.textContent = 'Offline'; el.className = 'status-value offline'; })", desc: 'Simulate outage' }
                        ]
                    },
                    {
                        name: 'HIGHLIGHTING',
                        commands: [
                            { cmd: "Array.from(document.querySelectorAll('#flood-data-body tr')).forEach(row => { const levelCell = row.querySelector('td:nth-child(3)'); if (levelCell && parseFloat(levelCell.textContent) > 8) { row.style.backgroundColor = 'rgba(255, 0, 0, 0.1)'; } })", desc: 'Highlight high levels' }
                        ]
                    },
                    {
                        name: 'RESPONSIVE TESTING',
                        commands: [
                            { cmd: "const mobileView = window.matchMedia('(max-width: 768px)'); if (!mobileView.matches) { document.body.style.width = '480px'; document.body.style.margin = 'auto'; }", desc: 'Test mobile view' }
                        ]
                    }
                ];
            
                // Print categories and commands
                categories.forEach(category => {
                    console.log('%c' + category.name + ':', styles.category);
                    category.commands.forEach(cmd => {
                        console.log(
                            `%c${cmd.cmd}%c - ${cmd.desc}`, 
                            styles.command, 
                            styles.description
                        );
                    });
                    console.log(''); // Add a blank line between categories
                });
            
                // Footer with warnings and tips
                console.log('%c TIP: Copy and paste any command to experiment!', styles.success);
                console.log('%c WARNING: These commands are for testing only - proceed with caution!', styles.warning);
                console.log('%cRemember: With great power comes great responsibility... ', styles.footer);
            
                // Add event listener for dark mode changes
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addListener(displayConsoleWelcome);
                }
            }
            
            // Call this function when the page loads
            displayConsoleWelcome();

        // Cache flood data in localStorage
        function cacheFloodData() {
            try {
                const cacheData = {
                    timestamp: new Date().getTime(),
                    data: floodData
                };
                
                localStorage.setItem('lismoreFloodData', JSON.stringify(cacheData));
            } catch (error) {
                console.error('Error caching flood data:', error);
            }
        }

        // Load cached data from localStorage
        function loadCachedData() {
            try {
                const cachedData = localStorage.getItem('lismoreFloodData');
                
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    
                    if (parsed && parsed.data && parsed.data.length > 0) {
                        floodData = parsed.data;
                        
                        // Update last fetch time
                        lastFetchTime = new Date(parsed.timestamp);
                        lastUpdateTime.textContent = lastFetchTime.toLocaleTimeString('en-AU') + ' (cached)';
                        
                        // Render the data
                        renderFloodData();
                        
                        // Update statistics
                        updateStatistics();
                        
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error loading cached data:', error);
                return false;
            }
        }
        
        // Helper function to create status elements
        function createStatusElement(id, label) {
            const statusPanel = document.querySelector('.status-panel');
            
            // Create new status item
            const statusItem = document.createElement('div');
            statusItem.id = id;
            statusItem.className = 'status-item';
            
            // Create label
            const statusLabel = document.createElement('span');
            statusLabel.className = 'status-label';
            statusLabel.textContent = label + ':';
            
            // Create value
            const statusValue = document.createElement('span');
            statusValue.id = id + '-value';
            statusValue.className = 'status-value';
            statusValue.textContent = 'Checking...';
            
            // Add to status item
            statusItem.appendChild(statusLabel);
            statusItem.appendChild(statusValue);
            
            // Add before the status actions
            const statusActions = document.querySelector('.status-actions');
            statusPanel.insertBefore(statusItem, statusActions);
            
            return statusValue;
        }

        // Show loading overlay
        function showLoading(show) {
            if (show) {
                loadingOverlay.style.display = 'flex';
            } else {
                loadingOverlay.style.display = 'none';
            }
        }

        // Show notification
        function showNotification(message, type) {
            notificationMessage.textContent = message;
            
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Handle page visibility changes to conserve resources
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, pause the webcam refresh to save resources
                clearInterval(webcamRefreshTimer);
            } else {
                // Page is visible again, resume webcam refresh
                refreshWebcam();
                webcamRefreshTimer = setInterval(refreshWebcam, WEBCAM_REFRESH_INTERVAL);
            }
        });

        // Handle errors on webcam load
        webcamImage.addEventListener('error', function() {
            webcamError.style.display = 'block';
        });

        webcamImage.addEventListener('load', function() {
            webcamError.style.display = 'none';
        });
        
            // Refresh radar image (compatible with both old and new implementations)
            function refreshRadar() {
                // Check if we're using the new interactive radar
                if (window.initializeRadar) {
                    // New radar is handled by its own code
                    const refreshBtn = document.getElementById('refresh-btn');
                    if (refreshBtn) {
                        // Trigger a click on the refresh button
                        refreshBtn.click();
                    }
                    return;
                }
            
                // Legacy radar code for backward compatibility
                const radarImage = document.getElementById('radar-image');
                const radarError = document.getElementById('radar-error');
                const radarTimestamp = document.getElementById('radar-timestamp');
                
                // Only proceed if elements exist
                if (radarImage) {
                    // Add timestamp parameter to prevent caching
                    const timestamp = new Date().getTime();
                    radarImage.src = `http://www.bom.gov.au/radar/IDR282.gif?t=${timestamp}`;
                    
                    // Update timestamp if element exists
                    if (radarTimestamp) {
                        radarTimestamp.textContent = `Last updated: ${new Date().toLocaleTimeString('en-AU')}`;
                    }
                    
                    // Handle errors if element exists
                    if (radarError) {
                        radarImage.onerror = function() {
                            radarError.style.display = 'block';
                        };
                        
                        // Safer version with null check
                        radarImg.onload = function() {
                            if (document.getElementById('radar-error')) {
                                document.getElementById('radar-error').style.display = 'none';
                            }
                        };
                    }
                }
            }
        
        function checkRadarStatus() {
            // Get all possible radar-related elements
            const radarImg = document.getElementById('radar-image');
            const radarError = document.getElementById('radar-error');
            const radarStatusValue = document.getElementById('radar-status-value');
            
            // Create a new image element for testing
            const radarTestImg = new Image();
            
            // Set up success/failure handlers with null safety
            radarTestImg.onload = function() {
                if (radarStatusValue) radarStatusValue.textContent = 'Online';
                if (radarStatusValue) radarStatusValue.className = 'status-value online';
                if (radarError) radarError.style.display = 'none';
            };
            
            radarTestImg.onerror = function() {
                if (radarStatusValue) radarStatusValue.textContent = 'Offline';
                if (radarStatusValue) radarStatusValue.className = 'status-value offline';
                if (radarError) radarError.style.display = 'block';
            };
            
            // Add timestamp to prevent caching
            radarTestImg.src = `http://www.bom.gov.au/radar/IDR282.gif?t=${new Date().getTime()}`;
        }

        // Refresh the cyclone map
        function refreshCycloneMap() {
            const cycloneImage = document.getElementById('cyclone-image');
            const cycloneError = document.getElementById('cyclone-error');
            const cycloneTimestamp = document.getElementById('cyclone-timestamp');
            
            // Add timestamp parameter to prevent caching
            const timestamp = new Date().getTime();
            cycloneImage.src = `http://www.bom.gov.au/fwo/IDQ65001.png?t=${timestamp}`;
            
            // Update timestamp
            cycloneTimestamp.textContent = `Last updated: ${new Date().toLocaleTimeString('en-AU')}`;
            
            // Handle errors
            cycloneImage.onerror = function() {
                cycloneError.style.display = 'block';
            };
            
            cycloneImage.onload = function() {
                cycloneError.style.display = 'none';
            };
        }

        // Handle errors globally
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showNotification('An error occurred. Please refresh the page if issues persist.', 'error');
        });

        // Function to mark a tab as unavailable and fully prevent tab selection
        function markTabUnavailable(tabId, reason) {
            // Grey out the tab
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.classList.add('tab-unavailable');
                tab.setAttribute('data-unavailable-reason', reason);
                
                // Remove active class if the tab is currently active
                tab.classList.remove('active');
                
                // Hide the associated content
                const contentId = tabId.replace('tab-', 'content-');
                const contentElement = document.getElementById(contentId);
                if (contentElement) {
                    contentElement.classList.remove('active');
                }
                
                // Find another tab to activate if needed
                if (tab.classList.contains('active')) {
                    // Find the first available tab
                    const firstAvailableTab = document.querySelector('.tab-button:not(.tab-unavailable)');
                    if (firstAvailableTab) {
                        firstAvailableTab.classList.add('active');
                        const firstAvailableContent = document.getElementById(
                            firstAvailableTab.id.replace('tab-', 'content-')
                        );
                        if (firstAvailableContent) {
                            firstAvailableContent.classList.add('active');
                        }
                    }
                }
                
                // Replace click handler completely to prevent tab selection
                tab.onclick = function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Show popup with information about why the tab is unavailable
                    const reason = this.getAttribute('data-unavailable-reason');
                    showUnavailableContentPopup(tabId, reason);
                    
                    return false;
                };
            }
        }
        
        // Function to mark a tab as available again
        function markTabAvailable(tabId) {
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.classList.remove('tab-unavailable');
                tab.removeAttribute('data-unavailable-reason');
                
                // Restore original click functionality (this would need to be modified to fully restore tab functionality)
                tab.onclick = function() {
                    // Activate the tab normally
                    activateTab(tabId);
                };
            }
        }
        
        // Function to show popup for unavailable content
        function showUnavailableContentPopup(tabId, reason) {
            // Create a descriptive message based on which tab is unavailable
            let title, message, linkText, linkUrl;
            
            if (tabId === 'tab-cyclone') {
                title = "Cyclone Information Unavailable";
                message = "No current warnings and bulletins for cyclones in this area.";
                linkText = "View BOM cyclone information";
                linkUrl = "http://www.bom.gov.au/cyclone/";
            } 
            else if (tabId === 'tab-radar') {
                title = "Radar Image Unavailable";
                message = "The latest radar image could not be fetched.";
                linkText = "View latest forecast for Lismore";
                linkUrl = "https://beta.bom.gov.au/poi-location/australia/new-south-wales/northern-rivers/nsw_pt079-lismore";
            }
            else {
                title = "Content Unavailable";
                message = "This content is currently unavailable. Please try again later.";
            }
            
            // Show the notification with appropriate styling and content
            const notificationElement = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            // Create message HTML
            let messageHTML = `
                <div style="text-align:left;">
                    <strong>${title}</strong><br>
                    ${message}
                    ${linkUrl ? `<br><br><a href="${linkUrl}" target="_blank" style="color:white;text-decoration:underline;">${linkText}</a>` : ''}
                </div>
            `;
            
            notificationMessage.innerHTML = messageHTML;
            notification.className = 'notification info';
            notification.classList.add('show');
            
            // Auto-hide after 7 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 7000);
        }
        
        // Function to check if cyclone data is available
        function checkCycloneAvailability() {
            const cycloneImg = new Image();
            
            cycloneImg.onload = function() {
                // If image loads successfully, mark tab as available
                markTabAvailable('tab-cyclone');
                document.getElementById('cyclone-error').style.display = 'none';
            };
            
            cycloneImg.onerror = function() {
                // If image fails to load, mark tab as unavailable
                markTabUnavailable('tab-cyclone', 'No current cyclone warnings or bulletins for this area.');
                document.getElementById('cyclone-error').style.display = 'block';
                document.getElementById('cyclone-error').textContent = 'No current cyclone warnings for this area';
            };
            
            // Add timestamp to prevent caching
            cycloneImg.src = `http://www.bom.gov.au/fwo/IDQ65001.png?t=${new Date().getTime()}`;
        }
        
        // Fix for the error in radar image onload handler
        // Add this function to your JavaScript file
        
        function fixRadarStatusCheck() {
            // Get the original function reference so we can restore it after fixing
            const originalCheckRadarAvailability = window.checkRadarAvailability || function(){};
            
            // Create a safer version
            window.checkRadarAvailability = function() {
                // The radar status checking happens in many places, so fix them all
                const safelySetStyle = (element, property, value) => {
                    if (element && element.style) {
                        element.style[property] = value;
                    }
                };
                
                // Find all possible radar error elements
                const radarErrorElements = [
                    document.getElementById('radar-error'),
                    document.querySelector('.radar-error')
                ];
                
                // Create a test image
                const radarImg = new Image();
                
                // Set up safe onload handler
                radarImg.onload = function() {
                    // Safely hide all possible error elements
                    radarErrorElements.forEach(el => safelySetStyle(el, 'display', 'none'));
                    
                    // Set status if available
                    const statusElement = document.getElementById('radar-status-value');
                    if (statusElement) {
                        statusElement.textContent = 'Online';
                        statusElement.className = 'status-value online';
                    }
                    
                    // Call original function if it exists and is a function
                    if (typeof originalCheckRadarAvailability === 'function') {
                        try {
                            // Capture any errors and prevent them from stopping execution
                            originalCheckRadarAvailability();
                        } catch (e) {
                            console.error('Error in original radar status check:', e);
                        }
                    }
                };
                
                // Set up safe onerror handler
                radarImg.onerror = function() {
                    // Safely show all possible error elements
                    radarErrorElements.forEach(el => safelySetStyle(el, 'display', 'block'));
                    
                    // Set status if available
                    const statusElement = document.getElementById('radar-status-value');
                    if (statusElement) {
                        statusElement.textContent = 'Offline';
                        statusElement.className = 'status-value offline';
                    }
                };
                
                // Add timestamp to prevent caching
                radarImg.src = `http://www.bom.gov.au/radar/IDR282.gif?t=${new Date().getTime()}`;
            };
            
            // Fix existing radar refresh function if it exists
            const originalRefreshRadar = window.refreshRadar || function(){};
            
            window.refreshRadar = function() {
                // Get all possible radar elements
                const radarImage = document.getElementById('radar-image');
                const radarError = document.getElementById('radar-error');
                const radarTimestamp = document.getElementById('radar-timestamp');
                
                // Only proceed if elements exist
                if (radarImage) {
                    // Add timestamp parameter to prevent caching
                    const timestamp = new Date().getTime();
                    radarImage.src = `http://www.bom.gov.au/radar/IDR282.gif?t=${timestamp}`;
                    
                    // Update timestamp if element exists
                    if (radarTimestamp) {
                        radarTimestamp.textContent = `Last updated: ${new Date().toLocaleTimeString('en-AU')}`;
                    }
                    
                    // Handle errors if element exists - using safelySetStyle
                    if (radarError) {
                        radarImage.onerror = function() {
                            if (radarError && radarError.style) {
                                radarError.style.display = 'block';
                            }
                        };
                        
                        radarImage.onload = function() {
                            if (radarError && radarError.style) {
                                radarError.style.display = 'none';
                            }
                        };
                    }
                }
                
                // Try to also trigger refresh for the new interactive radar
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    try {
                        refreshBtn.click();
                    } catch (e) {
                        console.error('Error clicking refresh button:', e);
                    }
                }
            };
            
            console.log('Radar functions fixed for compatibility');
        }
        
        // Call this function after the page loads
        document.addEventListener('DOMContentLoaded', fixRadarStatusCheck);
        
        // Also call it now in case the page is already loaded
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            fixRadarStatusCheck();
        }
        
        // Add CSS for unavailable tabs
        function addUnavailableTabStyles() {
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                .tab-button.tab-unavailable {
                    opacity: 0.6;
                    cursor: not-allowed !important;
                    position: relative;
                    pointer-events: all !important; /* Ensure our custom handler still works */
                }
                
                .tab-button.tab-unavailable:hover {
                    background-color: transparent !important;
                    color: var(--gray-700) !important;
                    transform: none !important;
                }
                
                .tab-button.tab-unavailable::after {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-image: linear-gradient(45deg, rgba(180, 180, 180, 0.1) 25%, transparent 25%, transparent 50%, rgba(180, 180, 180, 0.1) 50%, rgba(180, 180, 180, 0.1) 75%, transparent 75%, transparent);
                    background-size: 8px 8px;
                    pointer-events: none;
                    border-radius: var(--border-radius);
                }
                
                .tab-button.tab-unavailable svg {
                    opacity: 0.7;
                }
            `;
            document.head.appendChild(styleElement);
        }
        
        // Add this to your initialization function
        function initializeAvailabilityChecks() {
            // Add the styles for unavailable tabs
            addUnavailableTabStyles();
            
            // Check availability of cyclone and radar data
            checkCycloneAvailability();
            checkRadarStatus();
            
            // Set up periodic checks
            setInterval(checkCycloneAvailability, 60000); // Check every minute
            setInterval(checkRadarAvailability, 60000);
        }
        
        // Helper function to activate a tab
        function activateTab(tabId) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and its content
            document.getElementById(tabId).classList.add('active');
            const contentId = tabId.replace('tab-', 'content-');
            document.getElementById(contentId).classList.add('active');
        }
        
        // Call this function after the document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeAvailabilityChecks();
        });

        // ====================== FLOOD MAP FUNCTIONALITY WITH LEVEE PROTECTION ======================
                
        // Function to determine if a point is inside a polygon (ray casting algorithm)
        function isPointInPolygon(point, polygon) {
            // point is [longitude, latitude]
            // polygon is array of [longitude, latitude] coordinates
            
            const x = point[0];
            const y = point[1];
            
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];
                
                const intersect = ((yi > y) !== (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            
            return inside;
        }

        // Add levee to map as a line
        function addLeveeToMap(floodMap, floodHeight) {
            // Create reversed coordinates for Leaflet (it expects [lat, lng] not [lng, lat])
            const reversedCoordinates = leveeCoordinates.map(coord => [coord[1], coord[0]]);
            
            // Determine levee color based on flood height
            let leveeColor = '#2196F3'; // Default blue
            let leveeWeight = 3;
            
            if (floodHeight >= LEVEE_HEIGHT) {
                // Levee is breached - red
                leveeColor = '#e74c3c';
                leveeWeight = 4;
            } else if (floodHeight >= LEVEE_WARNING_THRESHOLD) {
                // Approaching levee height - orange
                leveeColor = '#f39c12';
                leveeWeight = 4;
            }
            
            // Create polyline (not polygon)
            const leveeLine = L.polyline(reversedCoordinates, {
                color: leveeColor,
                weight: leveeWeight,
                opacity: 0.8
            }).addTo(floodMap);
            
            // Add a popup with information about the levee
            if (floodHeight >= LEVEE_HEIGHT) {
                leveeLine.bindPopup("<strong>Levee Wall - BREACHED</strong><br>Flood height exceeds levee protection height of 10.6m");
            } else if (floodHeight >= LEVEE_WARNING_THRESHOLD) {
                leveeLine.bindPopup("<strong>Levee Wall - WARNING</strong><br>Flood height is approaching levee protection height of 10.6m");
            } else {
                leveeLine.bindPopup("<strong>Levee Wall</strong><br>Protects area until water level reaches 10.6m");
            }
            
            return leveeLine;
        }
        
        // Process the flood data from CSV
        function processFloodData(data) {
            // Convert to a more usable format
            floodProperties = data.map(row => {
                const floorLevel = parseFloat(row['Floor Level']);
                const gateLevel = parseFloat(row['Gate Level']);
                const roadLevel = parseFloat(row['Road Centre']);
                
                return {
                    address: row['Street Details'],
                    floorLevel: floorLevel,
                    gateLevel: gateLevel,
                    roadLevel: roadLevel,
                    coordinates: [parseFloat(row['Latitude']), parseFloat(row['Longitude'])]
                };
            }).filter(property => {
                // Filter out any properties with invalid data
                return !isNaN(property.floorLevel) && 
                       !isNaN(property.gateLevel) && 
                       !isNaN(property.roadLevel) &&
                       !isNaN(property.coordinates[0]) &&
                       !isNaN(property.coordinates[1]);
            });
        }

        // Check if property is inside levee area and if it would be affected by flooding
        function getFloodStatusWithLevee(floodHeight, property) {
            // Check if property is inside the levee area
            const isInLeveeArea = isPointInPolygon([property.coordinates[1], property.coordinates[0]], leveeAreaCoordinates);
            
            // Check if property would be affected without levee protection
            const floorAffected = property.floorLevel <= floodHeight;
            const gateAffected = property.gateLevel <= floodHeight;
            const roadAffected = property.roadLevel <= floodHeight;
            
            // Determine if property would be affected without levee protection
            let wouldBeAffected = false;
            let normalStatus = 'safe';
            
            if (floorAffected) {
                wouldBeAffected = true;
                normalStatus = 'critical';
            } else if (gateAffected) {
                wouldBeAffected = true;
                normalStatus = 'warning';
            } else if (roadAffected) {
                wouldBeAffected = true;
                normalStatus = 'alert';
            }
            
            // Check if levee is protecting this property
            if (isInLeveeArea && wouldBeAffected && floodHeight <= LEVEE_HEIGHT) {
                // Property would be affected but is protected by levee
                property.leveeProtected = true;
                property.normalStatus = normalStatus; // Store the status it would have without levee
                return 'safe';
            }
            
            // Property is not protected by levee (either outside area, not affected, or flood exceeds levee height)
            property.leveeProtected = false;
            return normalStatus;
        }
        
            // Create popup content showing levee protection status
            function createPopupContent(property, floodHeight, status) {
                // Extract address details
                const addressParts = property.address.match(/^(\d+)\s+(.+?)\s+([A-Z\s]+)$/);
                let streetNumber = '', streetName = '';
                
                if (addressParts) {
                    streetNumber = addressParts[1];
                    streetName = addressParts[2];
                } else {
                    streetName = property.address;
                }
                
                // Check flood conditions
                const floorAffected = property.floorLevel <= floodHeight;
                const gateAffected = property.gateLevel <= floodHeight;
                const roadAffected = property.roadLevel <= floodHeight;
                
                // Build popup content
                let content = `
                    <div style="font-family:'Inter',sans-serif;line-height:1.5;">
                        <div style="font-size:16px;font-weight:600;margin-bottom:12px;border-bottom:1px solid #eee;padding-bottom:8px;">
                            ${streetNumber} ${streetName}
                        </div>
                        
                        <div style="margin-bottom:8px;">
                            <div style="font-weight:500;margin-bottom:4px;">Status: <span style="color:${getStatusColor(status)};font-weight:600;">${getStatusText(status)}</span></div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 8px;margin-bottom:10px;">
                            <div style="font-weight:500;">Floor Level:</div>
                            <div>${property.floorLevel.toFixed(2)}m ${floorAffected && !property.leveeProtected ? '<span style="color:#e74c3c;font-weight:bold;padding:1px 4px;background-color:rgba(231,76,60,0.1);border-radius:3px;">AFFECTED</span>' : ''}</div>
                            
                            <div style="font-weight:500;">Gate Level:</div>
                            <div>${property.gateLevel.toFixed(2)}m ${gateAffected && !property.leveeProtected ? '<span style="color:#f39c12;font-weight:bold;padding:1px 4px;background-color:rgba(243,156,18,0.1);border-radius:3px;">AFFECTED</span>' : ''}</div>
                            
                            <div style="font-weight:500;">Road Level:</div>
                            <div>${property.roadLevel.toFixed(2)}m ${roadAffected && !property.leveeProtected ? '<span style="color:#f1c40f;font-weight:bold;padding:1px 4px;background-color:rgba(241,196,15,0.1);border-radius:3px;">AFFECTED</span>' : ''}</div>
                        </div>
                    </div>
                `;
                
                // Add levee protection info at the bottom if applicable
                if (property.leveeProtected) {
                    content += `
                    <div style="background-color:#e3f2fd;padding:10px;margin:6px 0 0 0;border-radius:6px;border:1px solid #bbdefb;display:flex;align-items:center;justify-content:center;">
                        <span style="color:#1976d2;margin-right:8px;display:flex;align-items:center;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                        </span>
                        <span style="color:#1976d2;font-weight:600;font-size:14px;">Protected by Levee</span>
                    </div>`;
                }
                
                return content;
            }
        
        // Add legend items for levee protection
        function addLeveeLegendItem() {
            const legendElement = document.querySelector('.flood-map-legend');
            if (!legendElement) return;
            
            // Add levee legend entry if not already present
            if (!document.querySelector('.legend-item-levee')) {
                const leveeLegendItem = document.createElement('div');
                leveeLegendItem.className = 'legend-item legend-item-levee';
                leveeLegendItem.innerHTML = `
                    <div class="legend-color" style="background-color: #2196F3;"></div>
                    <div class="legend-label">Levee Protected</div>
                `;
                legendElement.appendChild(leveeLegendItem);
            }
        }
        
        // Get status text for display
        function getStatusText(status) {
            switch (status) {
                case 'critical': return 'Critical - Floor Level Affected';
                case 'warning': return 'Warning - Gate Level Affected';
                case 'alert': return 'Alert - Road Level Affected';
                case 'safe': return 'Safe - Not Affected';
                default: return 'Unknown';
            }
        }
        
        // Get color based on flood status
        function getStatusColor(status) {
            const COLORS = {
                critical: '#e74c3c',
                warning: '#f39c12',
                alert: '#f1c40f',
                safe: '#2ecc71'
            };
            
            return COLORS[status] || COLORS.safe;
        }
        
        // Get intensity value for heatmap (0-1)
        function getHeatIntensity(status) {
            switch (status) {
                case 'critical': return 1.0;
                case 'warning': return 0.7;
                case 'alert': return 0.4;
                case 'safe': return 0.1;
                default: return 0;
            }
        }
        
        // Update flood map with current river level respecting user's selection
        function updateFloodMapWithCurrentLevelRespectingUserChoice() {
            if (floodMapInitialized) {
                const floodHeightSlider = document.getElementById('flood-height-slider');
                const floodHeightDisplay = document.getElementById('flood-height-display');
                
                // If user has made a selection, respect it
                if (userSelectedFloodHeight !== null) {
                    // User has manually selected a height - keep it
                    floodHeightSlider.value = userSelectedFloodHeight;
                    floodHeightDisplay.textContent = userSelectedFloodHeight.toFixed(1) + 'm';
                    updateFloodVisualizationWithLevee(userSelectedFloodHeight);
                } else if (currentLismoreLevel !== null) {
                    // No user selection yet, use current level
                    floodHeightSlider.value = currentLismoreLevel;
                    floodHeightDisplay.textContent = currentLismoreLevel.toFixed(1) + 'm';
                    updateFloodVisualizationWithLevee(currentLismoreLevel);
                }
            }
        }
        
        // Update flood map visualization with levee protection
        function updateFloodVisualizationWithLevee(floodHeight) {
            if (!floodMapInitialized || floodProperties.length === 0) {
                return;
            }
        
            // Show loading overlay
            const floodLoadingOverlay = document.getElementById('flood-loading-overlay');
            floodLoadingOverlay.style.display = 'flex';
            
            // Clear existing layers
            floodMarkers.clearLayers();
            if (floodHeatmapLayer) {
                floodMap.removeLayer(floodHeatmapLayer);
            }
            
            // Remove previous levee line if it exists
            if (leveeLine) {
                floodMap.removeLayer(leveeLine);
            }
            
            // Add updated levee line with appropriate color
            leveeLine = addLeveeToMap(floodMap, floodHeight);
            
            // Count properties by status for statistics
            const stats = {
                critical: 0,
                warning: 0,
                alert: 0,
                safe: 0,
                leveeProtected: 0 // Add counter for levee protected properties
            };
            
            // Update the stats display
            document.getElementById('flood-stats-height').textContent = floodHeight.toFixed(1) + 'm';
            
            // Prepare heatmap data
            const heatmapData = [];
            
            // Process each property
            floodProperties.forEach((property, index) => {
                // Get flood status for this property, accounting for levee protection
                const status = getFloodStatusWithLevee(floodHeight, property);
                
                // Update statistics
                stats[status]++;
                if (property.leveeProtected) {
                    stats.leveeProtected++;
                }
                
                // Create marker with appropriate color
                let color;
                if (property.leveeProtected) {
                    color = '#2196F3'; // Use blue for levee protected properties
                } else {
                    color = getStatusColor(status);
                }
                
                // Create marker
                const marker = L.circleMarker(property.coordinates, {
                    color: 'white',
                    weight: 1.5,
                    fillColor: color,
                    fillOpacity: 0.8,
                    radius: 8
                });
                
                // Create popup content with levee information
                const popupContent = createPopupContent(property, floodHeight, status);
                
                marker.bindPopup(popupContent);
                floodMarkers.addLayer(marker);
                
                // Add to heatmap data
                let intensity;
                
                if (property.leveeProtected) {
                    // For levee-protected properties, use a special intensity value
                    // that will map to blue in the heatmap
                    intensity = 0.05; // Use a unique value for levee-protected properties
                } else {
                    // For regular properties, use the standard intensity values
                    intensity = getHeatIntensity(status);
                }
                
                heatmapData.push([
                    property.coordinates[0], 
                    property.coordinates[1], 
                    intensity
                ]);
            });
            
            // Create heatmap layer with updated gradient that includes levee protection color
            floodHeatmapLayer = L.heatLayer(heatmapData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {
                    0.05: '#2196F3', // Levee protected (blue)
                    0.1: getStatusColor('safe'),
                    0.4: getStatusColor('alert'),
                    0.7: getStatusColor('warning'),
                    1.0: getStatusColor('critical')
                }
            });
            
            // Update statistics display
            document.getElementById('flood-stat-total').textContent = floodProperties.length;
            document.getElementById('flood-stat-critical').textContent = stats.critical;
            document.getElementById('flood-stat-warning').textContent = stats.warning;
            document.getElementById('flood-stat-alert').textContent = stats.alert;
            document.getElementById('flood-stat-safe').textContent = stats.safe;
            
            // Add levee protected info to stats display if not already present
            let leveeStatElement = document.getElementById('flood-stat-levee');
            if (!leveeStatElement && stats.leveeProtected > 0) {
                const floodStatGrid = document.querySelector('.flood-stat-grid');
                const leveeStatItem = document.createElement('div');
                leveeStatItem.className = 'flood-stat-item';
                leveeStatItem.innerHTML = `
                    <div class="flood-stat-label">Levee Protected</div>
                    <div class="flood-stat-value" id="flood-stat-levee">0 <span class="category-badge" style="background-color:rgba(33, 150, 243, 0.1);color:#2196F3;">Levee</span></div>
                `;
                floodStatGrid.appendChild(leveeStatItem);
                leveeStatElement = document.getElementById('flood-stat-levee');
            }
            
            if (leveeStatElement) {
                if (stats.leveeProtected > 0) {
                    leveeStatElement.innerHTML = stats.leveeProtected + ' <span class="category-badge" style="background-color:rgba(33, 150, 243, 0.1);color:#2196F3;">Levee</span>';
                    leveeStatElement.parentElement.style.display = 'block';
                } else {
                    leveeStatElement.parentElement.style.display = 'none';
                }
            }
            
            // Show the appropriate layer based on user selection
            if (document.getElementById('flood-show-heatmap').checked) {
                floodMap.removeLayer(floodMarkers);
                floodMap.addLayer(floodHeatmapLayer);
            } else {
                floodMap.addLayer(floodMarkers);
            }
            
            // Hide loading overlay
            floodLoadingOverlay.style.display = 'none';
        }
        
        // Initialize the flood map with levee functionality
        function initFloodMapWithLevee() {
            // Get elements
            const floodHeightSlider = document.getElementById('flood-height-slider');
            const floodHeightDisplay = document.getElementById('flood-height-display');
            const useCurrentLevelBtn = document.getElementById('use-current-level');
            const floodLoadingOverlay = document.getElementById('flood-loading-overlay');
            const floodShowMarkers = document.getElementById('flood-show-markers');
            const floodShowHeatmap = document.getElementById('flood-show-heatmap');
            const refreshFloodMapBtn = document.getElementById('refresh-floodmap');
            
            // Create the map
            floodMap = L.map('flood-map').setView([-28.8167, 153.2833], 14);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(floodMap);
            
            // Initialize layers
            floodMarkers = L.layerGroup().addTo(floodMap);
            
            // Add levee legend item
            addLeveeLegendItem();
            
            // Set Lismore area bounds
            const LISMORE_BOUNDS = [
                [-28.8767, 153.2233], // Southwest
                [-28.7767, 153.3433]  // Northeast - extended bounds for better visibility
            ];
            
            // Restrict the map view to Lismore area
            floodMap.setMaxBounds(LISMORE_BOUNDS);
            floodMap.options.minZoom = 12;
            floodMap.options.maxZoom = 18;
            
            // Process the CSV data if available, otherwise wait for it to load
            if (embeddedCSVData && embeddedCSVData.length > 0) {
                processFloodData(embeddedCSVData);
            } else {
                console.log('Waiting for flood data to load...');
                // The data will be processed when loadFloodData completes
            }
            
            // Set initial height based on current Lismore level if available, otherwise use the slider's default
            let initialHeight;
            if (currentLismoreLevel !== null) {
                initialHeight = currentLismoreLevel;
                floodHeightSlider.value = initialHeight;
                floodHeightDisplay.textContent = initialHeight.toFixed(1) + 'm';
            } else {
                initialHeight = parseFloat(floodHeightSlider.value);
            }
            
            // Set initial user selection to null (indicating they haven't made a choice yet)
            userSelectedFloodHeight = null;
            
            // Update map visualization with initial value
            updateFloodVisualizationWithLevee(initialHeight);
            
            // Event listeners
            floodHeightSlider.addEventListener('input', function() {
                const height = parseFloat(this.value);
                userSelectedFloodHeight = height; // Store user's selection when they manually adjust the slider
                floodHeightDisplay.textContent = height.toFixed(1) + 'm';
                updateFloodVisualizationWithLevee(height);
            });
            
            useCurrentLevelBtn.addEventListener('click', function() {
                if (currentLismoreLevel !== null) {
                    userSelectedFloodHeight = currentLismoreLevel; // Update user selection to current level
                    floodHeightSlider.value = currentLismoreLevel;
                    floodHeightDisplay.textContent = currentLismoreLevel.toFixed(1) + 'm';
                    updateFloodVisualizationWithLevee(currentLismoreLevel);
                    showNotification('Map updated to current Wilsons River level: ' + currentLismoreLevel.toFixed(2) + 'm', 'info');
                } else {
                    showNotification('Current river level data not available', 'error');
                }
            });
            
            floodShowMarkers.addEventListener('change', function() {
                if (this.checked) {
                    floodMap.removeLayer(floodHeatmapLayer);
                    floodMap.addLayer(floodMarkers);
                }
            });
            
            floodShowHeatmap.addEventListener('change', function() {
                if (this.checked && floodHeatmapLayer) {
                    floodMap.removeLayer(floodMarkers);
                    floodMap.addLayer(floodHeatmapLayer);
                }
            });
            
            refreshFloodMapBtn.addEventListener('click', function() {
                const height = parseFloat(floodHeightSlider.value);
                userSelectedFloodHeight = null; // Reset user selection on manual refresh
                if (currentLismoreLevel !== null) {
                    floodHeightSlider.value = currentLismoreLevel;
                    floodHeightDisplay.textContent = currentLismoreLevel.toFixed(1) + 'm';
                    updateFloodVisualizationWithLevee(currentLismoreLevel);
                    showNotification('Map updated to current Wilsons River level: ' + currentLismoreLevel.toFixed(2) + 'm', 'info');
                } else {
                    updateFloodVisualizationWithLevee(height);
                }
            });
            
            // Mark as initialized
            floodMapInitialized = true;
            
            // Hide loading overlay
            floodLoadingOverlay.style.display = 'none';
        }

        // River height chart functionality
        document.addEventListener('DOMContentLoaded', function() {
            let riverChartInstance = null;
            const riverHeightModal = document.getElementById('river-height-modal');
            const riverName = document.getElementById('river-name');
            const riverChartCanvas = document.getElementById('river-chart');
            const riverLoading = document.getElementById('river-loading');
            const riverDataError = document.getElementById('river-data-error');
            const closeRiverChart = document.getElementById('close-river-chart');
            const modalCloseBtn = document.querySelector('.modal-close');
        
            // Function to open the modal - with more aggressive title cleaning
            function openRiverHeightModal(location) {
                // For Wilsons River at Lismore specifically, use a simpler approach
                let cleanLocation = location;
                
                if (location.includes("Wilsons") && location.includes("Lismore")) {
                    cleanLocation = "Wilsons R at Lismore (mAHD)";
                } else {
                    // For other locations, strip out everything after the location name
                    cleanLocation = location.split(/\s+\d/)[0]; // Split at the first digit with space before it
                    cleanLocation = cleanLocation.replace(/\s*\<span.*\<\/span\>/i, ""); // Remove any HTML spans
                    cleanLocation = cleanLocation.trim();
                }
                
                // Set the modal title
                riverName.textContent = cleanLocation + ' - Height History';
                
                // Show the modal and loading indicator
                riverLoading.style.display = 'flex';
                riverDataError.style.display = 'none';
                riverHeightModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                // Fetch the river height data using the original location for API request
                fetchRiverHeightData(location, cleanLocation);
            }
        
            // Function to close the modal
            function closeRiverHeightModal() {
                riverHeightModal.style.display = 'none';
                document.body.style.overflow = '';
                
                // Destroy the chart if it exists
                if (riverChartInstance) {
                    riverChartInstance.destroy();
                    riverChartInstance = null;
                }
            }
        
            // Event listeners for closing the modal
            closeRiverChart.addEventListener('click', closeRiverHeightModal);
            modalCloseBtn.addEventListener('click', closeRiverHeightModal);
            riverHeightModal.addEventListener('click', function(event) {
                if (event.target === riverHeightModal) {
                    closeRiverHeightModal();
                }
            });
        
            // Function to handle row click
            function handleRowClick(event) {
                // Get the row that was clicked
                const row = event.target.closest('tr');
                
                // Skip if clicked on header or if it's a river system row
                if (!row || row.closest('thead') || row.classList.contains('river-system-header')) {
                    return;
                }
                
                // Get the location from the first cell
                const location = row.cells[0].textContent.trim();
                
                // Open the modal with this location
                openRiverHeightModal(location);
            }
        
            // Add click event listener to the flood data table
            document.getElementById('flood-data-body').addEventListener('click', handleRowClick);
        
        // Function to fetch river height data with exact location name
        async function fetchRiverHeightData(location) {
          try {
            // Show loading indicator
            const riverLoading = document.getElementById('river-loading');
            const riverDataError = document.getElementById('river-data-error');
            riverLoading.style.display = 'flex';
            riverDataError.style.display = 'none';
            
            // First, let's remove the icon text from the location if it exists
            const cleanLocation = location.replace(/\s*\<span.*\<\/span\>/i, "");
            
            // Encode the location to be safe for URLs
            const encodedLocation = encodeURIComponent(cleanLocation);
            
            console.log(`Requesting river height data for: "${cleanLocation}"`);
            
            // Request the data from our proxy server
            const response = await fetch(`${BASE_URL}/river-data?location=${encodedLocation}`);
            
            if (!response.ok) {
              let errorDetail = `HTTP error! status: ${response.status}`;
              try {
                const errorData = await response.json();
                if (errorData && errorData.message) {
                  errorDetail += ` - ${errorData.message}`;
                }
              } catch (e) {
                // If we can't parse the error JSON, just use the status code
              }
              
              throw new Error(errorDetail);
            }
            
            const data = await response.json();
            
            if (data.success && data.data && data.data.length > 0) {
              console.log(`Successfully received ${data.data.length} data points for ${data.location || cleanLocation}`);
              
              // Process and render the chart
              renderRiverHeightChart(data.data, cleanLocation);
            } else {
              showRiverDataError("No data available for this location");
            }
          } catch (error) {
            console.error('Error fetching river height data:', error);
            showRiverDataError(`Could not load river height data: ${error.message}`);
          }
        }
        
        // Update the river height chart rendering function to include 0 on y-axis
        function renderRiverHeightChart(heightData, location) {
          // Check if we need to reduce data points (if there are too many)
          let processedData = heightData;
          if (heightData.length > 100) {
            // Apply data reduction to smoothen the chart without losing significant trends
            processedData = reduceDataPoints(heightData, 50);
            console.log(`Reduced data points from ${heightData.length} to ${processedData.length} for smoother rendering`);
          }
          
          // Prepare data for Chart.js
          const dates = processedData.map(item => item.time);
          const heights = processedData.map(item => item.height);
          
          // Get the canvas context
          const ctx = document.getElementById('river-chart').getContext('2d');
          
          // Destroy previous chart if it exists
          if (riverChartInstance) {
            riverChartInstance.destroy();
          }
          
          // Create gradient for the chart area
          const gradient = ctx.createLinearGradient(0, 0, 0, 400);
          gradient.addColorStop(0, 'rgba(30, 136, 229, 0.2)');
          gradient.addColorStop(1, 'rgba(30, 136, 229, 0)');
          
          // Create new chart
          riverChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: dates,
              datasets: [{
                label: 'Water Level (m)',
                data: heights,
                borderColor: 'rgba(30, 136, 229, 1)',
                backgroundColor: gradient,
                fill: true,
                tension: 0.5,              // Moderate curve tension
                pointRadius: 0,            // Hide individual points
                pointHoverRadius: 6,       // Larger hover points
                pointBackgroundColor: 'white',
                pointBorderColor: 'rgba(30, 136, 229, 1)',
                pointBorderWidth: 2,
                pointHitRadius: 20,        // Large hit radius for easier hovering
                borderWidth: 3,            // Thicker line
                cubicInterpolationMode: 'monotone', // Natural curve interpolation
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: false,          // No title
                },
                legend: {
                  display: false
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  backgroundColor: 'rgba(0, 0, 0, 0.7)',
                  titleColor: 'rgba(255, 255, 255, 1)',
                  bodyColor: 'rgba(255, 255, 255, 1)',
                  borderColor: 'rgba(30, 136, 229, 0.5)',
                  borderWidth: 1,
                  padding: 10,
                  cornerRadius: 4,
                  displayColors: false,
                  callbacks: {
                    title: function(tooltipItems) {
                      return tooltipItems[0].label;
                    },
                    label: function(context) {
                      return `Water Level: ${context.parsed.y.toFixed(2)}m`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false,        // No x grid
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                    autoSkip: true,
                    maxTicksLimit: 8       // Fewer labels
                  }
                },
                y: {
                  beginAtZero: true,      // Start y-axis at 0
                  suggestedMin: 0,        // Suggest minimum of 0
                  suggestedMax: function() {
                    // Find max value and add 20% padding
                    const maxHeight = Math.max(...heights);
                    return maxHeight * 1.2;
                  }(),
                  grid: {
                    color: 'rgba(0, 0, 0, 0.03)', // Light grid
                  },
                  ticks: {
                    callback: function(value) {
                      return value.toFixed(2) + 'm';
                    }
                  }
                }
              },
              interaction: {
                mode: 'index',
                intersect: false
              },
              elements: {
                line: {
                  tension: 0.5              // Smooth line tension
                }
              },
              hover: {
                mode: 'index',
                intersect: false
              }
            }
          });
          
          // Hide loading indicator
          document.getElementById('river-loading').style.display = 'none';
          
          // Update the data range text in the modal footer
          const dataRange = document.getElementById('river-data-range');
          if (dataRange && dates.length > 0) {
            const firstDate = dates[0];
            const lastDate = dates[dates.length - 1];
            dataRange.textContent = `Data from ${firstDate} to ${lastDate}`;
          }
        }
        
        // Helper function to reduce the number of data points while preserving trend
        function reduceDataPoints(data, targetPoints) {
          const originalLength = data.length;
          
          // If we already have fewer points than target, return original data
          if (originalLength <= targetPoints) {
            return data;
          }
          
          const result = [];
          // Always include the first and last points
          result.push(data[0]);
          
          // Calculate how many points to skip
          const step = Math.floor(originalLength / (targetPoints - 2));
          
          // Add intermediate points at regular intervals
          for (let i = step; i < originalLength - step; i += step) {
            result.push(data[i]);
          }
          
          // Add the last point
          result.push(data[originalLength - 1]);
          
          return result;
        }
        });
        </script>

    <!-- River Height History Modal -->
    <div id="river-height-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="river-name">River Height History</h2>
                <button class="modal-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="river-loading" class="river-loading">
                    <div class="spinner"></div>
                    <p>Loading river height data...</p>
                </div>
                <div class="river-chart-container">
                    <canvas id="river-chart"></canvas>
                </div>
                <div id="river-data-error" class="river-data-error" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <p>Could not load river height data. Please try again later.</p>
                </div>
            </div>
            <div class="modal-footer">
                <span id="river-data-range">Last 4 days of readings</span>
                <button id="close-river-chart" class="button">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
