<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lismore Flood Emergency Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        :root {
            --primary-color: #1e88e5;
            --primary-dark: #1565c0;
            --secondary-color: #f8f9fa;
            --danger-color: #e53935;
            --warning-color: #ffa000;
            --success-color: #43a047;
            --info-color: #039be5;
            --dark-color: #212121;
            --light-color: #f8f9fa;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --border-radius: 8px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .header-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }

        .clock-container {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius);
            display: inline-flex;
            align-items: center;
            font-weight: 500;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 1rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 992px) {
            .dashboard-container {
                grid-template-columns: 3fr 1fr;
            }
        }

        .webcam-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .webcam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .webcam-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .webcam-image-container {
            position: relative;
            width: 100%;
            padding: 1rem;
            text-align: center;
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
            margin: 0.5rem 0;
        }
        
        .webcam-image {
            max-width: 100%;
            height: auto;
            border-radius: calc(var(--border-radius) - 2px);
            border: 1px solid var(--gray-300);
            box-shadow: var(--shadow-sm);
            background-color: white;
            display: inline-block;
        }

        .webcam-error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
        }

        .webcam-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .panel-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .panel-content {
            padding: 1rem;
        }

        .panel-alert {
            background-color: #fef2f2;
            border: 1px solid #fee2e2;
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #991b1b;
        }

        .panel-alert svg {
            flex-shrink: 0;
        }

        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            white-space: nowrap;
        }

        .button:hover {
            background-color: var(--primary-dark);
        }

        .button:active {
            transform: translateY(1px);
        }

        .button.secondary {
            background-color: var(--gray-500);
        }

        .button.secondary:hover {
            background-color: var(--gray-600);
        }

        select.button {
            appearance: none;
            padding-right: 2rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background-color: var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .table-footer {
            padding: 0.75rem 1rem;
            color: var(--gray-600);
            font-size: 0.875rem;
            background-color: var(--gray-100);
            border-top: 1px solid var(--gray-200);
        }

        .tabs-container {
            border-bottom: 1px solid var(--gray-200);
        }
        
        .tabs {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            color: var(--primary-color);
            background-color: var(--gray-100);
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content-container {
            padding: 0;
        }
        
        .tab-content {
            display: none !important;
            visibility: hidden;
            position: absolute;
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }
                
        .tab-content.active {
            display: block !important;
            visibility: visible;
            position: relative;
            opacity: 1;
            pointer-events: auto;
            z-index: 1;
        }
        
        .tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1rem 0.5rem;
        }
        
        .tab-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .tab-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem 1rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .tab-link {
            color: var(--primary-color);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .tab-link:hover {
            text-decoration: underline;
        }
        
        .cyclone-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 55%;
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: var(--gray-200);
        }
        
        .cyclone-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: var(--border-radius);
            background-color: var(--gray-100);
        }
        
        .cyclone-error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            text-align: center;
        }

        /* Outage Map Container */
        .outage-map-wrapper {
            position: relative;
            height: 500px;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        #outage-map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* Outage Legend */
        .outage-legend { 
            position: absolute; 
            right: 10px; 
            bottom: 30px;
            z-index: 1000; 
            background: white;
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--shadow-md);
            min-width: 200px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            color: #111827;
        }
        
        .outage-legend label { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            cursor: pointer; 
            margin: 6px 0;
            padding: 8px 10px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 13px;
            border: 2px solid transparent;
            background: var(--gray-100);
        }
        
        .outage-legend label:hover {
            background: var(--gray-200);
        }
        
        .outage-legend input[type="radio"] {
            display: none;
        }
        
        .outage-legend input[type="radio"]:checked + .legend-content {
            font-weight: 600;
        }
        
        .outage-legend input[type="radio"]:checked ~ .outage-dot {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            transform: scale(1.2);
        }
        
        .outage-legend label:has(input:checked) {
            background: white;
            border-color: var(--primary-color);
        }
        
        .legend-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .outage-dot { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            display: inline-block;
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .outage-dot.cur { background: #ff4d4f; }
        .outage-dot.fut { background: #f7ba1e; }
        .outage-dot.can { background: #7aa2f7; }
        
        .legend-note {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--gray-200);
            font-size: 11px;
            color: var(--gray-600);
        }
        
        /* Outage Controls Panel */
        .outage-controls-panel {
            background: white;
            border-top: 1px solid var(--gray-200);
            padding: 1rem 1.5rem;
        }
        
        .outage-controls-inner {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }
        
        .outage-control-group {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Outage Statistics */
        .outage-stats-container {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--gray-100);
            border-radius: var(--border-radius);
        }
        
        .outage-stats-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            color: #111827;
        }
        
        .outage-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .outage-stat-card {
            background: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }
        
        .outage-stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }
        
        .outage-stat-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .outage-stat-badge.current { 
            background: rgba(255, 77, 79, 0.1); 
            color: #ff4d4f; 
        }
        
        .outage-stat-badge.future { 
            background: rgba(247, 186, 30, 0.1); 
            color: #f7ba1e; 
        }
        
        .outage-stat-badge.cancelled { 
            background: rgba(122, 162, 247, 0.1); 
            color: #7aa2f7; 
        }
        
        /* Outage Popup Styling */
        .outage-popup-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: #111827;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .outage-popup-row {
            margin: 0.5rem 0;
            display: grid;
            grid-template-columns: 130px 1fr;
            gap: 0.5rem;
            align-items: start;
        }
        
        .outage-popup-label {
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.8125rem;
        }
        
        .outage-popup-value {
            color: #111827;
            font-size: 0.875rem;
        }
        
        .outage-popup-badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .outage-popup-badge.current { 
            background: rgba(255, 77, 79, 0.1); 
            color: #ff4d4f; 
        }
        
        .outage-popup-badge.future { 
            background: rgba(247, 186, 30, 0.1); 
            color: #f7ba1e; 
        }
        
        .outage-popup-badge.cancelled { 
            background: rgba(122, 162, 247, 0.1); 
            color: #7aa2f7; 
        }
        
        .outage-popup-footer {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
            font-size: 0.75rem;
            color: var(--gray-600);
        }
        
        /* Leaflet Popup Customization for Outages */
        .leaflet-popup-content-wrapper {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
        }
        
        .leaflet-popup-content {
            margin: 1rem;
            margin-right: 2.5rem;
            font-size: 0.875rem;
            line-height: 1.6;
            max-width: 350px;
        }
        
        .leaflet-popup-tip {
            background: white;
            border: 1px solid var(--gray-200);
            border-top: none;
            border-right: none;
        }
        
        .leaflet-popup-close-button {
            color: var(--gray-600) !important;
            font-size: 18px !important;
            padding: 4px 8px !important;
            width: 24px !important;
            height: 24px !important;
            position: absolute !important;
            top: 8px !important;
            right: 8px !important;
            border-radius: 4px !important;
        }
        
        .leaflet-popup-close-button:hover {
            background: var(--gray-100) !important;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .outage-map-wrapper {
                height: 400px;
            }
            
            .outage-legend {
                font-size: 0.75rem;
                min-width: 180px;
                right: 8px;
                bottom: 24px;
            }
            
            .outage-controls-inner {
                flex-direction: column;
                align-items: stretch;
            }
            
            .outage-control-group {
                flex-direction: column;
            }
            
            .outage-stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 576px) {
            .outage-map-wrapper {
                height: 350px;
            }
            
            .outage-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .maps-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        @media (min-width: 992px) {
            .maps-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .radar-container {
            position: relative;
            width: 100%;
            max-width: 512px;
            height: 400px;
            margin: 0 auto;
            text-align: center;
            background-color: #99ccff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .radar-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            width: 100%;
        }
        
        .legend-container {
            width: 100%;
            text-align: center;
            margin: 15px auto;
        }
        
        .legend-image {
            width: 350px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            display: inline-block;
        }
        
        @media screen and (max-width: 768px) {
            .legend-image {
                width: 300px;
            }
        }
        
        .radar-image, .map-layer {
            position: absolute;
            top: -50px;
            left: 0;
            width: 100%;
            height: calc(100% + 50px);
            object-fit: cover;
        }
        
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .control-buttons button {
            width: 48px;
            height: 48px;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-buttons button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .control-buttons button:active {
            transform: translateY(0);
        }
        
        .control-buttons button:disabled {
            background-color: #f0f0f0;
            color: #aaa;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        #btn-play, #btn-pause {
            width: 56px;
            height: 56px;
            font-size: 20px;
        }
        
        #btn-first, #btn-last {
            font-size: 14px;
        }
        
        .speed-controls {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .speed-slider {
            flex-grow: 1;
            max-width: 180px;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            outline: none;
            border-radius: 4px;
        }
        
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .speed-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }
        
        .control-buttons button {
            width: 40px;
            height: 40px;
            padding: 0;
            background-color: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-buttons button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .control-buttons button:active {
            transform: translateY(0);
        }
        
        .control-buttons button:disabled {
            background-color: #f0f0f0;
            color: #aaa;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .speed-controls {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .speed-slider {
            flex-grow: 1;
            max-width: 180px;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            outline: none;
            border-radius: 4px;
        }
        
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .speed-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }
        
        #timestamp {
            font-weight: 600;
            text-align: center;
            margin: 15px 0 5px 0;
            font-size: 1.1em;
        }
        
        .frame-counter {
            font-size: 0.85em;
            color: var(--text-light);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .progress-container {
            width: 100%;
            max-width: 400px;
            background-color: #e0e0e0;
            height: 5px;
            margin: 10px auto;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.2s;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
            z-index: 20;
            border-radius: 8px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .layer-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
            padding: 0 20px;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .layer-toggle input[type="checkbox"] {
            margin-right: 5px;
            cursor: pointer;
        }
        
        .error {
            color: #cc0000;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            margin: 10px 20px;
            background-color: #ffeeee;
            border-radius: 5px;
            border-left: 4px solid #cc0000;
        }
        
        .last-update {
            text-align: center;
            font-size: 0.85em;
            color: var(--text-light);
            margin-bottom: 10px;
        }
        
        @media screen and (max-width: 768px) {
            .radar-display {
                flex-direction: column;
                align-items: center;
            }
            
            .legend-container {
                margin: 10px auto;
            }
            
            .control-buttons {
                flex-wrap: wrap;
            }
        }
        
        .river-system-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .river-system-header td {
            padding: 0.5rem 1rem;
            font-size: 0.95rem;
        }

        .rising {
            color: var(--danger-color);
            font-weight: 600;
        }

        .falling {
            color: var(--success-color);
            font-weight: 600;
        }

        .steady {
            color: var(--info-color);
            font-weight: 600;
        }

        .minor-flood {
            background-color: rgba(255, 193, 7, 0.1);
        }

        .moderate-flood {
            background-color: rgba(255, 140, 0, 0.1);
        }

        .major-flood {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .emergency-contacts {
            background-color: #fef2f2;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .emergency-header {
            background-color: var(--danger-color);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .emergency-content {
            padding: 1rem;
        }

        .emergency-number {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0.25rem 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .emergency-number svg {
            flex-shrink: 0;
        }

        .evacuation-centers {
            margin-top: 1rem;
        }

        .center-list {
            list-style-type: none;
            margin-top: 0.5rem;
        }

        .center-list li {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            background-color: var(--gray-100);
            margin-bottom: 0.5rem;
        }

        .center-list strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--gray-800);
        }

        .resources-panel {
            background-color: #f0f7ff;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-top: 1.5rem;
        }
        
        .resources-header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .resources-content {
            padding: 1rem;
        }
        
        .resources-list {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        
        .resources-list li {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
        }
        
        .resources-list li:last-child {
            margin-bottom: 0;
        }
        
        .resources-list li svg {
            color: var(--primary-color);
            flex-shrink: 0;
            margin-top: 0.25rem;
        }
        
        .resource-item-content {
            flex: 1;
        }
        
        .resource-item-content strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--gray-800);
        }
        
        .resource-item-content p {
            margin: 0 0 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.4;
        }
        
        .resource-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--primary-color);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .resource-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }
        
        .resource-link svg {
            flex-shrink: 0;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-item {
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stat-item.critical .stat-value {
            color: var(--danger-color);
        }

        .stat-footer {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        .status-panel {
            padding: 1rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .status-value {
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-value.online {
            background-color: rgba(67, 160, 71, 0.1);
            color: var(--success-color);
        }

        .status-value.offline {
            background-color: rgba(229, 57, 53, 0.1);
            color: var(--danger-color);
        }

        .status-value.unknown {
            background-color: rgba(255, 160, 0, 0.1);
            color: var(--warning-color);
        }

        .status-actions {
            margin-top: 1rem;
            text-align: right;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            backdrop-filter: blur(4px);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            color: white;
            max-width: 350px;
            box-shadow: var(--shadow-lg);
            z-index: 999;
            transition: all 0.3s ease;
            transform: translateY(100px);
            opacity: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.info {
            background-color: var(--info-color);
        }

        .notification-icon {
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0.25rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .data-attribution {
            text-align: center;
            padding: 1.5rem;
            color: var(--gray-600);
            font-size: 0.875rem;
            border-top: 1px solid var(--gray-200);
            background-color: white;
        }

        .data-attribution a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .data-attribution a:hover {
            text-decoration: underline;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 5% auto;
            width: 90%;
            max-width: 1000px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from {opacity: 0; transform: translateY(-30px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-600);
            transition: color 0.2s;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: var(--gray-900);
        }
        
        .modal-body {
            padding: 1rem 1.5rem;
            position: relative;
            min-height: 400px;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .river-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10;
        }
        
        .river-chart-container {
            width: 100%;
            height: 400px;
        }
        
        .river-data-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--danger-color);
            padding: 2rem;
        }
        
        .river-data-error svg {
            margin-bottom: 1rem;
            color: var(--danger-color);
        }

        @media (max-width: 768px) {
            .header-title h1 {
                font-size: 1.25rem;
            }

            .stats-container {
                grid-template-columns: 1fr 1fr;
            }

            .flood-stat-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 0.5rem;
            }

            .flood-stat-item {
                padding: 0.75rem;
            }

            .flood-stat-value {
                font-size: 1.1rem;
                gap: 0.375rem;
            }

            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .refresh-controls {
                width: 100%;
                justify-content: space-between;
            }

            .filter-buttons {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 576px) {
            .header-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        #content-floodmap {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .flood-map-container {
            position: relative;
            flex: 1;
            min-height: 400px;
        }

        #flood-map {
            width: 100%;
            height: 100%;
            min-height: 400px;
            z-index: 1;
        }

        .flood-controls {
            padding: 1rem;
            background-color: white;
            border-top: 1px solid var(--gray-200);
        }

        .flood-controls-inner {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .flood-slider-container {
            flex: 1;
        }

        .flood-height-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .flood-height-value {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.85rem;
        }

        .flood-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            appearance: none;
            background: var(--gray-300);
            outline: none;
        }

        .flood-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        .flood-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        .flood-toggle-container {
            display: flex;
            gap: 0.5rem;
        }

        .flood-stats-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
        }

        .flood-stat-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            color: var(--gray-700);
        }

        .flood-stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
        }

        .flood-stat-item {
            background: white;
            padding: 0.875rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .flood-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .flood-stat-label {
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-bottom: 0.375rem;
            line-height: 1.3;
        }

        .flood-stat-value {
            font-weight: 600;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            line-height: 1.4;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .category-critical {
            background: rgba(229, 57, 53, 0.1);
            color: var(--danger-color);
        }

        .category-warning {
            background: rgba(255, 160, 0, 0.1);
            color: var(--warning-color);
        }

        .category-alert {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
        }

        .category-safe {
            background: rgba(67, 160, 71, 0.1);
            color: var(--success-color);
        }

        .flood-map-legend {
            position: absolute;
            right: 10px;
            bottom: 30px;
            background: white;
            border-radius: var(--border-radius);
            padding: 10px;
            box-shadow: var(--shadow-md);
            z-index: 1000;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .legend-label {
            font-size: 12px;
        }

        @media (max-width: 768px) {
            * {
                transition: background-color 0.2s ease, transform 0.2s ease;
            }
            body {
                font-size: 16px;
                line-height: 1.7;
                background-color: #f5f7fa;
            }

            header {
                padding: 1rem 1.25rem;
                position: sticky;
                top: 0;
                z-index: 1000;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            }

            .header-title h1 {
                font-size: 1.25rem;
                font-weight: 700;
                letter-spacing: -0.5px;
            }

            .header-info {
                font-size: 0.875rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                margin-top: 0.5rem;
            }

            .clock-container {
                font-size: 0.8125rem;
                padding: 0.375rem 0.75rem;
                border-radius: 6px;
                font-weight: 500;
            }

            .dashboard-container {
                display: block;
                margin: 0;
                padding: 1rem;
                gap: 0;
            }

            .panel,
            .webcam-container {
                border-radius: 16px;
                margin-bottom: 1.25rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
                background: white;
                overflow: hidden;
            }

            .panel-header,
            .webcam-header {
                padding: 1.25rem;
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border-bottom: 1px solid var(--gray-100);
            }

            .panel-header h2,
            .webcam-header h2 {
                font-size: 1.25rem;
                font-weight: 700;
                color: var(--gray-900);
                letter-spacing: -0.3px;
            }

            .panel-content {
                padding: 1.25rem;
            }

            .stats-container {
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }

            .stat-item {
                padding: 1rem;
                border-radius: 8px;
            }

            .stat-label {
                font-size: 0.8125rem;
            }

            .stat-value {
                font-size: 1.5rem;
                margin: 0.375rem 0;
            }

            .stat-footer {
                font-size: 0.75rem;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }

            table {
                min-width: 650px;
                font-size: 0.875rem;
            }

            th {
                font-size: 0.8125rem;
                padding: 0.75rem 0.625rem;
                position: sticky;
                top: 0;
                background-color: var(--gray-100);
            }

            td {
                padding: 0.875rem 0.625rem;
            }

            .table-footer {
                padding: 0.75rem 1rem;
                font-size: 0.8125rem;
            }

            .tabs-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                border-radius: 0;
            }

            .tabs-container::-webkit-scrollbar {
                display: none;
            }

            .tab {
                padding: 0.875rem 1.25rem;
                font-size: 0.9375rem;
                min-width: fit-content;
                white-space: nowrap;
            }

            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.9375rem;
                min-height: 44px;
            }

            .radar-container {
                height: 280px;
                border-radius: 0;
            }

            .legend-image {
                max-width: 90%;
            }

            .control-buttons button {
                width: 44px;
                height: 44px;
                font-size: 1rem;
            }

            .radar-timeline {
                padding: 0.75rem;
            }

            .timeline-labels {
                font-size: 0.75rem;
            }

            .modal {
                padding: 0;
            }

            .modal-content {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
            }

            .modal-header {
                padding: 1rem;
                border-bottom: 2px solid var(--gray-200);
            }

            .modal-header h2 {
                font-size: 1.125rem;
            }

            .modal-close {
                width: 44px;
                height: 44px;
                font-size: 1.5rem;
            }

            .modal-body {
                padding: 1rem;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
            }

            #river-chart-container {
                height: 280px;
            }

            #radar-map,
            #flood-map {
                height: 320px;
                border-radius: 0;
            }

            .flood-map-legend {
                right: 8px;
                bottom: 24px;
                padding: 0.5rem;
            }

            .notification {
                width: 100%;
                margin: 0;
                border-radius: 0;
                padding: 1rem;
            }

            .status-panel {
                padding: 1rem;
                display: block;
            }

            .status-item {
                padding: 0.75rem 0;
                border-bottom: 1px solid var(--gray-200);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .status-item:last-child {
                border-bottom: none;
            }

            .status-label,
            .status-value {
                font-size: 0.9375rem;
            }

            .webcam-image-container {
                padding: 0.5rem;
            }

            .webcam-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                font-size: 0.8125rem;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .header-title h1 {
                font-size: 1rem;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 1.375rem;
            }

            table {
                min-width: 600px;
                font-size: 0.8125rem;
            }

            th, td {
                padding: 0.625rem 0.5rem;
            }

            .tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .btn {
                font-size: 0.875rem;
            }

            .control-buttons button {
                width: 42px;
                height: 42px;
            }

            .radar-container {
                height: 240px;
            }

            #river-chart-container {
                height: 240px;
            }

            #radar-map,
            #flood-map {
                height: 280px;
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .modal-content {
                height: 100vh;
            }

            .modal-body {
                max-height: calc(100vh - 70px);
            }

            #river-chart-container,
            .radar-container {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading flood data...</p>
    </div>

    <div id="notification" class="notification">
        <span class="notification-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="10" cy="10" r="8"></circle>
                <line x1="10" y1="6" x2="10" y2="10"></line>
                <line x1="10" y1="14" x2="10.01" y2="14"></line>
            </svg>
        </span>
        <div id="notification-message" class="notification-content"></div>
        <button class="notification-close" onclick="document.getElementById('notification').classList.remove('show')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    <header>
        <div class="header-content">
            <div class="header-title">
                <h1>Lismore Flood Emergency Dashboard</h1>
            </div>
            <div class="header-info">
                <div id="clock" class="clock-container">Loading time...</div>
                <div>Last updated: <span id="last-update-time">Never</span></div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <main>
            <div class="panel">
                <div class="tabs-container">
                    <div class="tabs">
                        <button id="tab-webcam" class="tab-button active">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M23 7l-7 5 7 5V7z"></path>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                            </svg>
                            Traffic Camera
                        </button>
                        <button id="tab-radar" class="tab-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <circle cx="12" cy="12" r="6"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                            </svg>
                            Rainfall Radar
                        </button>
                        <button id="tab-cyclone" class="tab-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 32 32" fill="currentColor" style="transform: scaleX(-1);">
                                <path d="M16,21a5,5,0,1,1,5-5A5.0057,5.0057,0,0,1,16,21Zm0-8a3,3,0,1,0,3,3A3.0033,3.0033,0,0,0,16,13Z"></path>
                                <path d="M22.6521,4.1821l-2.177,2.5142L19.0713,8.3174,20.7864,9.605A7.9361,7.9361,0,0,1,23.9963,16l.0008.0576.0017.0415c.018.4317.2412,10.1113-14.6538,11.7222l2.18-2.5176,1.4039-1.6211L11.2139,22.395A7.9361,7.9361,0,0,1,8.0037,16l-.0008-.0576-.0017-.0415C7.9832,15.47,7.7605,5.8071,22.6521,4.1821M24.9978,2c-.0164,0-.0327,0-.0493.001C5.2532,2.9146,6.0037,16,6.0037,16a9.975,9.975,0,0,0,4.0095,7.9946L6.2368,28.3555A1.0044,1.0044,0,0,0,7.0022,30c.0164,0,.0327,0,.0493-.001C26.7468,29.0854,25.9963,16,25.9963,16a9.9756,9.9756,0,0,0-4.0092-7.9946l3.7761-4.3609A1.0044,1.0044,0,0,0,24.9978,2Z"></path>
                            </svg>
                            Cyclone Map
                        </button>
                        <button id="tab-floodmap" class="tab-button">
                            <svg width="16px" height="16px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                            <title>flood</title>
                            <path d="M26.885 13.116c-0.226-0.226-0.539-0.366-0.884-0.366-0.445 0-0.836 0.233-1.058 0.583l-0.003 0.005c-1.395 2.232-2.758 3.413-3.939 3.413s-2.545-1.181-3.94-3.413c-0.238-0.334-0.624-0.549-1.060-0.549s-0.822 0.215-1.057 0.545l-0.003 0.004c-1.395 2.232-2.757 3.413-3.939 3.413s-2.545-1.181-3.939-3.413c-0.224-0.355-0.615-0.588-1.060-0.588-0.345 0-0.658 0.14-0.884 0.366l-4 4c-0.226 0.226-0.366 0.539-0.366 0.884 0 0.69 0.56 1.25 1.25 1.25 0.345 0 0.658-0.14 0.884-0.366l2.933-2.934c3.248 4.354 6.93 4.428 10.184 0.24 1.073 1.714 2.884 2.881 4.976 3.057l0.024 0.002c2.218-0.205 4.103-1.465 5.167-3.268l0.017-0.031 2.932 2.934c0.227 0.228 0.541 0.37 0.888 0.37 0.691 0 1.251-0.56 1.251-1.251 0-0.347-0.141-0.661-0.369-0.887l-0-0zM2.884 8.884l2.933-2.933c3.246 4.352 6.929 4.429 10.184 0.24 3.256 4.187 6.936 4.111 10.184-0.24l2.932 2.933c0.226 0.227 0.539 0.367 0.885 0.367 0.691 0 1.251-0.56 1.251-1.251 0-0.345-0.14-0.658-0.366-0.884v0l-4-4c-0.226-0.226-0.539-0.366-0.885-0.366-0.445 0-0.836 0.232-1.058 0.582l-0.003 0.005c-1.395 2.232-2.758 3.413-3.939 3.413s-2.545-1.181-3.94-3.413c-0.238-0.333-0.624-0.548-1.059-0.548s-0.822 0.215-1.057 0.545l-0.003 0.004c-1.396 2.231-2.758 3.412-3.94 3.412s-2.545-1.181-3.94-3.412c-0.199-0.316-0.529-0.534-0.912-0.579l-0.006-0.001c-0.040-0.005-0.087-0.007-0.135-0.007-0.347 0-0.662 0.14-0.891 0.366l-4 4c-0.225 0.226-0.363 0.537-0.363 0.881 0 0.69 0.56 1.25 1.25 1.25 0.344 0 0.655-0.139 0.881-0.363l-0 0zM26.885 23.115c-0.226-0.226-0.539-0.365-0.884-0.365-0.445 0-0.836 0.233-1.058 0.583l-0.003 0.005c-1.395 2.232-2.758 3.412-3.939 3.412s-2.545-1.18-3.94-3.412c-0.238-0.333-0.624-0.548-1.060-0.548s-0.822 0.215-1.057 0.544l-0.003 0.004c-1.395 2.232-2.757 3.412-3.939 3.412s-2.545-1.18-3.939-3.412c-0.225-0.355-0.616-0.588-1.061-0.588-0.345 0-0.657 0.14-0.884 0.366l-4 4c-0.227 0.226-0.367 0.539-0.367 0.885 0 0.691 0.56 1.251 1.251 1.251 0.345 0 0.658-0.14 0.884-0.366v0l2.933-2.934c3.248 4.352 6.93 4.426 10.184 0.24 1.073 1.714 2.884 2.881 4.976 3.057l0.024 0.002c2.218-0.205 4.103-1.465 5.167-3.268l0.017-0.031 2.932 2.934c0.226 0.226 0.539 0.366 0.884 0.366 0.691 0 1.251-0.56 1.251-1.251 0-0.345-0.14-0.658-0.366-0.884l0 0z"></path>
                            </svg>
                            Flood Map
                        </button>
                        <button id="tab-outage" class="tab-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 20V10"></path>
                                <path d="M12 20V4"></path>
                                <path d="M6 20v-6"></path>
                            </svg>
                            Power Outages
                        </button>
                    </div>
                </div>
                
                <div class="tab-content-container">
                    <div id="content-webcam" class="tab-content active">
                        <div class="tab-header">
                            <h2>Bruxner Highway Lismore - Live Traffic Camera</h2>
                            <div>
                                <button id="refresh-webcam" class="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="webcam-image-container">
                            <img id="webcam" src="https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/bruxner_highway_lismore.jpeg" alt="Bruxner Highway Lismore Traffic Camera" class="webcam-image">
                            <div id="webcam-error" class="webcam-error">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                Unable to load webcam image
                            </div>
                        </div>
                        <div class="tab-footer">
                            <span>Image auto-updates every few seconds</span>
                            <span id="webcam-timestamp">Loading...</span>
                        </div>
                    </div>
                    
                    <div id="content-radar" class="tab-content">
                        <div class="tab-header">
                            <h2>Grafton 256km Radar</h2>
                            <div>
                                <button id="refresh-btn" class="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div id="error" class="error" style="display: none;"></div>
                        
                        <div class="radar-wrapper">
                            <div class="radar-display">
                                <div class="radar-container">
                                    <img id="background-layer" class="map-layer" src="" alt="Background Map" style="z-index: 1;">
                                    <img id="topography-layer" class="map-layer" src="" alt="Topography" style="z-index: 2;">
                                    <img id="radar-image" class="radar-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Radar Image" style="z-index: 3;">
                                    <img id="locations-layer" class="map-layer" src="" alt="Locations" style="z-index: 4;">
                                    
                                    <div id="loading" class="loading">
                                        <div class="spinner"></div>
                                        Loading radar images...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="legend-container">
                                <img src="/resources/Rain Radar/legend.png" alt="Radar Legend" class="legend-image">
                            </div>
                            
                            <div id="timestamp">No data loaded</div>
                            <div id="frame-counter" class="frame-counter"></div>
                            
                            <div class="progress-container">
                                <div id="progress-bar" class="progress-bar"></div>
                            </div>
                            
                            <div class="controls">
                                <div class="control-buttons">
                                    <button id="btn-first" disabled title="First frame">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-prev" disabled title="Previous frame">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-play" disabled title="Play">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M8 5v14l11-7z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-pause" disabled title="Pause">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-next" disabled title="Next frame">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
                                        </svg>
                                    </button>
                                    <button id="btn-last" disabled title="Last frame">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="speed-controls">
                                    <label for="speed">Speed:</label>
                                    <input type="range" id="speed" class="speed-slider" min="1" max="10" value="5">
                                    <span id="speed-value">500ms</span>
                                </div>
                            </div>
                            
                            <div class="layer-controls">
                                <label class="layer-toggle">
                                    <input type="checkbox" id="topography-toggle" checked>
                                    Topography
                                </label>
                                <label class="layer-toggle">
                                    <input type="checkbox" id="locations-toggle" checked>
                                    Locations
                                </label>
                            </div>
                            
                            <div id="last-update" class="last-update"></div>
                        </div>
                        
                        <div class="tab-footer">
                            <span>Data source: Bureau of Meteorology, Australia</span>
                            <a href="http://www.bom.gov.au/products/IDR282.loop.shtml" target="_blank" rel="noopener noreferrer" class="tab-link">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                View BOM original
                            </a>
                        </div>
                    </div>
                    
                    <div id="content-cyclone" class="tab-content">
                        <div class="tab-header">
                            <h2>Tropical Cyclone Forecast Track Map</h2>
                            <div>
                                <button id="refresh-cyclone" class="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="cyclone-container">
                            <img id="cyclone-image" src="http://www.bom.gov.au/fwo/IDQ65001.png" alt="Tropical Cyclone Forecast Track Map" class="cyclone-image">
                            <div id="cyclone-error" class="cyclone-error">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                Unable to load cyclone map
                            </div>
                        </div>
                        <div class="tab-footer">
                            <a href="http://www.bom.gov.au/cyclone/" target="_blank" rel="noopener noreferrer" class="tab-link">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                View detailed cyclone information
                            </a>
                            <span id="cyclone-timestamp">Loading...</span>
                        </div>
                    </div>

                    <div id="content-floodmap" class="tab-content">
                        <div class="tab-header">
                            <h2>Lismore Flood Impact Map</h2>
                            <div>
                                <button id="refresh-floodmap" class="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="flood-map-container">
                            <div id="flood-map"></div>
                            
                            <div class="flood-map-legend">
                                <div class="legend-title">Impact Legend</div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                                    <div class="legend-label">Floor Level Affected (Critical)</div>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #f39c12;"></div>
                                    <div class="legend-label">Gate Level Affected (Warning)</div>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #f1c40f;"></div>
                                    <div class="legend-label">Road Centre Affected (Alert)</div>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #2ecc71;"></div>
                                    <div class="legend-label">Not Affected (Safe)</div>
                                </div>
                            </div>
                            
                            <div id="flood-loading-overlay" class="loading-overlay">
                                <div class="spinner"></div>
                                <p id="flood-loading-status">Processing flood data...</p>
                                <div class="progress-container">
                                    <div class="progress-bar" id="flood-processing-progress"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flood-controls">
                            <div class="flood-controls-inner">
                                <div class="flood-slider-container">
                                    <div class="flood-height-label">
                                        <span>Flood Water Height:</span>
                                        <span class="flood-height-value" id="flood-height-display">12.0m</span>
                                    </div>
                                    <input type="range" id="flood-height-slider" class="flood-slider" min="1.55" max="40.44" step="0.1" value="12.0">
                                </div>
                                
                                <div class="flood-toggle-container">
                                    <button id="use-current-level" class="button">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 2v6"></path>
                                            <path d="M12 22v-6"></path>
                                            <path d="M4.93 4.93L9 9"></path>
                                            <path d="M14.36 14.36L18.07 18.07"></path>
                                            <path d="M2 12h6"></path>
                                            <path d="M22 12h-6"></path>
                                            <path d="M4.93 19.07L9 15"></path>
                                            <path d="M14.36 9.64L18.07 5.93"></path>
                                        </svg>
                                        Use Current Level
                                    </button>
                                    
                                    <div class="toggle-group">
                                        <div class="toggle-option">
                                            <input type="radio" id="flood-show-markers" name="floodViewMode" checked>
                                            <label for="flood-show-markers" class="toggle-label">Markers</label>
                                        </div>
                                        <div class="toggle-option">
                                            <input type="radio" id="flood-show-heatmap" name="floodViewMode">
                                            <label for="flood-show-heatmap" class="toggle-label">Heatmap</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="flood-stats-container" class="flood-stats-container">
                                <div class="flood-stat-title">Impact Summary at <span id="flood-stats-height">12.0m</span></div>
                                <div class="flood-stat-grid">
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Properties Analyzed</div>
                                        <div class="flood-stat-value" id="flood-stat-total">0</div>
                                    </div>
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Floor Level Affected</div>
                                        <div class="flood-stat-value" id="flood-stat-critical">0 <span class="category-badge category-critical">Critical</span></div>
                                    </div>
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Gate Level Affected</div>
                                        <div class="flood-stat-value" id="flood-stat-warning">0 <span class="category-badge category-warning">Warning</span></div>
                                    </div>
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Road Level Affected</div>
                                        <div class="flood-stat-value" id="flood-stat-alert">0 <span class="category-badge category-alert">Alert</span></div>
                                    </div>
                                    <div class="flood-stat-item">
                                        <div class="flood-stat-label">Not Affected</div>
                                        <div class="flood-stat-value" id="flood-stat-safe">0 <span class="category-badge category-safe">Safe</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="content-outage" class="tab-content">
                        <div class="tab-header">
                            <h2>Essential Energy Power Outages</h2>
                            <div>
                                <a href="https://www.essentialenergy.com.au/outages-and-faults/power-outages" target="_blank" rel="noopener noreferrer" class="button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                    Open Map
                                </a>
                            </div>
                        </div>
                        <div class="outage-map-wrapper">
                            <div id="outage-map"></div>
                            
                            <div class="outage-legend">
                                <div class="legend-title">Outage Categories</div>
                                <label>
                                    <input type="radio" name="outage-category" id="radio-current-outage" value="current" checked />
                                    <div class="legend-content">
                                        <span class="outage-dot cur"></span>
                                        <span>Current Outages</span>
                                    </div>
                                </label>
                                <label>
                                    <input type="radio" name="outage-category" id="radio-future-outage" value="future" />
                                    <div class="legend-content">
                                        <span class="outage-dot fut"></span>
                                        <span>Planned Outages</span>
                                    </div>
                                </label>
                                <label>
                                    <input type="radio" name="outage-category" id="radio-cancelled-outage" value="cancelled" />
                                    <div class="legend-content">
                                        <span class="outage-dot can"></span>
                                        <span>Cancelled</span>
                                    </div>
                                </label>
                                <div class="legend-note">
                                    Select a category to view on map
                                </div>
                            </div>
                        </div>
                        
                        <div class="outage-controls-panel">
                            <div class="outage-controls-inner">
                                <div class="outage-control-group">
                                    <button class="button" id="outage-fit-bounds" title="Fit all outages in view">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                                        </svg>
                                        Fit to View
                                    </button>
                                    <button class="button" id="outage-locate-me" title="Center on your location">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        My Location
                                    </button>
                                </div>
                            </div>
                            
                            <div class="outage-stats-container">
                                <div class="outage-stats-title">Network Status Overview</div>
                                <div class="outage-stats-grid">
                                    <div class="outage-stat-card">
                                        <div class="stat-label">Current Outages</div>
                                        <div class="stat-value">
                                            <span id="outage-stat-current">0</span>
                                            <span class="outage-stat-badge current">Active</span>
                                        </div>
                                    </div>
                                    <div class="outage-stat-card">
                                        <div class="stat-label">Planned Outages</div>
                                        <div class="stat-value">
                                            <span id="outage-stat-future">0</span>
                                            <span class="outage-stat-badge future">Scheduled</span>
                                        </div>
                                    </div>
                                    <div class="outage-stat-card">
                                        <div class="stat-label">Cancelled</div>
                                        <div class="stat-value">
                                            <span id="outage-stat-cancelled">0</span>
                                            <span class="outage-stat-badge cancelled">Resolved</span>
                                        </div>
                                    </div>
                                    <div class="outage-stat-card">
                                        <div class="stat-label">Currently Affected</div>
                                        <div class="stat-value">
                                            <span id="outage-stat-customers">0</span>
                                            <span style="font-size: 0.875rem; color: var(--gray-600)">customers</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-footer">
                            <span>Last updated: <span id="outage-last-update">Never</span></span>
                            <a href="https://www.essentialenergy.com.au/outages-and-faults/power-outages" target="_blank" rel="noopener noreferrer" class="tab-link">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                View on Essential Energy
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2>Wilsons River Flood Data</h2>
                    <div class="refresh-controls">
                        <select id="refresh-interval" class="button secondary">
                            <option value="300000">Refresh: 5 min</option>
                            <option value="60000">Refresh: 1 min</option>
                            <option value="600000">Refresh: 10 min</option>
                            <option value="1800000">Refresh: 30 min</option>
                        </select>
                        <button id="refresh-now" class="button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 2v6h-6"></path>
                                <path d="M3 12a9 9 0 0 1 15-6.7l3-3"></path>
                                <path d="M3 22v-6h6"></path>
                                <path d="M21 12a9 9 0 0 1-15 6.7l-3 3"></path>
                            </svg>
                            Refresh Now
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="panel-alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <span>EMERGENCY USE: This dashboard fetches LIVE data from the Bureau of Meteorology. Always follow directions from emergency services during flood events.</span>
                    </div>

                    <div class="table-container">
                        <table id="flood-data">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Time</th>
                                    <th>Water Level (m)</th>
                                    <th>Status</th>
                                    <th>Flood Category</th>
                                </tr>
                            </thead>
                            <tbody id="flood-data-body">
                                <tr>
                                    <td colspan="5" style="text-align: center;">Loading data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        Data auto-refreshes based on selected interval
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2>Data Sources & Status</h2>
                </div>
                <div class="status-panel">
                    <div id="proxy-status" class="status-item">
                        <span class="status-label">Proxy Server:</span>
                        <span class="status-value" id="proxy-status-value">Checking...</span>
                    </div>
                    <div id="bom-status" class="status-item">
                        <span class="status-label">BOM Data:</span>
                        <span class="status-value" id="bom-status-value">Checking...</span>
                    </div>
                    <div id="webcam-status" class="status-item">
                        <span class="status-label">Traffic Camera:</span>
                        <span class="status-value" id="webcam-status-value">Checking...</span>
                    </div>
                    <div class="status-actions">
                        <button id="check-status" class="button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 2v6h-6"></path>
                                <path d="M3 12a9 9 0 0 1 15-6.7l3-3"></path>
                                <path d="M3 22v-6h6"></path>
                                <path d="M21 12a9 9 0 0 1-15 6.7l-3 3"></path>
                            </svg>
                            Check Status
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <aside>
            <div class="panel">
                <div class="panel-header">
                    <h2>Flood Statistics</h2>
                </div>
                <div class="panel-content">
                    <div class="stats-container" id="stats-container">
                        <div class="stat-item">
                            <div class="stat-label">Wilsons R at Lismore (mAHD)</div>
                            <div id="lismore-level" class="stat-value">-</div>
                            <div id="lismore-status" class="stat-footer">Loading...</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Highest Reading</div>
                            <div id="highest-reading" class="stat-value">-</div>
                            <div id="highest-location" class="stat-footer">Loading...</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Rising Locations</div>
                            <div id="rising-count" class="stat-value">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Falling Locations</div>
                            <div id="falling-count" class="stat-value">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="emergency-contacts">
                <div class="emergency-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                    Emergency Contacts
                </div>
                <div class="emergency-content">
                    <h3>SES Emergency</h3>
                    <div class="emergency-number">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        132 500
                    </div>
                    
                    <h3>Life Threatening Emergencies</h3>
                    <div class="emergency-number">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        000
                    </div>
                    
                    <div class="evacuation-centers">
                        <h3>Evacuation Centers</h3>
                        <ul class="center-list">
                            <li>
                                <strong>Southern Cross University</strong>
                                Military Rd, East Lismore
                            </li>
                            <li>
                                <strong>Lismore City Hall</strong>
                                1 Bounty St, Lismore
                            </li>
                            <li>
                                <strong>Goonellabah Sports & Aquatic Centre</strong>
                                50 Oliver Ave, Goonellabah
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="resources-panel">
                <div class="resources-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    Useful Resources
                </div>
                <div class="resources-content">
                    <ul class="resources-list">
                        <li>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            <div class="resource-item-content">
                                <strong>Lismore Flood History</strong>
                                <p>Comprehensive historical flood data for Lismore</p>
                                <a href="https://australiasevereweather.com/floods/index.html" target="_blank" rel="noopener noreferrer" class="resource-link">
                                    Visit Website
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                        </li>
                        <li>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                                <line x1="8" y1="2" x2="8" y2="18"></line>
                                <line x1="16" y1="6" x2="16" y2="22"></line>
                            </svg>
                            <div class="resource-item-content">
                                <strong>Flood Map Tool</strong>
                                <p>Interactive flood mapping tool showing affected areas by height</p>
                                <a href="https://www.floodmap.net/" target="_blank" rel="noopener noreferrer" class="resource-link">
                                    Open Map Tool
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                        </li>
                        <li>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                            </svg>
                            <div class="resource-item-content">
                                <strong>BOM Lismore</strong>
                                <p>Bureau of Meteorology's new beta site for Lismore</p>
                                <a href="https://beta.bom.gov.au/poi-location/australia/new-south-wales/northern-rivers/nsw_pt079-lismore" target="_blank" rel="noopener noreferrer" class="resource-link">
                                    View BOM Site
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                        </li>
                        <li>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <div class="resource-item-content">
                                <strong>NSW SES - Flood Safety</strong>
                                <p>Official resources and safety information</p>
                                <a href="https://www.ses.nsw.gov.au/disaster-tabs-header/flood/" target="_blank" rel="noopener noreferrer" class="resource-link">
                                    Safety Information
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>
    </div>

    <footer class="data-attribution">
        <p>Data sourced from <a href="http://www.bom.gov.au" target="_blank" rel="noopener noreferrer">Bureau of Meteorology</a> and <a href="https://www.transport.nsw.gov.au" target="_blank" rel="noopener noreferrer">Transport for NSW</a>.</p>
        <p>This dashboard is for emergency use during flood events in the Lismore area.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
        const leveeCoordinates = [
            [153.2779234789894, -28.80564897533751], [153.2776284287106, -28.80583653192451],
            [153.2775473935466, -28.80578584679196], [153.2774086343345, -28.80589734283666],
            [153.2773869897634, -28.80594964071906], [153.2774102741197, -28.80596169296753],
            [153.2773249113709, -28.80610037084291], [153.2771329846015, -28.80599601019963],
            [153.2770561642849, -28.80609599092546], [153.2769759706041, -28.80607065351402],
            [153.2769225873773, -28.80615138249765], [153.2771238902704, -28.80627143942861],
            [153.2771042437316, -28.80631013165758], [153.2770393628764, -28.80627702301991],
            [153.2770241261831, -28.80629441993291], [153.2769220530088, -28.80624117453304],
            [153.2768766932163, -28.80632282295921], [153.2769696013465, -28.80638388213526],
            [153.2768686212507, -28.80654609791701], [153.2766122114514, -28.80641321031905],
            [153.2762852689198, -28.80687177730074], [153.27623452077, -28.80688817209607],
            [153.2759469768278, -28.80671352421123], [153.2757810011812, -28.8066576253247],
            [153.2755564149109, -28.80697526665091], [153.2757588315603, -28.80711770645244],
            [153.2757357547251, -28.80717838893401], [153.2758506705051, -28.80723784361079],
            [153.275819962155, -28.80728629171487], [153.2757402582966, -28.80729438003862],
            [153.2756002918833, -28.80749807647723], [153.2757079015264, -28.80754879741433],
            [153.2755268407124, -28.80784997889503], [153.275534526505, -28.807891520335],
            [153.2755636339584, -28.80792475454313], [153.2753084206615, -28.80829011404793],
            [153.2753498432981, -28.808315156535], [153.2753462077596, -28.80837176440883],
            [153.2755912039843, -28.80851963768052], [153.275495379482, -28.80865023484822],
            [153.2754382615978, -28.80864280421942], [153.275343368243, -28.8087559250459],
            [153.2752998891227, -28.80892014140416], [153.2749823509539, -28.80899625576804],
            [153.2745141767591, -28.80923041219856], [153.2742101627201, -28.80946447124336],
            [153.2739078774804, -28.80966753062161], [153.2734055703105, -28.81013081939378],
            [153.2730680212187, -28.81031728641019], [153.2729078113743, -28.81048653329279],
            [153.2724986320497, -28.81049177556017], [153.2724255633508, -28.81059853360265],
            [153.2723476330192, -28.81062356600956], [153.2722830179564, -28.81072680961973],
            [153.272087876255, -28.81087734874062], [153.2718494740316, -28.81118854434206],
            [153.2717288404832, -28.81137281375635], [153.2714104828596, -28.81143925272617],
            [153.2712177644198, -28.81154772674801], [153.2712141581074, -28.81186060127457],
            [153.2711843689477, -28.81202484689156], [153.2709624213483, -28.81234344931174],
            [153.2707696671584, -28.81254049551611], [153.2707214619768, -28.81267071518178],
            [153.2707080191103, -28.81282324626406], [153.2706690168997, -28.81297114289579],
            [153.2708940313762, -28.81336688046893], [153.2709231093674, -28.81356763137908],
            [153.2711906807951, -28.81358726843914]
        ];
        
        const leveeAreaCoordinates = [
            [153.2779234789894, -28.80564897533751], [153.2776284287106, -28.80583653192451],
            [153.2775473935466, -28.80578584679196], [153.2774086343345, -28.80589734283666],
            [153.2773869897634, -28.80594964071906], [153.2774102741197, -28.80596169296753],
            [153.2773249113709, -28.80610037084291], [153.2771329846015, -28.80599601019963],
            [153.2770561642849, -28.80609599092546], [153.2769759706041, -28.80607065351402],
            [153.2769225873773, -28.80615138249765], [153.2771238902704, -28.80627143942861],
            [153.2771042437316, -28.80631013165758], [153.2770393628764, -28.80627702301991],
            [153.2770241261831, -28.80629441993291], [153.2769220530088, -28.80624117453304],
            [153.2768766932163, -28.80632282295921], [153.2769696013465, -28.80638388213526],
            [153.2768686212507, -28.80654609791701], [153.2766122114514, -28.80641321031905],
            [153.2762852689198, -28.80687177730074], [153.27623452077, -28.80688817209607],
            [153.2759469768278, -28.80671352421123], [153.2757810011812, -28.8066576253247],
            [153.2755564149109, -28.80697526665091], [153.2757588315603, -28.80711770645244],
            [153.2757357547251, -28.80717838893401], [153.2758506705051, -28.80723784361079],
            [153.275819962155, -28.80728629171487], [153.2757402582966, -28.80729438003862],
            [153.2756002918833, -28.80749807647723], [153.2757079015264, -28.80754879741433],
            [153.2755268407124, -28.80784997889503], [153.275534526505, -28.807891520335],
            [153.2755636339584, -28.80792475454313], [153.2753084206615, -28.80829011404793],
            [153.2753498432981, -28.808315156535], [153.2753462077596, -28.80837176440883],
            [153.2755912039843, -28.80851963768052], [153.275495379482, -28.80865023484822],
            [153.2754382615978, -28.80864280421942], [153.275343368243, -28.8087559250459],
            [153.2752998891227, -28.80892014140416], [153.2749823509539, -28.80899625576804],
            [153.2745141767591, -28.80923041219856], [153.2742101627201, -28.80946447124336],
            [153.2739078774804, -28.80966753062161], [153.2734055703105, -28.81013081939378],
            [153.2730680212187, -28.81031728641019], [153.2729078113743, -28.81048653329279],
            [153.2724986320497, -28.81049177556017], [153.2724255633508, -28.81059853360265],
            [153.2723476330192, -28.81062356600956], [153.2722830179564, -28.81072680961973],
            [153.272087876255, -28.81087734874062], [153.2718494740316, -28.81118854434206],
            [153.2717288404832, -28.81137281375635], [153.2714104828596, -28.81143925272617],
            [153.2712177644198, -28.81154772674801], [153.2712141581074, -28.81186060127457],
            [153.2711843689477, -28.81202484689156], [153.2709624213483, -28.81234344931174],
            [153.2707696671584, -28.81254049551611], [153.2707214619768, -28.81267071518178],
            [153.2707080191103, -28.81282324626406], [153.2706690168997, -28.81297114289579],
            [153.2708940313762, -28.81336688046893], [153.2709231093674, -28.81356763137908],
            [153.2711906807951, -28.81358726843914], [153.2721123183181, -28.81340143781495],
            [153.2728642861514, -28.81318988160984], [153.2738334696126, -28.81335757506337],
            [153.2754301255504, -28.81362863148366], [153.2781586962226, -28.81137704412088],
            [153.2801633775867, -28.80821818373613], [153.280001902673, -28.80759419775452],
            [153.2799494446037, -28.80677742276964], [153.2788428575995, -28.80616875198943],
            [153.2779234789894, -28.80564897533751]
        ];
        
        const LEVEE_HEIGHT = 10.6;
        const LEVEE_WARNING_THRESHOLD = 9.0;
        
        let leveeLine = null;

        const BASE_URL = 'http://localhost:3000';
        const PROXY_URL = BASE_URL + '/flood-data';

        let embeddedCSVData = [];
        
        async function loadFloodData() {
            try {
                const response = await fetch('/api/flood-properties');
                if (!response.ok) {
                    throw new Error('Failed to load flood data');
                }
                embeddedCSVData = await response.json();

                if (floodMapInitialized && embeddedCSVData && embeddedCSVData.length > 0) {
                    processFloodData(embeddedCSVData);
                }
            } catch (error) {
                console.error('Error loading flood data:', error);
                embeddedCSVData = [];
            }
        }
        
        loadFloodData();

        const loadingOverlay = document.getElementById('loading-overlay');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const webcamImage = document.getElementById('webcam');
        const webcamError = document.getElementById('webcam-error');
        const webcamTimestamp = document.getElementById('webcam-timestamp');
        const floodDataBody = document.getElementById('flood-data-body');
        const lastUpdateTime = document.getElementById('last-update-time');
        const refreshIntervalSelect = document.getElementById('refresh-interval');
        const refreshNowButton = document.getElementById('refresh-now');
        const clockElement = document.getElementById('clock');
        const checkStatusButton = document.getElementById('check-status');
        
        const lismoreLevel = document.getElementById('lismore-level');
        const lismoreStatus = document.getElementById('lismore-status');
        const highestReading = document.getElementById('highest-reading');
        const highestLocation = document.getElementById('highest-location');
        const risingCount = document.getElementById('rising-count');
        const fallingCount = document.getElementById('falling-count');
        
        const proxyStatusValue = document.getElementById('proxy-status-value');
        const bomStatusValue = document.getElementById('bom-status-value');
        const webcamStatusValue = document.getElementById('webcam-status-value');

        const MINOR_FLOOD_LEVEL = 4.20;
        const MODERATE_FLOOD_LEVEL = 7.20;
        const MAJOR_FLOOD_LEVEL = 9.70;
        const WEBCAM_REFRESH_INTERVAL = 1000;
        const DEFAULT_REFRESH_INTERVAL = 300000;
        const CRITICAL_THRESHOLD = 3.00;
        
        const BOM_URL = 'http://www.bom.gov.au/nsw/flood/northern.shtml';

        let floodData = [];
        let refreshTimer = null;
        let webcamRefreshTimer = null;
        let lastFetchTime = null;
        let currentLismoreLevel = null;
        let floodMap = null;
        let floodProperties = [];
        let floodMarkers = null;
        let floodHeatmapLayer = null;
        let floodMapInitialized = false;
        let currentlyOpenFloodMarker = null;

        initializeDashboard();

        function initializeDashboard() {
            updateClock();
            setInterval(updateClock, 1000);
            
            document.getElementById('refresh-cyclone').addEventListener('click', refreshCycloneMap);

            setupTabs();
            
            refreshWebcam();
            webcamRefreshTimer = setInterval(refreshWebcam, WEBCAM_REFRESH_INTERVAL);
            document.getElementById('refresh-webcam').addEventListener('click', refreshWebcam);
            
            const refreshRadarBtn = document.getElementById('refresh-radar') || document.getElementById('refresh-btn');
            if (refreshRadarBtn) {
                refreshRadarBtn.addEventListener('click', refreshRadar);
            }
            
            refreshCycloneMap();
            setInterval(refreshCycloneMap, 1000);

            refreshIntervalSelect.value = DEFAULT_REFRESH_INTERVAL;
            refreshIntervalSelect.addEventListener('change', updateRefreshInterval);

            refreshNowButton.addEventListener('click', fetchFloodData);

            checkDataSources();
            checkStatusButton.addEventListener('click', checkDataSources);

            setupStatusAutoRefresh();
            
            loadCachedData();
            
            fetchFloodData();
            
            updateRefreshInterval();
            
            initFloodMapWithLevee();
        }
        
        function setupStatusAutoRefresh() {
            
            checkDataSources();
            
            const statusCheckInterval = setInterval(checkDataSources, 60000);
            
            window.statusCheckIntervalId = statusCheckInterval;
            
            const statusPanel = document.querySelector('.status-panel');
            
            if (!document.getElementById('status-last-checked')) {
                const lastCheckedElement = document.createElement('div');
                lastCheckedElement.className = 'status-item';
                lastCheckedElement.innerHTML = `
                    <span class="status-label">Last Auto-Check:</span>
                    <span id="status-last-checked" class="status-value">Just now</span>
                `;
                
                const statusActions = document.querySelector('.status-actions');
                if (statusActions) {
                    statusPanel.insertBefore(lastCheckedElement, statusActions);
                } else {
                    statusPanel.appendChild(lastCheckedElement);
                }
            }
            
            const updateLastCheckedTime = () => {
                const lastCheckedElement = document.getElementById('status-last-checked');
                if (lastCheckedElement) {
                    lastCheckedElement.textContent = new Date().toLocaleTimeString('en-AU');
                }
            };
            
            const originalCheckDataSources = checkDataSources;
            window.checkDataSources = function() {
                originalCheckDataSources();
                updateLastCheckedTime();
            };
            
            updateLastCheckedTime();
        }
        
        setupStatusAutoRefresh();

        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('tab-unavailable')) {
                        const reason = button.getAttribute('data-unavailable-reason');
                        showUnavailableContentPopup(button.id, reason);
                        return false;
                    }
                    
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    button.classList.add('active');
                    
                    const contentId = button.id.replace('tab-', 'content-');
                    const contentElement = document.getElementById(contentId);
                    
                    if (contentElement) {
                        contentElement.classList.add('active');
                    } else {
                        console.error(`Tab content element with ID "${contentId}" not found`);
                    }
                    
                    if (button.id === 'tab-floodmap') {
                        setTimeout(() => {
                            window.dispatchEvent(new Event('resize'));
                            if (floodMap) {
                                floodMap.invalidateSize();
                            }
                        }, 100);
                    }
                });
            });
        }
        
        function updateClock() {
            const now = new Date();
            const options = { 
                weekday: 'short',
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            };
            clockElement.textContent = now.toLocaleTimeString('en-AU', options);
        }

        function refreshWebcam() {
            const timestamp = new Date().getTime();
            webcamImage.src = `https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/bruxner_highway_lismore.jpeg?t=${timestamp}`;
            webcamTimestamp.textContent = new Date().toLocaleTimeString('en-AU');
        }

        // Power Outage Map Functionality
        (function() {
            const OUTAGE_API = '/api/outages';
            const outageColors = { current: '#ff4d4f', future: '#f7ba1e', cancelled: '#7aa2f7' };
            
            let outageMap = null;
            let outageLayerGroups = {
                current: null,
                future: null,
                cancelled: null
            };
            let allOutageBounds = [];
            let outageMapInitialized = false;
            let currentlyOpenMarker = null;
            
            function initializeOutageMap() {
                if (outageMapInitialized) return;
                
                const maxBounds = [
                    [-29.2, 152.7],
                    [-28.4, 153.9]
                ];
                
                outageMap = L.map('outage-map', { 
                    zoomControl: true,
                    maxBounds: maxBounds,
                    maxBoundsViscosity: 0.75,
                    minZoom: 10,
                    maxZoom: 18,
                    zoom: 10
                }).setView([-28.836252984829166, 153.30047607421878], 10);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    minZoom: 10,
                    maxZoom: 18,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(outageMap);
                
                outageLayerGroups.current = L.layerGroup().addTo(outageMap);
                outageLayerGroups.future = L.layerGroup();
                outageLayerGroups.cancelled = L.layerGroup();
                
                outageMapInitialized = true;
            }
            
            function createOutageCircle(lat, lon, color, small = false) {
                return L.circleMarker([lat, lon], {
                    radius: small ? 5 : 8,
                    weight: small ? 1.5 : 2,
                    opacity: 1,
                    fillOpacity: small ? 0.9 : 0.7,
                    color: small ? '#fff' : '#fff',
                    fillColor: color
                });
            }
            
            function createOutagePolygon(coordinates, color) {
                const polygon = L.polygon(coordinates, {
                    weight: 2,
                    opacity: 0.8,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.35,
                    smoothFactor: 1
                });
                
                polygon.on('mouseover', function(e) {
                    this.setStyle({
                        weight: 3,
                        fillOpacity: 0.5
                    });
                    e.target._path.style.cursor = 'pointer';
                });
                
                polygon.on('mouseout', function() {
                    this.setStyle({
                        weight: 2,
                        fillOpacity: 0.35
                    });
                });
                
                return polygon;
            }
            
            function createOutageMarker(outage, color) {
                if (outage.polygon && outage.polygon.length > 0) {
                    const group = L.layerGroup();
                    const polygon = createOutagePolygon(outage.polygon, color);
                    polygon.addTo(group);
                    const centerMarker = createOutageCircle(outage.latitude, outage.longitude, color, true);
                    centerMarker.addTo(group);
                    group._polygon = polygon;
                    group._centerMarker = centerMarker;
                    return group;
                } else {
                    return createOutageCircle(outage.latitude, outage.longitude, color, false);
                }
            }
            
            function bindOutagePopup(marker, popupContent, lat, lng, polygon) {
                const popupOptions = {
                    maxWidth: 350,
                    autoPan: false,
                    closeButton: true,
                    offset: [0, -10]
                };
                
                function getOptimalViewSettings(polygon) {
                    if (!polygon || polygon.length < 3) {
                        return {
                            zoom: 14,
                            paddingTopLeft: [50, 320],
                            paddingBottomRight: [50, 120],
                            maxZoom: 17
                        };
                    }

                    const bounds = L.latLngBounds(polygon);
                    const latDiff = Math.abs(bounds.getNorth() - bounds.getSouth());
                    const lngDiff = Math.abs(bounds.getEast() - bounds.getWest());
                    const area = latDiff * lngDiff;

                    if (area < 0.00005) {
                        return {
                            paddingTopLeft: [50, 320],
                            paddingBottomRight: [50, 120],
                            maxZoom: 18
                        };
                    } else if (area < 0.0001) {
                        return {
                            paddingTopLeft: [50, 320],
                            paddingBottomRight: [50, 120],
                            maxZoom: 17
                        };
                    } else if (area < 0.001) {
                        return {
                            paddingTopLeft: [50, 320],
                            paddingBottomRight: [50, 120],
                            maxZoom: 16
                        };
                    } else if (area < 0.01) {
                        return {
                            paddingTopLeft: [50, 340],
                            paddingBottomRight: [50, 130],
                            maxZoom: 15
                        };
                    } else if (area < 0.05) {
                        return {
                            paddingTopLeft: [50, 360],
                            paddingBottomRight: [50, 140],
                            maxZoom: 14
                        };
                    } else {
                        return {
                            paddingTopLeft: [50, 380],
                            paddingBottomRight: [50, 150],
                            maxZoom: 13
                        };
                    }
                }
                
                const clickHandler = function(e) {
                    if (e) {
                        L.DomEvent.stopPropagation(e);
                    }

                    // Check if clicking on the currently open marker
                    const clickedMarker = marker._centerMarker || marker;
                    const isCurrentlyOpen = currentlyOpenMarker === clickedMarker && clickedMarker.isPopupOpen();

                    // If clicking the same marker that's already open, just keep it open
                    if (isCurrentlyOpen) {
                        return;
                    }

                    // Update the currently open marker
                    currentlyOpenMarker = clickedMarker;

                    const settings = getOptimalViewSettings(polygon);

                    if (polygon && polygon.length > 3) {
                        const bounds = L.latLngBounds(polygon);

                        outageMap.flyToBounds(bounds, {
                            paddingTopLeft: settings.paddingTopLeft,
                            paddingBottomRight: settings.paddingBottomRight,
                            duration: 0.5,
                            maxZoom: settings.maxZoom,
                            easeLinearity: 0.2
                        });
                    } else {
                        // Create small bounds for single point to use with padding
                        const offset = 0.0005;
                        const bounds = L.latLngBounds(
                            [lat - offset, lng - offset],
                            [lat + offset, lng + offset]
                        );

                        outageMap.flyToBounds(bounds, {
                            paddingTopLeft: settings.paddingTopLeft,
                            paddingBottomRight: settings.paddingBottomRight,
                            duration: 0.5,
                            maxZoom: settings.maxZoom,
                            easeLinearity: 0.2
                        });
                    }

                    setTimeout(() => {
                        if (marker._centerMarker && marker._centerMarker._popup) {
                            marker._centerMarker.openPopup();
                        } else if (marker._popup) {
                            marker.openPopup();
                        }
                    }, 550);
                };
                
                if (marker._polygon && marker._centerMarker) {
                    // ONLY bind popup to center marker so it always anchors to the center point
                    marker._centerMarker.bindPopup(popupContent, popupOptions);

                    // Both polygon and center marker trigger the same click handler
                    // Click handler will open popup on center marker, ensuring arrow points to center
                    marker._polygon.on('click', clickHandler);
                    marker._centerMarker.on('click', clickHandler);
                } else {
                    marker.bindPopup(popupContent, popupOptions);
                    marker.on('click', clickHandler);
                }
            }
            
            function formatOutageDate(dt) {
                if (!dt) return null;
                try {
                    const date = new Date(dt);
                    if (isNaN(date.getTime())) return null;
                    
                    const day = date.getDate();
                    const month = date.toLocaleString('en-US', { month: 'short' });
                    const year = date.getFullYear();
                    const time = date.toLocaleString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    }).toLowerCase();
                    
                    return `${day} ${month} ${year}, ${time}`;
                } catch {
                    return null;
                }
            }
            
            function escapeHtml(s) {
                if (s == null) return '';
                const div = document.createElement('div');
                div.textContent = String(s);
                return div.innerHTML;
            }
            
            function applyOutageVisibility() {
                const selectedCategory = document.querySelector('input[name="outage-category"]:checked').value;
                
                for (const [k, layer] of Object.entries(outageLayerGroups)) {
                    if (k === selectedCategory) {
                        if (!outageMap.hasLayer(layer)) layer.addTo(outageMap);
                    } else {
                        if (outageMap.hasLayer(layer)) outageMap.removeLayer(layer);
                    }
                }
            }
            
            async function loadOutageData(force = false) {
                const refreshBtn = document.getElementById('refresh-outages');
                if (refreshBtn) refreshBtn.disabled = true;
                
                try {
                    const url = force ? OUTAGE_API + '?refresh=1' : OUTAGE_API;
                    const res = await fetch(url);
                    
                    if (!res.ok) {
                        const text = await res.text();
                        let errorMsg = 'Failed to load outages';
                        try {
                            const json = JSON.parse(text);
                            errorMsg = json.error || json.hint || errorMsg;
                        } catch {
                            errorMsg = text.slice(0, 200);
                        }
                        throw new Error(errorMsg);
                    }
                    
                    const data = await res.json();
                    
                    for (const layer of Object.values(outageLayerGroups)) {
                        layer.clearLayers();
                    }
                    
                    allOutageBounds = [];
                    const counts = { current: 0, future: 0, cancelled: 0 };
                    let currentCustomers = 0;
                    
                    const lockedBounds = {
                        south: -29.076575403045364,
                        north: -28.595374292349927,
                        west: 152.86651611328128,
                        east: 153.73443603515628
                    };
                    
                    for (const f of data.features) {
                        if (!Number.isFinite(f.latitude) || !Number.isFinite(f.longitude)) continue;
                        
                        if (f.latitude <= lockedBounds.south || f.latitude >= lockedBounds.north ||
                            f.longitude <= lockedBounds.west || f.longitude >= lockedBounds.east) {
                            continue;
                        }
                        
                        counts[f.category] = (counts[f.category] || 0) + 1;
                        
                        if (f.category === 'current' && f.customersAffected) {
                            currentCustomers += f.customersAffected;
                        }
                        
                        const marker = createOutageMarker(f, outageColors[f.category]);
                        const cust = f.customersAffected != null ? f.customersAffected.toLocaleString() : 'Not specified';
                        const startTime = f.start ? formatOutageDate(f.start) : 'Not specified';
                        const endTime = f.end ? formatOutageDate(f.end) : 'Not specified';
                        const reason = f.reason && f.reason !== 'Not specified' ? f.reason : 'Not specified';
                        
                        const popupContent = `
                            <div>
                                <div class="outage-popup-title">${escapeHtml(f.name)}</div>
                                <div class="outage-popup-row">
                                    <span class="outage-popup-label">Status</span>
                                    <span class="outage-popup-value">
                                        <span class="outage-popup-badge ${f.category}">${escapeHtml(f.status || f.categoryName)}</span>
                                    </span>
                                </div>
                                <div class="outage-popup-row">
                                    <span class="outage-popup-label">Type</span>
                                    <span class="outage-popup-value">${escapeHtml(f.type)}</span>
                                </div>
                                <div class="outage-popup-row">
                                    <span class="outage-popup-label">Time Off</span>
                                    <span class="outage-popup-value">${escapeHtml(startTime)}</span>
                                </div>
                                <div class="outage-popup-row">
                                    <span class="outage-popup-label">Est. Time On</span>
                                    <span class="outage-popup-value">${escapeHtml(endTime)}</span>
                                </div>
                                <div class="outage-popup-row">
                                    <span class="outage-popup-label">Customers</span>
                                    <span class="outage-popup-value"><strong>${escapeHtml(cust)}</strong></span>
                                </div>
                                <div class="outage-popup-row">
                                    <span class="outage-popup-label">Reason</span>
                                    <span class="outage-popup-value">${escapeHtml(reason)}</span>
                                </div>
                                ${f.lastUpdated ? `
                                <div class="outage-popup-footer">
                                    Last updated: ${escapeHtml(formatOutageDate(f.lastUpdated))}
                                </div>
                                ` : ''}
                            </div>
                        `;
                        
                        bindOutagePopup(marker, popupContent, f.latitude, f.longitude, f.polygon);
                        marker.addTo(outageLayerGroups[f.category]);
                        allOutageBounds.push([f.latitude, f.longitude]);
                    }
                    
                    document.getElementById('outage-stat-current').textContent = counts.current || 0;
                    document.getElementById('outage-stat-future').textContent = counts.future || 0;
                    document.getElementById('outage-stat-cancelled').textContent = counts.cancelled || 0;
                    document.getElementById('outage-stat-customers').textContent = currentCustomers.toLocaleString();
                    
                    applyOutageVisibility();
                    
                    const total = counts.current + counts.future + counts.cancelled;
                    document.getElementById('outage-last-update').textContent = new Date().toLocaleTimeString('en-AU');
                    
                    if (force) {
                        showNotification(`Successfully loaded ${total} outages`, 'success');
                    }
                    
                } catch (error) {
                    console.error('Load outage error:', error);
                    showNotification(error.message, 'error');
                } finally {
                    if (refreshBtn) refreshBtn.disabled = false;
                }
            }
            
            // Setup event listeners when tab becomes active
            const outageTab = document.getElementById('tab-outage');
            if (outageTab) {
                outageTab.addEventListener('click', function() {
                    setTimeout(() => {
                        if (!outageMapInitialized) {
                            initializeOutageMap();
                            loadOutageData();
                        } else {
                            outageMap.invalidateSize();
                        }
                    }, 100);
                });
            }
            
            // Radio button listeners
            document.querySelectorAll('input[name="outage-category"]').forEach(radio => {
                radio.addEventListener('change', applyOutageVisibility);
            });
            
            // Refresh button
            const refreshBtn = document.getElementById('refresh-outages');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => loadOutageData(true));
            }
            
            // Fit bounds button
            const fitBoundsBtn = document.getElementById('outage-fit-bounds');
            if (fitBoundsBtn) {
                fitBoundsBtn.addEventListener('click', () => {
                    if (allOutageBounds.length > 0) {
                        const selectedCategory = document.querySelector('input[name="outage-category"]:checked').value;
                        
                        const categoryBounds = [];
                        outageLayerGroups[selectedCategory].eachLayer(layer => {
                            if (layer._latlng) {
                                categoryBounds.push([layer._latlng.lat, layer._latlng.lng]);
                            } else if (layer._layers) {
                                Object.values(layer._layers).forEach(sublayer => {
                                    if (sublayer._latlng) {
                                        categoryBounds.push([sublayer._latlng.lat, sublayer._latlng.lng]);
                                    }
                                });
                            }
                        });
                        
                        if (categoryBounds.length > 0) {
                            const bounds = L.latLngBounds(categoryBounds);
                            outageMap.fitBounds(bounds.pad(0.1));
                            showNotification(`Showing ${categoryBounds.length} ${selectedCategory} outages`, 'info');
                        } else {
                            outageMap.setView([-28.836252984829166, 153.30047607421878], 10);
                            showNotification(`No ${selectedCategory} outages in this region`, 'warning');
                        }
                    } else {
                        showNotification('No outages to display', 'warning');
                    }
                });
            }
            
            // Locate me button
            const locateMeBtn = document.getElementById('outage-locate-me');
            if (locateMeBtn) {
                locateMeBtn.addEventListener('click', () => {
                    if ('geolocation' in navigator) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const { latitude, longitude } = position.coords;
                                outageMap.setView([latitude, longitude], 13);
                                L.marker([latitude, longitude])
                                    .addTo(outageMap)
                                    .bindPopup(' Your Location')
                                    .openPopup();
                                showNotification('Centered on your location', 'success');
                            },
                            (error) => {
                                showNotification('Could not get your location: ' + error.message, 'error');
                            }
                        );
                    } else {
                        showNotification('Geolocation not supported by your browser', 'warning');
                    }
                });
            }
            
            // Close popup on user-initiated map interaction (scroll, drag, zoom) - same as flood map
            if (outageMap) {
                outageMap.getContainer().addEventListener('wheel', () => {
                    currentlyOpenMarker = null;
                    outageMap.closePopup();
                }, { passive: true });

                outageMap.on('zoomstart', () => {
                    currentlyOpenMarker = null;
                    outageMap.closePopup();
                });

                outageMap.on('dragstart', () => {
                    currentlyOpenMarker = null;
                    outageMap.closePopup();
                });

                outageMap.on('movestart', () => {
                    currentlyOpenMarker = null;
                    outageMap.closePopup();
                });
            }
            
            // Auto-refresh every 5 minutes
            setInterval(() => {
                const outageContent = document.getElementById('content-outage');
                if (outageContent && outageContent.classList.contains('active')) {
                    loadOutageData(false);
                }
            }, 5 * 60 * 1000);
        })();

        function checkDataSources() {
            proxyStatusValue.textContent = 'Checking...';
            proxyStatusValue.className = 'status-value';
            bomStatusValue.textContent = 'Checking...';
            bomStatusValue.className = 'status-value';
            webcamStatusValue.textContent = 'Checking...';
            webcamStatusValue.className = 'status-value';
            
            const radarStatusValue = document.getElementById('radar-status-value') || 
                                    createStatusElement('radar-status', 'Radar Image');
            
            const cycloneStatusValue = document.getElementById('cyclone-status-value') || 
                                      createStatusElement('cyclone-status', 'Cyclone Map');
            
            const floodMapStatusValue = document.getElementById('floodmap-status-value') || 
                                      createStatusElement('floodmap-status', 'Flood Map');
            
            fetch(PROXY_URL, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        proxyStatusValue.textContent = 'Online';
                        proxyStatusValue.className = 'status-value online';
                    } else {
                        proxyStatusValue.textContent = 'Error: ' + response.status;
                        proxyStatusValue.className = 'status-value offline';
                    }
                })
                .catch(error => {
                    proxyStatusValue.textContent = 'Offline';
                    proxyStatusValue.className = 'status-value offline';
                    console.error('Proxy server check failed:', error);
                });
            
            fetch(PROXY_URL)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.length > 0) {
                        bomStatusValue.textContent = 'Updated: ' + new Date(data.timestamp).toLocaleTimeString('en-AU');
                        bomStatusValue.className = 'status-value online';
                    } else {
                        bomStatusValue.textContent = 'No Data Available';
                        bomStatusValue.className = 'status-value offline';
                    }
                })
                .catch(error => {
                    bomStatusValue.textContent = 'Connection Error';
                    bomStatusValue.className = 'status-value offline';
                    console.error('BOM data check failed:', error);
                });
            
            const img = new Image();
            img.onload = function() {
                webcamStatusValue.textContent = 'Online';
                webcamStatusValue.className = 'status-value online';
            };
            img.onerror = function() {
                webcamStatusValue.textContent = 'Offline';
                webcamStatusValue.className = 'status-value offline';
            };
            img.src = 'https://webcams.transport.nsw.gov.au/livetraffic-webcams/cameras/bruxner_highway_lismore.jpeg?' + new Date().getTime();
            
            window.radarGlobalState = window.radarGlobalState || {
                currentAnimationSessionId: 0,
                lastRefreshTime: 0,
                isRefreshing: false,
                isPlaying: false,
                animationLock: false,
                allTimeoutIds: new Set(),
                forceClearInterval: null,
                animationInterval: null,
                radarInitialized: false
            };

            function initializeRadar() {
                if (window.radarGlobalState.radarInitialized) {
                    console.warn('Radar already initialized');
                    return;
                }
                window.radarGlobalState.radarInitialized = true;

                const radarImage = document.getElementById('radar-image');
                const backgroundLayer = document.getElementById('background-layer');
                const topographyLayer = document.getElementById('topography-layer');
                const locationsLayer = document.getElementById('locations-layer');
                const loading = document.getElementById('loading');
                const timestamp = document.getElementById('timestamp');
                const frameCounter = document.getElementById('frame-counter');
                const progressBar = document.getElementById('progress-bar');
                const btnFirst = document.getElementById('btn-first');
                const btnLast = document.getElementById('btn-last');
                const btnPlay = document.getElementById('btn-play');
                const btnPause = document.getElementById('btn-pause');
                const btnPrev = document.getElementById('btn-prev');
                const btnNext = document.getElementById('btn-next');
                const refreshBtn = document.getElementById('refresh-btn');
                const speedSlider = document.getElementById('speed');
                const speedValue = document.getElementById('speed-value');
                const errorElement = document.getElementById('error');
                const lastUpdate = document.getElementById('last-update');

                const topographyToggle = document.getElementById('topography-toggle');
                const locationsToggle = document.getElementById('locations-toggle');

                const RADAR_ID = 'IDR282';
                let radarImages = [];
                let currentFrame = 0;
                let animationDelay = 500;
                let animationRequestId = null;
                let mapLayersLoaded = false;
                let preloadedImages = new Map();
                const ANIMATION_LOCKOUT_MS = 0;
                
                function formatDate(dateString) {
                    try {
                        const date = new Date(dateString);
                        return date.toLocaleString(undefined, {
                            weekday: 'short',
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            timeZoneName: 'short'
                        });
                    } catch (e) {
                        console.error("Error formatting date:", e);
                        return dateString || "Unknown date";
                    }
                }
            
                function preloadImage(url) {
                    if (preloadedImages.has(url)) {
                        return Promise.resolve(url);
                    }
                    
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = () => {
                            preloadedImages.set(url, img);
                            resolve(url);
                        };
                        img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
                        img.src = url;
                    });
                }
            
                async function loadMapLayers() {
                    if (!radarImage) {
                        console.error("Radar container elements not found. Aborting map layer loading.");
                        return;
                    }
                    
                    showLoading(true);
                    
                    try {
                        
                        const container = document.querySelector('.radar-container');
                        if (container) {
                            container.style.backgroundColor = '#99ccff';
                        }
                        
                        const bgUrl = `/map-proxy/${RADAR_ID}.background.png`;
                        const topoUrl = `/map-proxy/${RADAR_ID}.topography.png`;
                        const locUrl = `/map-proxy/${RADAR_ID}.locations.png`;

                        const safeLoadImage = async (url, element, name) => {
                            if (!element) {
                                console.error(`${name} element not found.`);
                                return false;
                            }

                            try {
                                await preloadImage(url);
                                element.src = url;
                                return true;
                            } catch (err) {
                                console.error(`Failed to preload ${name}:`, err);
                                return false;
                            }
                        };

                        const results = await Promise.allSettled([
                            safeLoadImage(bgUrl, backgroundLayer, 'Background'),
                            safeLoadImage(topoUrl, topographyLayer, 'Topography'),
                            safeLoadImage(locUrl, locationsLayer, 'Locations')
                        ]);
                        
                        const backgroundLoaded = results[0].status === 'fulfilled' && results[0].value;
                        
                        if (backgroundLoaded) {
                            mapLayersLoaded = true;
                        } else {
                            showError('Failed to load essential map layers. Using simplified display.');
                        }
                        
                    } catch (error) {
                        console.error('Error loading map layers:', error);
                        showError('Failed to load map layers. Using simplified display.');
                    } finally {
                        showLoading(false);
                    }
                }
            
                async function fetchRadarData() {
                    try {
                        showLoading(true);
                        hideError();
                        
                        const response = await fetch(`/api/radar/${RADAR_ID}`);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch radar data: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.images || data.images.length === 0) {
                            throw new Error('No radar images available');
                        }
                        
                        radarImages = data.images;
                        currentFrame = 0;
                        
                        if (lastUpdate) {
                            lastUpdate.textContent = `Last updated: ${formatDate(data.lastUpdated)}`;
                        }
                        
                        preloadAllImages();
                        
                        updateRadarImage(0);
                        enableControls(true);
                        
                    } catch (error) {
                        console.error('Error loading radar data:', error);
                        showError(error.message);
                        enableControls(false);
                    } finally {
                        showLoading(false);
                    }
                }
                
                async function preloadAllImages() {
                  if (!radarImages || radarImages.length === 0) return;
                  
                  const preloadPromises = radarImages.map(image => 
                    new Promise((resolve, reject) => {
                      const img = new Image();
                      img.onload = () => {
                        preloadedImages.set(image.url, img);
                        resolve(image.url);
                      };
                      img.onerror = () => {
                        resolve(null);
                      };
                      img.src = image.url;
                    })
                  );
                  
                  try {
                    await Promise.all(preloadPromises);
                    return true;
                  } catch (err) {
                    console.error('Error during image preloading:', err);
                    return false;
                  }
                }
            
                function updateRadarImage(frameIndex) {
                    if (window.radarGlobalState.isRefreshing) {
                        return;
                    }

                    const timeSinceRefresh = Date.now() - window.radarGlobalState.lastRefreshTime;
                    if (window.radarGlobalState.lastRefreshTime > 0 && timeSinceRefresh < ANIMATION_LOCKOUT_MS) {
                        return;
                    }

                    if (!radarImages || radarImages.length === 0 || !radarImage) return;

                    if (frameIndex >= 0 && frameIndex < radarImages.length) {
                        currentFrame = frameIndex;

                        if (radarImages[frameIndex] && radarImages[frameIndex].url) {
                            radarImage.src = radarImages[frameIndex].url;

                            if (timestamp) {
                                timestamp.textContent = formatDate(radarImages[frameIndex].timestamp);
                            }

                            if (frameCounter) {
                                frameCounter.textContent = `Frame ${currentFrame + 1} of ${radarImages.length}`;
                            }

                            if (progressBar) {
                                const progress = ((currentFrame + 1) / radarImages.length) * 100;
                                progressBar.style.width = `${progress}%`;
                            }
                        } else {
                            console.error(`Invalid image data at index ${frameIndex}`);
                        }
                    }
                }
            
                function playAnimation() {
                  if (!radarImages || radarImages.length === 0) return;
                  if (window.radarGlobalState.animationLock) return;
                  if (window.radarGlobalState.isRefreshing) return;

                  const timeSinceRefresh = Date.now() - window.radarGlobalState.lastRefreshTime;
                  if (window.radarGlobalState.lastRefreshTime > 0 && timeSinceRefresh < ANIMATION_LOCKOUT_MS) {
                      return;
                  }

                  pauseAnimation();

                  window.radarGlobalState.isPlaying = true;
                  window.radarGlobalState.animationLock = true;
                  if (btnPlay) btnPlay.disabled = true;
                  if (btnPause) btnPause.disabled = false;

                  window.radarGlobalState.currentAnimationSessionId++;
                  const mySessionId = window.radarGlobalState.currentAnimationSessionId;

                  const advanceFrame = () => {

                    if (mySessionId !== window.radarGlobalState.currentAnimationSessionId) {
                        return;
                    }

                    if (!window.radarGlobalState.isPlaying) {
                        return;
                    }
                    if (window.radarGlobalState.isRefreshing) {
                        return;
                    }

                    const timeSinceRefresh = Date.now() - window.radarGlobalState.lastRefreshTime;
                    if (window.radarGlobalState.lastRefreshTime > 0 && timeSinceRefresh < ANIMATION_LOCKOUT_MS) {
                        return;
                    }

                    currentFrame = (currentFrame + 1) % radarImages.length;
                    updateRadarImage(currentFrame);

                    window.radarGlobalState.animationInterval = setTimeout(advanceFrame, animationDelay);
                    window.radarGlobalState.allTimeoutIds.add(window.radarGlobalState.animationInterval);
                  };

                  advanceFrame();
                }
            
                function pauseAnimation() {
                  window.radarGlobalState.isPlaying = false;
                  window.radarGlobalState.animationLock = false;
                  if (btnPlay) btnPlay.disabled = false;
                  if (btnPause) btnPause.disabled = true;

                  if (window.radarGlobalState.animationInterval) {
                    clearTimeout(window.radarGlobalState.animationInterval);
                    window.radarGlobalState.animationInterval = null;
                  }
                  if (animationRequestId) {
                    cancelAnimationFrame(animationRequestId);
                    animationRequestId = null;
                  }

                  window.radarGlobalState.allTimeoutIds.forEach(id => clearTimeout(id));
                  window.radarGlobalState.allTimeoutIds.clear();
                }
            
                function prevFrame() {
                    if (!radarImages || radarImages.length === 0) return;
                    
                    pauseAnimation();
                    currentFrame = (currentFrame - 1 + radarImages.length) % radarImages.length;
                    updateRadarImage(currentFrame);
                }
            
                function nextFrame() {
                    if (!radarImages || radarImages.length === 0) return;
                    
                    pauseAnimation();
                    currentFrame = (currentFrame + 1) % radarImages.length;
                    updateRadarImage(currentFrame);
                }
                
                function firstFrame() {
                    if (!radarImages || radarImages.length === 0) return;
                    
                    pauseAnimation();
                    currentFrame = 0;
                    updateRadarImage(currentFrame);
                }
                
                function lastFrame() {
                    if (!radarImages || radarImages.length === 0) return;
                    
                    pauseAnimation();
                    currentFrame = radarImages.length - 1;
                    updateRadarImage(currentFrame);
                }
            
                function showLoading(show) {
                    if (loading) {
                        loading.style.display = show ? 'flex' : 'none';
                    }
                }
            
                function showError(message) {
                    if (errorElement) {
                        errorElement.textContent = message;
                        errorElement.style.display = 'block';
                    }
                }
            
                function hideError() {
                    if (errorElement) {
                        errorElement.style.display = 'none';
                    }
                }
            
                function enableControls(enable) {
                    const safeDisable = (button, isDisabled) => {
                        if (button) button.disabled = isDisabled;
                    };

                    safeDisable(btnPlay, !enable || window.radarGlobalState.isPlaying);
                    safeDisable(btnPause, !enable || !window.radarGlobalState.isPlaying);
                    safeDisable(btnPrev, !enable);
                    safeDisable(btnNext, !enable);
                    safeDisable(btnFirst, !enable);
                    safeDisable(btnLast, !enable);

                    if (speedSlider) speedSlider.disabled = !enable;
                }
            
                function updateLayerVisibility() {
                    if (topographyLayer && topographyToggle) {
                        topographyLayer.style.display = topographyToggle.checked ? 'block' : 'none';
                    }

                    if (locationsLayer && locationsToggle) {
                        locationsLayer.style.display = locationsToggle.checked ? 'block' : 'none';
                    }
                }
                
                async function checkBOMConnectivity() {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);

                        const response = await fetch('http://www.bom.gov.au/', {
                            method: 'HEAD',
                            mode: 'no-cors',
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        return true;
                    } catch (error) {
                        console.warn('BOM connectivity check failed:', error.message);
                        return false;
                    }
                }

                async function refreshData() {

                    window.radarGlobalState.currentAnimationSessionId++;

                    const oldRadarImages = radarImages;
                    radarImages = [];
                    currentFrame = 0;
                    window.radarGlobalState.isRefreshing = true;

                    window.radarGlobalState.lastRefreshTime = Date.now();

                    const BLANK_IMAGE = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

                    if (radarImage) {
                        radarImage.src = BLANK_IMAGE;
                    }
                    if (timestamp) timestamp.textContent = 'Stopping animation...';
                    if (frameCounter) frameCounter.textContent = '';
                    if (progressBar) progressBar.style.width = '0%';

                    if (window.radarGlobalState.forceClearInterval) clearInterval(window.radarGlobalState.forceClearInterval);
                    window.radarGlobalState.forceClearInterval = setInterval(() => {
                        if (radarImage && window.radarGlobalState.isRefreshing) {
                            radarImage.src = BLANK_IMAGE;
                        }
                    }, 50);

                    pauseAnimation();
                    window.radarGlobalState.animationLock = false;
                    window.radarGlobalState.isPlaying = false;

                    window.radarGlobalState.allTimeoutIds.forEach(id => clearTimeout(id));
                    window.radarGlobalState.allTimeoutIds.clear();
                    if (window.radarGlobalState.animationInterval) {
                        clearTimeout(window.radarGlobalState.animationInterval);
                        window.radarGlobalState.animationInterval = null;
                    }
                    setTimeout(() => {
                        window.radarGlobalState.allTimeoutIds.forEach(id => clearTimeout(id));
                        window.radarGlobalState.allTimeoutIds.clear();
                        if (window.radarGlobalState.animationInterval) {
                            clearTimeout(window.radarGlobalState.animationInterval);
                            window.radarGlobalState.animationInterval = null;
                        }
                    }, 0);

                    enableControls(false);

                    if (timestamp) timestamp.textContent = 'Checking connection...';

                    const isConnected = await checkBOMConnectivity();

                    if (!isConnected) {
                        if (window.radarGlobalState.forceClearInterval) {
                            clearInterval(window.radarGlobalState.forceClearInterval);
                            window.radarGlobalState.forceClearInterval = null;
                        }
                        radarImages = oldRadarImages;
                        window.radarGlobalState.isRefreshing = false;
                        showError('No internet connection. Keeping current data.');
                        if (timestamp && radarImages.length > 0) {
                            timestamp.textContent = formatDate(radarImages[currentFrame].timestamp) + ' (Offline)';
                        }
                        enableControls(true);
                        return;
                    }

                    preloadedImages.clear();

                    if (timestamp) timestamp.textContent = 'Refreshing data...';

                    await fetchRadarData();

                    const safetyDelay = Math.max(animationDelay * 2, 1000);
                    setTimeout(() => {

                        window.radarGlobalState.currentAnimationSessionId++;

                        window.radarGlobalState.isPlaying = false;
                        window.radarGlobalState.animationLock = false;

                        window.radarGlobalState.allTimeoutIds.forEach(id => clearTimeout(id));
                        window.radarGlobalState.allTimeoutIds.clear();
                        if (window.radarGlobalState.animationInterval) {
                            clearTimeout(window.radarGlobalState.animationInterval);
                            window.radarGlobalState.animationInterval = null;
                        }

                        if (window.radarGlobalState.forceClearInterval) {
                            clearInterval(window.radarGlobalState.forceClearInterval);
                            window.radarGlobalState.forceClearInterval = null;
                        }

                        window.radarGlobalState.isRefreshing = false;

                        const remainingLockout = ANIMATION_LOCKOUT_MS - (Date.now() - window.radarGlobalState.lastRefreshTime);
                        if (remainingLockout > 0) {
                            setTimeout(() => {
                                if (radarImages && radarImages.length > 0 && !window.radarGlobalState.isPlaying) {
                                    updateRadarImage(0);
                                }
                            }, remainingLockout + 100);
                        } else {
                            if (radarImages && radarImages.length > 0 && !window.radarGlobalState.isPlaying) {
                                updateRadarImage(0);
                            }
                        }
                    }, safetyDelay);
                }

                window.refreshData = refreshData;

                function setupEventListeners() {
                    if (btnPlay) btnPlay.addEventListener('click', playAnimation);
                    if (btnPause) btnPause.addEventListener('click', pauseAnimation);
                    if (btnPrev) btnPrev.addEventListener('click', prevFrame);
                    if (btnNext) btnNext.addEventListener('click', nextFrame);
                    if (btnFirst) btnFirst.addEventListener('click', firstFrame);
                    if (btnLast) btnLast.addEventListener('click', lastFrame);
                    if (refreshBtn) refreshBtn.addEventListener('click', refreshData);
                    
                    document.addEventListener('keydown', function(e) {
                        const radarTab = document.getElementById('content-radar');
                        if (!radarTab || !radarTab.classList.contains('active')) return;
                        
                        if (!radarImages || radarImages.length === 0) return;
                        
                        switch(e.key) {
                            case ' ':
                                if (window.radarGlobalState.isPlaying) {
                                    pauseAnimation();
                                } else {
                                    playAnimation();
                                }
                                break;
                            case 'ArrowLeft':
                                prevFrame();
                                break;
                            case 'ArrowRight':
                                nextFrame();
                                break;
                            case 'Home':
                                firstFrame();
                                break;
                            case 'End':
                                lastFrame();
                                break;
                        }
                    });
                    
                    if (speedSlider) {
                        speedSlider.addEventListener('input', function() {
                            const speed = parseInt(this.value);
                            animationDelay = 1100 - (speed * 100);

                            if (speedValue) {
                                speedValue.textContent = `${animationDelay}ms`;
                            }

                            if (window.radarGlobalState.isPlaying) {
                                pauseAnimation();
                                playAnimation();
                            }
                        });
                    }
                    
                    if (topographyToggle) {
                        topographyToggle.addEventListener('change', updateLayerVisibility);
                    }
                    
                    if (locationsToggle) {
                        locationsToggle.addEventListener('change', updateLayerVisibility);
                    }

                    if (radarImage) {
                        radarImage.addEventListener('error', function(e) {
                            if (this.src && this.src !== 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7') {
                                console.error(`Failed to load radar image: ${this.src}`);
                                showError('Failed to load radar image. Using cached version if available.');
                            }
                        });
                    }
                }
            
                function initialize() {
                    if (!radarImage) {
                        console.error("Radar elements not found. Cannot initialize radar.");
                        return;
                    }
                    
                    setupEventListeners();
                    
                    loadMapLayers().then(() => {
                        fetchRadarData();
                        
                        updateLayerVisibility();
                    }).catch(err => {
                        console.error("Error initializing radar:", err);
                        showError("Failed to initialize radar. Try refreshing the page.");
                    });
                }
                
                function handleTabChange() {
                    const tabButtons = document.querySelectorAll('.tab-button');
                    
                    if (!tabButtons || tabButtons.length === 0) {
                        initialize();
                        return;
                    }
                    
                    tabButtons.forEach(button => {
                        if (button) {
                            button.addEventListener('click', function() {
                                if (this.id === 'tab-radar' && !mapLayersLoaded) {
                                    initialize();
                                }
                            });
                        }
                    });
                    
                    const radarTab = document.getElementById('tab-radar');
                    const radarContent = document.getElementById('content-radar');
                    
                    if (radarTab && radarContent && radarContent.classList.contains('active')) {
                        initialize();
                    }
                }
                
                handleTabChange();
                
                if (document.getElementById('content-radar')) {
                    setInterval(() => {
                        const radarContent = document.getElementById('content-radar');
                        if (radarContent && radarContent.classList.contains('active')) {
                            refreshData();
                        }
                    }, 5 * 60 * 1000);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    if (document.getElementById('content-radar')) {
                        if (window.radarGlobalState && window.radarGlobalState.radarInitialized) {
                            if (window.refreshData) {
                                window.refreshData();
                            }
                        } else {
                            initializeRadar();
                        }
                    }
                });
            } else {
                if (document.getElementById('content-radar')) {
                    if (window.radarGlobalState && window.radarGlobalState.radarInitialized) {
                        if (window.refreshData) {
                            window.refreshData();
                        }
                    } else {
                        initializeRadar();
                    }
                }
            }
            
            const cycloneImg = new Image();
            cycloneImg.onload = function() {
                cycloneStatusValue.textContent = 'Online';
                cycloneStatusValue.className = 'status-value online';
            };
            cycloneImg.onerror = function() {
                cycloneStatusValue.textContent = 'Offline';
                cycloneStatusValue.className = 'status-value offline';
            };
            cycloneImg.src = 'http://www.bom.gov.au/fwo/IDQ65001.png?' + new Date().getTime();
            
            if (floodMapInitialized) {
                floodMapStatusValue.textContent = 'Online';
                floodMapStatusValue.className = 'status-value online';
            } else {
                floodMapStatusValue.textContent = 'Initializing...';
                floodMapStatusValue.className = 'status-value unknown';
            }
        }

        function updateRefreshInterval() {
            const interval = parseInt(refreshIntervalSelect.value);
            
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            refreshTimer = setInterval(fetchFloodData, interval);
            
            const minutes = interval / 60000;
            showNotification(`Data will refresh every ${minutes} ${minutes === 1 ? 'minute' : 'minutes'}`, 'info');
        }

        async function fetchFloodData() {
            showLoading(true);
            
            const previousLismoreLevel = currentLismoreLevel;
            
            try {
                const response = await fetch(PROXY_URL);
                
                if (!response.ok) {
                    throw new Error(`Proxy server error: ${response.status}`);
                }
                
                const jsonData = await response.json();
                
                if (jsonData.success && jsonData.data && jsonData.data.length > 0) {
                    floodData = jsonData.data;
                    
                    lastFetchTime = new Date();
                    lastUpdateTime.textContent = lastFetchTime.toLocaleTimeString('en-AU') + ' (live data)';
                    
                    showNotification('Live flood data updated successfully', 'success');
                } else {
                    throw new Error('No flood data returned from proxy');
                }
                
                cacheFloodData();
                
                renderFloodData();
                
                updateStatistics();
                
                const levelChanged = (
                    previousLismoreLevel !== null && 
                    currentLismoreLevel !== null && 
                    Math.abs(previousLismoreLevel - currentLismoreLevel) > 0.1
                );
                
                if (levelChanged && userSelectedFloodHeight === null) {
                    showNotification(`Flood level has changed to ${currentLismoreLevel.toFixed(2)}m. Map updated.`, 'info');
                }
                
                updateFloodMapWithCurrentLevelRespectingUserChoice();
                
            } catch (error) {
                console.error('Error fetching flood data:', error);
                
                showNotification('Error fetching live data. Using cached data if available.', 'error');
                
                if (floodData.length === 0) {
                    const loaded = loadCachedData();
                    if (!loaded) {
                        showNotification('CRITICAL: No flood data available. Please contact emergency services.', 'error');
                    }
                }
            } finally {
                showLoading(false);
            }
        }

        function renderFloodData() {
            if (!floodData || floodData.length === 0) {
                floodDataBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No data available</td></tr>';
                return;
            }
            
            const uniqueLocations = {};
            floodData.forEach(item => {
                if (!uniqueLocations[item.location] || 
                    new Date(item.time) > new Date(uniqueLocations[item.location].time)) {
                    uniqueLocations[item.location] = item;
                }
            });
            
            const uniqueData = Object.values(uniqueLocations);

            const groupedData = {};

            uniqueData.forEach(item => {
                let riverSystem = 'Other';
                
                if (item.location.includes('Wilsons')) {
                    riverSystem = 'Wilsons River';
                } else if (item.location.includes('Richmond')) {
                    riverSystem = 'Richmond River';
                } else if (item.location.includes('Tweed')) {
                    riverSystem = 'Tweed River';
                } else if (item.location.includes('Brunswick')) {
                    riverSystem = 'Brunswick River';
                } else if (item.location.includes('Clarence')) {
                    riverSystem = 'Clarence River';
                } else if (item.location.includes('Evans')) {
                    riverSystem = 'Evans River';
                } else if (item.location.includes('Leycester')) {
                    riverSystem = 'Wilsons River Tributaries';
                } else if (item.location.includes('Terania') || 
                          item.location.includes('Coopers') || 
                          item.location.includes('Goolmangar') ||
                          item.location.includes('Mulgum') ||
                          item.location.includes('Back Ck')) {
                    riverSystem = 'Wilsons River Tributaries';
                } else if (item.location.includes('Lismore') ||
                          item.location.includes('Browns Ck')) {
                    riverSystem = 'Wilsons River';
                }
                
                if (!groupedData[riverSystem]) {
                    groupedData[riverSystem] = [];
                }
                
                groupedData[riverSystem].push(item);
            });
            
            const sortedRiverSystems = Object.keys(groupedData).sort((a, b) => {
                if (a.includes('Wilsons') && !b.includes('Wilsons')) return -1;
                if (!a.includes('Wilsons') && b.includes('Wilsons')) return 1;
                return a.localeCompare(b);
            });
            
            let html = '';
            
            sortedRiverSystems.forEach(riverSystem => {
                html += `
                    <tr class="river-system-header">
                        <td colspan="5">${riverSystem}</td>
                    </tr>
                `;
                
                groupedData[riverSystem].forEach(item => {
                    let rowClass = '';
                    if (item.floodCategory === 'Minor') {
                        rowClass = 'minor-flood';
                    } else if (item.floodCategory === 'Moderate') {
                        rowClass = 'moderate-flood';
                    } else if (item.floodCategory === 'Major') {
                        rowClass = 'major-flood';
                    }
                    
                    let statusClass = '';
                    if (item.status === 'rising') {
                        statusClass = 'rising';
                    } else if (item.status === 'falling') {
                        statusClass = 'falling';
                    } else if (item.status === 'steady') {
                        statusClass = 'steady';
                    }
                    
                    html += `
                      <tr class="${rowClass}" style="cursor: pointer;" title="Click to view height history">
                        <td>${item.location}</td>
                        <td>${item.time}</td>
                        <td>${item.waterLevel !== null ? item.waterLevel.toFixed(2) + 'm' : 'N/A'}</td>
                        <td class="${statusClass}">${item.status}</td>
                        <td>${item.floodCategory === 'N/A' ? '-' : item.floodCategory}</td>
                      </tr>
                    `;
                });
            });
            
            if (html === '') {
                html = '<tr><td colspan="5" style="text-align: center;">No locations found</td></tr>';
            }
            
            floodDataBody.innerHTML = html;
        }

            function updateStatistics() {
                if (!floodData || floodData.length === 0) return;
                
                const lismoreData = floodData.find(item => 
                    item.location === 'Wilsons R at Lismore (mAHD)') ||
                    floodData.find(item => 
                    item.location.toLowerCase().includes('lismore'));
                
                if (lismoreData) {
                    currentLismoreLevel = lismoreData.waterLevel;
                    
                    lismoreLevel.textContent = lismoreData.waterLevel !== null 
                        ? lismoreData.waterLevel.toFixed(2) + 'm' 
                        : 'N/A';
                    
                    lismoreStatus.textContent = capitalizeFirstLetter(lismoreData.status);
                    
                    lismoreStatus.className = 'stat-footer';
                    if (lismoreData.status === 'rising') {
                        lismoreStatus.classList.add('rising');
                    } else if (lismoreData.status === 'falling') {
                        lismoreStatus.classList.add('falling');
                    } else if (lismoreData.status === 'steady') {
                        lismoreStatus.classList.add('steady');
                    }
                    
                    const LEVEE_APPROACH_WARNING = 9.5;
                    const statsPanel = document.getElementById('stats-container').closest('.panel');
                    
                    const existingWarning = document.getElementById('levee-warning-panel');
                    if (existingWarning) {
                        existingWarning.remove();
                    }
                    
                    if (lismoreData.waterLevel >= LEVEE_APPROACH_WARNING) {
                        const warningPanel = document.createElement('div');
                        warningPanel.id = 'levee-warning-panel';
                        warningPanel.className = 'panel-alert';
                        warningPanel.style.backgroundColor = '#fff3cd';
                        warningPanel.style.color = '#856404';
                        warningPanel.style.border = '1px solid #ffeeba';
                        warningPanel.style.marginBottom = '1rem';
                        warningPanel.style.display = 'flex';
                        warningPanel.style.alignItems = 'center';
                        warningPanel.style.gap = '0.5rem';
                        warningPanel.style.padding = '0.75rem 1rem';
                        warningPanel.style.borderRadius = 'var(--border-radius)';
                        warningPanel.style.fontWeight = '500';
                        
                        warningPanel.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <span>WARNING: Wilsons River at Lismore (${lismoreData.waterLevel.toFixed(2)}m) is approaching levee protection height (10.6m)</span>
                        `;
                        
                        statsPanel.parentNode.insertBefore(warningPanel, statsPanel);
                    }
                }
                
                let highest = null;
                floodData.forEach(item => {
                        if (item.waterLevel !== null && (highest === null || item.waterLevel > highest.waterLevel)) {
                            highest = item;
                        }
                    });
                
                if (highest) {
                    highestReading.textContent = highest.waterLevel.toFixed(2) + 'm';
                    highestLocation.textContent = highest.location;
                }
                
                const rising = floodData.filter(item => item.status === 'rising').length;
                const falling = floodData.filter(item => item.status === 'falling').length;
                
                risingCount.textContent = rising;
                fallingCount.textContent = falling;
                
                if (rising > 0 && rising > falling) {
                    risingCount.parentElement.classList.add('critical');
                } else {
                    risingCount.parentElement.classList.remove('critical');
                }
            }

            function forceWarningPanel() {
                const statsPanel = document.getElementById('stats-container').closest('.panel');
                
                const existingWarning = document.getElementById('levee-warning-panel');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                const warningPanel = document.createElement('div');
                warningPanel.id = 'levee-warning-panel';
                warningPanel.className = 'panel-alert';
                warningPanel.style.backgroundColor = '#fff3cd';
                warningPanel.style.color = '#856404';
                warningPanel.style.border = '1px solid #ffeeba';
                warningPanel.style.marginBottom = '1rem';
                warningPanel.style.display = 'flex';
                warningPanel.style.alignItems = 'center';
                warningPanel.style.gap = '0.5rem';
                warningPanel.style.padding = '0.75rem 1rem';
                warningPanel.style.borderRadius = '8px';
                warningPanel.style.fontWeight = '500';
                
                warningPanel.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span>WARNING: Wilsons River at Lismore (9.50m) is approaching levee protection height (10.6m)</span>
                `;
                
                if (statsPanel && statsPanel.parentNode) {
                    statsPanel.parentNode.insertBefore(warningPanel, statsPanel);
                } else {
                    console.error('Could not find stats panel to add warning');
                }
            }

        function cacheFloodData() {
            try {
                const cacheData = {
                    timestamp: new Date().getTime(),
                    data: floodData
                };
                
                localStorage.setItem('lismoreFloodData', JSON.stringify(cacheData));
            } catch (error) {
                console.error('Error caching flood data:', error);
            }
        }

        function loadCachedData() {
            try {
                const cachedData = localStorage.getItem('lismoreFloodData');
                
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    
                    if (parsed && parsed.data && parsed.data.length > 0) {
                        floodData = parsed.data;
                        
                        lastFetchTime = new Date(parsed.timestamp);
                        lastUpdateTime.textContent = lastFetchTime.toLocaleTimeString('en-AU') + ' (cached)';
                        
                        renderFloodData();
                        
                        updateStatistics();
                        
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error loading cached data:', error);
                return false;
            }
        }
        
        function createStatusElement(id, label) {
            const statusPanel = document.querySelector('.status-panel');

            const statusItem = document.createElement('div');
            statusItem.id = id;
            statusItem.className = 'status-item';
            
            const statusLabel = document.createElement('span');
            statusLabel.className = 'status-label';
            statusLabel.textContent = label + ':';
            
            const statusValue = document.createElement('span');
            statusValue.id = id + '-value';
            statusValue.className = 'status-value';
            statusValue.textContent = 'Checking...';
            
            statusItem.appendChild(statusLabel);
            statusItem.appendChild(statusValue);
            
            const statusActions = document.querySelector('.status-actions');
            statusPanel.insertBefore(statusItem, statusActions);
            
            return statusValue;
        }

        function showLoading(show) {
            if (show) {
                loadingOverlay.style.display = 'flex';
            } else {
                loadingOverlay.style.display = 'none';
            }
        }

        function showNotification(message, type) {
            notificationMessage.textContent = message;
            
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(webcamRefreshTimer);
            } else {
                refreshWebcam();
                webcamRefreshTimer = setInterval(refreshWebcam, WEBCAM_REFRESH_INTERVAL);
            }
        });

        webcamImage.addEventListener('error', function() {
            webcamError.style.display = 'block';
        });

        webcamImage.addEventListener('load', function() {
            webcamError.style.display = 'none';
        });
        
            function refreshRadar() {
                if (window.initializeRadar) {
                    const refreshBtn = document.getElementById('refresh-btn');
                    if (refreshBtn) {
                        refreshBtn.click();
                    }
                    return;
                }
            
                const radarImage = document.getElementById('radar-image');
                const radarError = document.getElementById('radar-error');
                const radarTimestamp = document.getElementById('radar-timestamp');
                
                if (radarImage) {
                    const timestamp = new Date().getTime();
                    radarImage.src = `http://www.bom.gov.au/radar/IDR282.gif?t=${timestamp}`;
                    
                    if (radarTimestamp) {
                        radarTimestamp.textContent = `Last updated: ${new Date().toLocaleTimeString('en-AU')}`;
                    }
                    
                    if (radarError) {
                        radarImage.onerror = function() {
                            radarError.style.display = 'block';
                        };
                        
                        radarImg.onload = function() {
                            if (document.getElementById('radar-error')) {
                                document.getElementById('radar-error').style.display = 'none';
                            }
                        };
                    }
                }
            }
        
        function checkRadarStatus() {
            const radarImg = document.getElementById('radar-image');
            const radarError = document.getElementById('radar-error');
            const radarStatusValue = document.getElementById('radar-status-value');
            
            const radarTestImg = new Image();
            
            radarTestImg.onload = function() {
                if (radarStatusValue) radarStatusValue.textContent = 'Online';
                if (radarStatusValue) radarStatusValue.className = 'status-value online';
                if (radarError) radarError.style.display = 'none';
            };
            
            radarTestImg.onerror = function() {
                if (radarStatusValue) radarStatusValue.textContent = 'Offline';
                if (radarStatusValue) radarStatusValue.className = 'status-value offline';
                if (radarError) radarError.style.display = 'block';
            };
            
            radarTestImg.src = `http://www.bom.gov.au/radar/IDR282.gif?t=${new Date().getTime()}`;
        }

        function refreshCycloneMap() {
            const cycloneImage = document.getElementById('cyclone-image');
            const cycloneError = document.getElementById('cyclone-error');
            const cycloneTimestamp = document.getElementById('cyclone-timestamp');
            
            const timestamp = new Date().getTime();
            cycloneImage.src = `http://www.bom.gov.au/fwo/IDQ65001.png?t=${timestamp}`;
            
            cycloneTimestamp.textContent = `Last updated: ${new Date().toLocaleTimeString('en-AU')}`;
            
            cycloneImage.onerror = function() {
                cycloneError.style.display = 'block';
            };
            
            cycloneImage.onload = function() {
                cycloneError.style.display = 'none';
            };
        }

        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showNotification('An error occurred. Please refresh the page if issues persist.', 'error');
        });

        function markTabUnavailable(tabId, reason) {
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.classList.add('tab-unavailable');
                tab.setAttribute('data-unavailable-reason', reason);
                
                tab.classList.remove('active');
                
                const contentId = tabId.replace('tab-', 'content-');
                const contentElement = document.getElementById(contentId);
                if (contentElement) {
                    contentElement.classList.remove('active');
                }
                
                if (tab.classList.contains('active')) {
                    const firstAvailableTab = document.querySelector('.tab-button:not(.tab-unavailable)');
                    if (firstAvailableTab) {
                        firstAvailableTab.classList.add('active');
                        const firstAvailableContent = document.getElementById(
                            firstAvailableTab.id.replace('tab-', 'content-')
                        );
                        if (firstAvailableContent) {
                            firstAvailableContent.classList.add('active');
                        }
                    }
                }
                
                tab.onclick = function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const reason = this.getAttribute('data-unavailable-reason');
                    showUnavailableContentPopup(tabId, reason);
                    
                    return false;
                };
            }
        }
        
        function markTabAvailable(tabId) {
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.classList.remove('tab-unavailable');
                tab.removeAttribute('data-unavailable-reason');
                
                tab.onclick = function() {
                    activateTab(tabId);
                };
            }
        }
        
        function showUnavailableContentPopup(tabId, reason) {
            let title, message, linkText, linkUrl;
            
            if (tabId === 'tab-cyclone') {
                title = "Cyclone Information Unavailable";
                message = "No current warnings and bulletins for cyclones in this area.";
                linkText = "View BOM cyclone information";
                linkUrl = "http://www.bom.gov.au/cyclone/";
            } 
            else if (tabId === 'tab-radar') {
                title = "Radar Image Unavailable";
                message = "The latest radar image could not be fetched.";
                linkText = "View latest forecast for Lismore";
                linkUrl = "https://beta.bom.gov.au/poi-location/australia/new-south-wales/northern-rivers/nsw_pt079-lismore";
            }
            else {
                title = "Content Unavailable";
                message = "This content is currently unavailable. Please try again later.";
            }
            
            const notificationElement = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            let messageHTML = `
                <div style="text-align:left;">
                    <strong>${title}</strong><br>
                    ${message}
                    ${linkUrl ? `<br><br><a href="${linkUrl}" target="_blank" style="color:white;text-decoration:underline;">${linkText}</a>` : ''}
                </div>
            `;
            
            notificationMessage.innerHTML = messageHTML;
            notification.className = 'notification info';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 7000);
        }
        
        function checkCycloneAvailability() {
            const cycloneImg = new Image();
            
            cycloneImg.onload = function() {
                markTabAvailable('tab-cyclone');
                document.getElementById('cyclone-error').style.display = 'none';
            };
            
            cycloneImg.onerror = function() {
                markTabUnavailable('tab-cyclone', 'No current cyclone warnings or bulletins for this area.');
                document.getElementById('cyclone-error').style.display = 'block';
                document.getElementById('cyclone-error').textContent = 'No current cyclone warnings for this area';
            };
            
            cycloneImg.src = `http://www.bom.gov.au/fwo/IDQ65001.png?t=${new Date().getTime()}`;
        }
        
        function fixRadarStatusCheck() {
            const originalCheckRadarAvailability = window.checkRadarAvailability || function(){};
            
            window.checkRadarAvailability = function() {
                const safelySetStyle = (element, property, value) => {
                    if (element && element.style) {
                        element.style[property] = value;
                    }
                };
                
                const radarErrorElements = [
                    document.getElementById('radar-error'),
                    document.querySelector('.radar-error')
                ];
                
                const radarImg = new Image();
                
                radarImg.onload = function() {
                    radarErrorElements.forEach(el => safelySetStyle(el, 'display', 'none'));
                    
                    const statusElement = document.getElementById('radar-status-value');
                    if (statusElement) {
                        statusElement.textContent = 'Online';
                        statusElement.className = 'status-value online';
                    }
                    
                    if (typeof originalCheckRadarAvailability === 'function') {
                        try {
                            originalCheckRadarAvailability();
                        } catch (e) {
                            console.error('Error in original radar status check:', e);
                        }
                    }
                };
                
                radarImg.onerror = function() {
                    radarErrorElements.forEach(el => safelySetStyle(el, 'display', 'block'));
                    
                    const statusElement = document.getElementById('radar-status-value');
                    if (statusElement) {
                        statusElement.textContent = 'Offline';
                        statusElement.className = 'status-value offline';
                    }
                };
                
                radarImg.src = `http://www.bom.gov.au/radar/IDR282.gif?t=${new Date().getTime()}`;
            };
            
            const originalRefreshRadar = window.refreshRadar || function(){};
            
            window.refreshRadar = function() {
                const radarImage = document.getElementById('radar-image');
                const radarError = document.getElementById('radar-error');
                const radarTimestamp = document.getElementById('radar-timestamp');
                
                if (radarImage) {
                    const timestamp = new Date().getTime();
                    radarImage.src = `http://www.bom.gov.au/radar/IDR282.gif?t=${timestamp}`;
                    
                    if (radarTimestamp) {
                        radarTimestamp.textContent = `Last updated: ${new Date().toLocaleTimeString('en-AU')}`;
                    }
                    
                    if (radarError) {
                        radarImage.onerror = function() {
                            if (radarError && radarError.style) {
                                radarError.style.display = 'block';
                            }
                        };
                        
                        radarImage.onload = function() {
                            if (radarError && radarError.style) {
                                radarError.style.display = 'none';
                            }
                        };
                    }
                }
                
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    try {
                        refreshBtn.click();
                    } catch (e) {
                        console.error('Error clicking refresh button:', e);
                    }
                }
            };
            
            console.log('Radar functions fixed for compatibility');
        }
        
        document.addEventListener('DOMContentLoaded', fixRadarStatusCheck);
        
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            fixRadarStatusCheck();
        }
        
        function addUnavailableTabStyles() {
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                .tab-button.tab-unavailable {
                    opacity: 0.6;
                    cursor: not-allowed !important;
                    position: relative;
                    pointer-events: all !important; /* Ensure our custom handler still works */
                }
                
                .tab-button.tab-unavailable:hover {
                    background-color: transparent !important;
                    color: var(--gray-700) !important;
                    transform: none !important;
                }
                
                .tab-button.tab-unavailable::after {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-image: linear-gradient(45deg, rgba(180, 180, 180, 0.1) 25%, transparent 25%, transparent 50%, rgba(180, 180, 180, 0.1) 50%, rgba(180, 180, 180, 0.1) 75%, transparent 75%, transparent);
                    background-size: 8px 8px;
                    pointer-events: none;
                    border-radius: var(--border-radius);
                }
                
                .tab-button.tab-unavailable svg {
                    opacity: 0.7;
                }
            `;
            document.head.appendChild(styleElement);
        }
        
        function initializeAvailabilityChecks() {
            addUnavailableTabStyles();
            
            checkCycloneAvailability();
            checkRadarStatus();
            
            setInterval(checkCycloneAvailability, 60000);
            setInterval(checkRadarAvailability, 60000);
        }
        
        function activateTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            const contentId = tabId.replace('tab-', 'content-');
            document.getElementById(contentId).classList.add('active');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeAvailabilityChecks();
        });

        function isPointInPolygon(point, polygon) {
            
            const x = point[0];
            const y = point[1];
            
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];
                
                const intersect = ((yi > y) !== (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            
            return inside;
        }

        function addLeveeToMap(floodMap, floodHeight) {
            const reversedCoordinates = leveeCoordinates.map(coord => [coord[1], coord[0]]);
        
            let leveeColor = '#2196F3';
            let leveeWeight = 3;
            
            if (floodHeight >= LEVEE_HEIGHT) {
                leveeColor = '#e74c3c';
                leveeWeight = 4;
            } else if (floodHeight >= LEVEE_WARNING_THRESHOLD) {
                leveeColor = '#f39c12';
                leveeWeight = 4;
            }
            
            const leveeLine = L.polyline(reversedCoordinates, {
                color: leveeColor,
                weight: leveeWeight,
                opacity: 0.8
            }).addTo(floodMap);
            
            if (floodHeight >= LEVEE_HEIGHT) {
                leveeLine.bindPopup("<strong>Levee Wall - BREACHED</strong><br>Flood height exceeds levee protection height of 10.6m");
            } else if (floodHeight >= LEVEE_WARNING_THRESHOLD) {
                leveeLine.bindPopup("<strong>Levee Wall - WARNING</strong><br>Flood height is approaching levee protection height of 10.6m");
            } else {
                leveeLine.bindPopup("<strong>Levee Wall</strong><br>Protects area until water level reaches 10.6m");
            }
            
            return leveeLine;
        }
        
        function processFloodData(data) {
            floodProperties = data.map(row => {
                const floorLevel = parseFloat(row['Floor Level']);
                const gateLevel = parseFloat(row['Gate Level']);
                const roadLevel = parseFloat(row['Road Centre']);
                
                return {
                    address: row['Street Details'],
                    floorLevel: floorLevel,
                    gateLevel: gateLevel,
                    roadLevel: roadLevel,
                    coordinates: [parseFloat(row['Latitude']), parseFloat(row['Longitude'])]
                };
            }).filter(property => {
                return !isNaN(property.floorLevel) && 
                       !isNaN(property.gateLevel) && 
                       !isNaN(property.roadLevel) &&
                       !isNaN(property.coordinates[0]) &&
                       !isNaN(property.coordinates[1]);
            });
        }

        function getFloodStatusWithLevee(floodHeight, property) {
            const isInLeveeArea = isPointInPolygon([property.coordinates[1], property.coordinates[0]], leveeAreaCoordinates);
            
            const floorAffected = property.floorLevel <= floodHeight;
            const gateAffected = property.gateLevel <= floodHeight;
            const roadAffected = property.roadLevel <= floodHeight;
            
            let wouldBeAffected = false;
            let normalStatus = 'safe';
            
            if (floorAffected) {
                wouldBeAffected = true;
                normalStatus = 'critical';
            } else if (gateAffected) {
                wouldBeAffected = true;
                normalStatus = 'warning';
            } else if (roadAffected) {
                wouldBeAffected = true;
                normalStatus = 'alert';
            }
            
            if (isInLeveeArea && wouldBeAffected && floodHeight <= LEVEE_HEIGHT) {
                property.leveeProtected = true;
                property.normalStatus = normalStatus;
                return 'safe';
            }
            
            property.leveeProtected = false;
            return normalStatus;
        }
        
            function createPopupContent(property, floodHeight, status) {
                const addressParts = property.address.match(/^(\d+)\s+(.+?)\s+([A-Z\s]+)$/);
                let streetNumber = '', streetName = '';
                
                if (addressParts) {
                    streetNumber = addressParts[1];
                    streetName = addressParts[2];
                } else {
                    streetName = property.address;
                }
                
                const floorAffected = property.floorLevel <= floodHeight;
                const gateAffected = property.gateLevel <= floodHeight;
                const roadAffected = property.roadLevel <= floodHeight;
                
                let content = `
                    <div style="font-family:'Inter',sans-serif;line-height:1.5;">
                        <div style="font-size:16px;font-weight:600;margin-bottom:12px;border-bottom:1px solid #eee;padding-bottom:8px;">
                            ${streetNumber} ${streetName}
                        </div>
                        
                        <div style="margin-bottom:8px;">
                            <div style="font-weight:500;margin-bottom:4px;">Status: <span style="color:${getStatusColor(status)};font-weight:600;">${getStatusText(status)}</span></div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 8px;margin-bottom:10px;">
                            <div style="font-weight:500;">Floor Level:</div>
                            <div>${property.floorLevel.toFixed(2)}m ${floorAffected && !property.leveeProtected ? '<span style="color:#e74c3c;font-weight:bold;padding:1px 4px;background-color:rgba(231,76,60,0.1);border-radius:3px;">AFFECTED</span>' : ''}</div>
                            
                            <div style="font-weight:500;">Gate Level:</div>
                            <div>${property.gateLevel.toFixed(2)}m ${gateAffected && !property.leveeProtected ? '<span style="color:#f39c12;font-weight:bold;padding:1px 4px;background-color:rgba(243,156,18,0.1);border-radius:3px;">AFFECTED</span>' : ''}</div>
                            
                            <div style="font-weight:500;">Road Level:</div>
                            <div>${property.roadLevel.toFixed(2)}m ${roadAffected && !property.leveeProtected ? '<span style="color:#f1c40f;font-weight:bold;padding:1px 4px;background-color:rgba(241,196,15,0.1);border-radius:3px;">AFFECTED</span>' : ''}</div>
                        </div>
                    </div>
                `;
                
                if (property.leveeProtected) {
                    content += `
                    <div style="background-color:#e3f2fd;padding:10px;margin:6px 0 0 0;border-radius:6px;border:1px solid #bbdefb;display:flex;align-items:center;justify-content:center;">
                        <span style="color:#1976d2;margin-right:8px;display:flex;align-items:center;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                        </span>
                        <span style="color:#1976d2;font-weight:600;font-size:14px;">Protected by Levee</span>
                    </div>`;
                }
                
                return content;
            }
        
        function addLeveeLegendItem() {
            const legendElement = document.querySelector('.flood-map-legend');
            if (!legendElement) return;
            
            if (!document.querySelector('.legend-item-levee')) {
                const leveeLegendItem = document.createElement('div');
                leveeLegendItem.className = 'legend-item legend-item-levee';
                leveeLegendItem.innerHTML = `
                    <div class="legend-color" style="background-color: #2196F3;"></div>
                    <div class="legend-label">Levee Protected</div>
                `;
                legendElement.appendChild(leveeLegendItem);
            }
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'critical': return 'Critical - Floor Level Affected';
                case 'warning': return 'Warning - Gate Level Affected';
                case 'alert': return 'Alert - Road Level Affected';
                case 'safe': return 'Safe - Not Affected';
                default: return 'Unknown';
            }
        }
        
        function getStatusColor(status) {
            const COLORS = {
                critical: '#e74c3c',
                warning: '#f39c12',
                alert: '#f1c40f',
                safe: '#2ecc71'
            };
            
            return COLORS[status] || COLORS.safe;
        }
        
        function getHeatIntensity(status) {
            switch (status) {
                case 'critical': return 1.0;
                case 'warning': return 0.7;
                case 'alert': return 0.4;
                case 'safe': return 0.1;
                default: return 0;
            }
        }
        
        function updateFloodMapWithCurrentLevelRespectingUserChoice() {
            if (floodMapInitialized) {
                const floodHeightSlider = document.getElementById('flood-height-slider');
                const floodHeightDisplay = document.getElementById('flood-height-display');
                
                if (userSelectedFloodHeight !== null) {
                    floodHeightSlider.value = userSelectedFloodHeight;
                    floodHeightDisplay.textContent = userSelectedFloodHeight.toFixed(1) + 'm';
                    updateFloodVisualizationWithLevee(userSelectedFloodHeight);
                } else if (currentLismoreLevel !== null) {
                    floodHeightSlider.value = currentLismoreLevel;
                    floodHeightDisplay.textContent = currentLismoreLevel.toFixed(1) + 'm';
                    updateFloodVisualizationWithLevee(currentLismoreLevel);
                }
            }
        }
        
        function updateFloodVisualizationWithLevee(floodHeight) {
            if (!floodMapInitialized || floodProperties.length === 0) {
                return;
            }
        
            const floodLoadingOverlay = document.getElementById('flood-loading-overlay');
            floodLoadingOverlay.style.display = 'flex';
            
            floodMarkers.clearLayers();
            if (floodHeatmapLayer) {
                floodMap.removeLayer(floodHeatmapLayer);
            }
            
            if (leveeLine) {
                floodMap.removeLayer(leveeLine);
            }
            
            leveeLine = addLeveeToMap(floodMap, floodHeight);
            
            const stats = {
                critical: 0,
                warning: 0,
                alert: 0,
                safe: 0,
                leveeProtected: 0
            };
            
            document.getElementById('flood-stats-height').textContent = floodHeight.toFixed(1) + 'm';
            
            const heatmapData = [];
            
            floodProperties.forEach((property, index) => {
                const status = getFloodStatusWithLevee(floodHeight, property);
                
                stats[status]++;
                if (property.leveeProtected) {
                    stats.leveeProtected++;
                }
                
                let color;
                if (property.leveeProtected) {
                    color = '#2196F3';
                } else {
                    color = getStatusColor(status);
                }
                
                const marker = L.circleMarker(property.coordinates, {
                    color: 'white',
                    weight: 1.5,
                    fillColor: color,
                    fillOpacity: 0.8,
                    radius: 8
                });

                const popupContent = createPopupContent(property, floodHeight, status);

                marker.bindPopup(popupContent, {
                    autoPan: false,
                    closeButton: true,
                    maxWidth: 300
                });

                // Add click handler for auto-zoom to property
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);

                    // Check if clicking on the currently open marker
                    const isCurrentlyOpen = currentlyOpenFloodMarker === marker && marker.isPopupOpen();

                    // If clicking the same marker that's already open, just keep it open
                    if (isCurrentlyOpen) {
                        return;
                    }

                    // Update the currently open marker
                    currentlyOpenFloodMarker = marker;

                    // Create a small bounds around the property to use with padding
                    const offset = 0.0005; // Small offset to create bounds
                    const bounds = L.latLngBounds(
                        [property.coordinates[0] - offset, property.coordinates[1] - offset],
                        [property.coordinates[0] + offset, property.coordinates[1] + offset]
                    );

                    // Fly to bounds with padding to ensure popup stays in viewport
                    // Top padding: 250px ensures popup doesn't exceed top of view
                    // Bottom padding: 80px ensures marker doesn't exceed bottom of view
                    floodMap.flyToBounds(bounds, {
                        paddingTopLeft: [50, 250],
                        paddingBottomRight: [50, 80],
                        maxZoom: 16,
                        duration: 0.6,
                        easeLinearity: 0.25
                    });

                    // Open popup after animation completes
                    setTimeout(() => {
                        marker.openPopup();
                    }, 650);
                });

                floodMarkers.addLayer(marker);
                
                let intensity;
                
                if (property.leveeProtected) {
                    intensity = 0.05;
                } else {
                    intensity = getHeatIntensity(status);
                }
                
                heatmapData.push([
                    property.coordinates[0], 
                    property.coordinates[1], 
                    intensity
                ]);
            });
        
            floodHeatmapLayer = L.heatLayer(heatmapData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {
                    0.05: '#2196F3',
                    0.1: getStatusColor('safe'),
                    0.4: getStatusColor('alert'),
                    0.7: getStatusColor('warning'),
                    1.0: getStatusColor('critical')
                }
            });
            
            document.getElementById('flood-stat-total').textContent = floodProperties.length;
            document.getElementById('flood-stat-critical').textContent = stats.critical;
            document.getElementById('flood-stat-warning').textContent = stats.warning;
            document.getElementById('flood-stat-alert').textContent = stats.alert;
            document.getElementById('flood-stat-safe').textContent = stats.safe;
            
            let leveeStatElement = document.getElementById('flood-stat-levee');
            if (!leveeStatElement && stats.leveeProtected > 0) {
                const floodStatGrid = document.querySelector('.flood-stat-grid');
                const leveeStatItem = document.createElement('div');
                leveeStatItem.className = 'flood-stat-item';
                leveeStatItem.innerHTML = `
                    <div class="flood-stat-label">Levee Protected</div>
                    <div class="flood-stat-value" id="flood-stat-levee">0 <span class="category-badge" style="background-color:rgba(33, 150, 243, 0.1);color:#2196F3;">Levee</span></div>
                `;
                floodStatGrid.appendChild(leveeStatItem);
                leveeStatElement = document.getElementById('flood-stat-levee');
            }
            
            if (leveeStatElement) {
                if (stats.leveeProtected > 0) {
                    leveeStatElement.innerHTML = stats.leveeProtected + ' <span class="category-badge" style="background-color:rgba(33, 150, 243, 0.1);color:#2196F3;">Levee</span>';
                    leveeStatElement.parentElement.style.display = 'block';
                } else {
                    leveeStatElement.parentElement.style.display = 'none';
                }
            }
            
            if (document.getElementById('flood-show-heatmap').checked) {
                floodMap.removeLayer(floodMarkers);
                floodMap.addLayer(floodHeatmapLayer);
            } else {
                floodMap.addLayer(floodMarkers);
            }
            
            floodLoadingOverlay.style.display = 'none';
        }
        
        function initFloodMapWithLevee() {
            if (floodMapInitialized) {
                return;
            }

            const floodHeightSlider = document.getElementById('flood-height-slider');
            const floodHeightDisplay = document.getElementById('flood-height-display');
            const useCurrentLevelBtn = document.getElementById('use-current-level');
            const floodLoadingOverlay = document.getElementById('flood-loading-overlay');
            const floodShowMarkers = document.getElementById('flood-show-markers');
            const floodShowHeatmap = document.getElementById('flood-show-heatmap');
            const refreshFloodMapBtn = document.getElementById('refresh-floodmap');

            floodMap = L.map('flood-map').setView([-28.8167, 153.2833], 14);

            floodMapInitialized = true;

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(floodMap);

            floodMarkers = L.layerGroup().addTo(floodMap);

            // Close popup on user-initiated map interaction (scroll, drag, zoom)
            floodMap.getContainer().addEventListener('wheel', () => {
                currentlyOpenFloodMarker = null;
                floodMap.closePopup();
            }, { passive: true });

            floodMap.on('zoomstart', () => {
                currentlyOpenFloodMarker = null;
                floodMap.closePopup();
            });

            floodMap.on('dragstart', () => {
                currentlyOpenFloodMarker = null;
                floodMap.closePopup();
            });

            floodMap.on('movestart', () => {
                currentlyOpenFloodMarker = null;
                floodMap.closePopup();
            });

            addLeveeLegendItem();
            
            const LISMORE_BOUNDS = [
                [-28.8767, 153.2233],
                [-28.7767, 153.3433]
            ];
            
            floodMap.setMaxBounds(LISMORE_BOUNDS);
            floodMap.options.minZoom = 12;
            floodMap.options.maxZoom = 18;
            
            if (embeddedCSVData && embeddedCSVData.length > 0) {
                processFloodData(embeddedCSVData);
            } else {
            }
            
            let initialHeight;
            if (currentLismoreLevel !== null) {
                initialHeight = currentLismoreLevel;
                floodHeightSlider.value = initialHeight;
                floodHeightDisplay.textContent = initialHeight.toFixed(1) + 'm';
            } else {
                initialHeight = parseFloat(floodHeightSlider.value);
            }
            
            userSelectedFloodHeight = null;
            
            updateFloodVisualizationWithLevee(initialHeight);
            
            floodHeightSlider.addEventListener('input', function() {
                const height = parseFloat(this.value);
                userSelectedFloodHeight = height;
                floodHeightDisplay.textContent = height.toFixed(1) + 'm';
                updateFloodVisualizationWithLevee(height);
            });
            
            useCurrentLevelBtn.addEventListener('click', function() {
                if (currentLismoreLevel !== null) {
                    userSelectedFloodHeight = currentLismoreLevel;
                    floodHeightSlider.value = currentLismoreLevel;
                    floodHeightDisplay.textContent = currentLismoreLevel.toFixed(1) + 'm';
                    updateFloodVisualizationWithLevee(currentLismoreLevel);
                    showNotification('Map updated to current Wilsons River level: ' + currentLismoreLevel.toFixed(2) + 'm', 'info');
                } else {
                    showNotification('Current river level data not available', 'error');
                }
            });
            
            floodShowMarkers.addEventListener('change', function() {
                if (this.checked) {
                    floodMap.removeLayer(floodHeatmapLayer);
                    floodMap.addLayer(floodMarkers);
                }
            });
            
            floodShowHeatmap.addEventListener('change', function() {
                if (this.checked && floodHeatmapLayer) {
                    floodMap.removeLayer(floodMarkers);
                    floodMap.addLayer(floodHeatmapLayer);
                }
            });
            
            refreshFloodMapBtn.addEventListener('click', function() {
                const height = parseFloat(floodHeightSlider.value);
                userSelectedFloodHeight = null;
                if (currentLismoreLevel !== null) {
                    floodHeightSlider.value = currentLismoreLevel;
                    floodHeightDisplay.textContent = currentLismoreLevel.toFixed(1) + 'm';
                    updateFloodVisualizationWithLevee(currentLismoreLevel);
                    showNotification('Map updated to current Wilsons River level: ' + currentLismoreLevel.toFixed(2) + 'm', 'info');
                } else {
                    updateFloodVisualizationWithLevee(height);
                }
            });
            
            floodMapInitialized = true;
            
            floodLoadingOverlay.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            let riverChartInstance = null;
            const riverHeightModal = document.getElementById('river-height-modal');
            const riverName = document.getElementById('river-name');
            const riverChartCanvas = document.getElementById('river-chart');
            const riverLoading = document.getElementById('river-loading');
            const riverDataError = document.getElementById('river-data-error');
            const closeRiverChart = document.getElementById('close-river-chart');
            const modalCloseBtn = document.querySelector('.modal-close');
        
            function openRiverHeightModal(location) {
                let cleanLocation = location;
                
                if (location.includes("Wilsons") && location.includes("Lismore")) {
                    cleanLocation = "Wilsons R at Lismore (mAHD)";
                } else {
                    cleanLocation = location.split(/\s+\d/)[0];
                    cleanLocation = cleanLocation.replace(/\s*\<span.*\<\/span\>/i, "");
                    cleanLocation = cleanLocation.trim();
                }
                
                riverName.textContent = cleanLocation + ' - Height History';
                
                riverLoading.style.display = 'flex';
                riverDataError.style.display = 'none';
                riverHeightModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                fetchRiverHeightData(location, cleanLocation);
            }
        
            function closeRiverHeightModal() {
                riverHeightModal.style.display = 'none';
                document.body.style.overflow = '';
                
                if (riverChartInstance) {
                    riverChartInstance.destroy();
                    riverChartInstance = null;
                }
            }
        
            closeRiverChart.addEventListener('click', closeRiverHeightModal);
            modalCloseBtn.addEventListener('click', closeRiverHeightModal);
            riverHeightModal.addEventListener('click', function(event) {
                if (event.target === riverHeightModal) {
                    closeRiverHeightModal();
                }
            });
        
            function handleRowClick(event) {
                const row = event.target.closest('tr');
                
                if (!row || row.closest('thead') || row.classList.contains('river-system-header')) {
                    return;
                }
                
                const location = row.cells[0].textContent.trim();
                
                openRiverHeightModal(location);
            }
        
            document.getElementById('flood-data-body').addEventListener('click', handleRowClick);
        
        async function fetchRiverHeightData(location) {
          try {
            const riverLoading = document.getElementById('river-loading');
            const riverDataError = document.getElementById('river-data-error');
            riverLoading.style.display = 'flex';
            riverDataError.style.display = 'none';
            
            const cleanLocation = location.replace(/\s*\<span.*\<\/span\>/i, "");
            
            const encodedLocation = encodeURIComponent(cleanLocation);
            
            const response = await fetch(`${BASE_URL}/river-data?location=${encodedLocation}`);
            
            if (!response.ok) {
              let errorDetail = `HTTP error! status: ${response.status}`;
              try {
                const errorData = await response.json();
                if (errorData && errorData.message) {
                  errorDetail += ` - ${errorData.message}`;
                }
              } catch (e) {
              }
              
              throw new Error(errorDetail);
            }
            
            const data = await response.json();
            
            if (data.success && data.data && data.data.length > 0) {
              
              renderRiverHeightChart(data.data, cleanLocation);
            } else {
              showRiverDataError("No data available for this location");
            }
          } catch (error) {
            console.error('Error fetching river height data:', error);
            showRiverDataError(`Could not load river height data: ${error.message}`);
          }
        }
        
        function renderRiverHeightChart(heightData, location) {
          let processedData = heightData;
          if (heightData.length > 100) {
            processedData = reduceDataPoints(heightData, 50);
          }
          
          const dates = processedData.map(item => item.time);
          const heights = processedData.map(item => item.height);
          
          const ctx = document.getElementById('river-chart').getContext('2d');
          
          if (riverChartInstance) {
            riverChartInstance.destroy();
          }
          
          const gradient = ctx.createLinearGradient(0, 0, 0, 400);
          gradient.addColorStop(0, 'rgba(30, 136, 229, 0.2)');
          gradient.addColorStop(1, 'rgba(30, 136, 229, 0)');
          
          riverChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: dates,
              datasets: [{
                label: 'Water Level (m)',
                data: heights,
                borderColor: 'rgba(30, 136, 229, 1)',
                backgroundColor: gradient,
                fill: true,
                tension: 0.5,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: 'white',
                pointBorderColor: 'rgba(30, 136, 229, 1)',
                pointBorderWidth: 2,
                pointHitRadius: 20,
                borderWidth: 3,
                cubicInterpolationMode: 'monotone',
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: false,
                },
                legend: {
                  display: false
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  backgroundColor: 'rgba(0, 0, 0, 0.7)',
                  titleColor: 'rgba(255, 255, 255, 1)',
                  bodyColor: 'rgba(255, 255, 255, 1)',
                  borderColor: 'rgba(30, 136, 229, 0.5)',
                  borderWidth: 1,
                  padding: 10,
                  cornerRadius: 4,
                  displayColors: false,
                  callbacks: {
                    title: function(tooltipItems) {
                      return tooltipItems[0].label;
                    },
                    label: function(context) {
                      return `Water Level: ${context.parsed.y.toFixed(2)}m`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false,
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                    autoSkip: true,
                    maxTicksLimit: 8
                  }
                },
                y: {
                  beginAtZero: true,
                  suggestedMin: 0,
                  suggestedMax: function() {
                    const maxHeight = Math.max(...heights);
                    return maxHeight * 1.2;
                  }(),
                  grid: {
                    color: 'rgba(0, 0, 0, 0.03)',
                  },
                  ticks: {
                    callback: function(value) {
                      return value.toFixed(2) + 'm';
                    }
                  }
                }
              },
              interaction: {
                mode: 'index',
                intersect: false
              },
              elements: {
                line: {
                  tension: 0.5
                }
              },
              hover: {
                mode: 'index',
                intersect: false
              }
            }
          });
          
          document.getElementById('river-loading').style.display = 'none';
          
          const dataRange = document.getElementById('river-data-range');
          if (dataRange && dates.length > 0) {
            const firstDate = dates[0];
            const lastDate = dates[dates.length - 1];
            dataRange.textContent = `Data from ${firstDate} to ${lastDate}`;
          }
        }
        
        function reduceDataPoints(data, targetPoints) {
          const originalLength = data.length;
          
          if (originalLength <= targetPoints) {
            return data;
          }
          
          const result = [];
          result.push(data[0]);
          
          const step = Math.floor(originalLength / (targetPoints - 2));
          
          for (let i = step; i < originalLength - step; i += step) {
            result.push(data[i]);
          }
          
          result.push(data[originalLength - 1]);
          
          return result;
        }
        });
        </script>

    <div id="river-height-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="river-name">River Height History</h2>
                <button class="modal-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="river-loading" class="river-loading">
                    <div class="spinner"></div>
                    <p>Loading river height data...</p>
                </div>
                <div class="river-chart-container">
                    <canvas id="river-chart"></canvas>
                </div>
                <div id="river-data-error" class="river-data-error" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <p>Could not load river height data. Please try again later.</p>
                </div>
            </div>
            <div class="modal-footer">
                <span id="river-data-range">Last 4 days of readings</span>
                <button id="close-river-chart" class="button">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
